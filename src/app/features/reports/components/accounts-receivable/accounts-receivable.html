<div class="report-container">
  <app-page-header
    title="Cuentas por Cobrar"
    icon="fa-solid fa-file-invoice-dollar"
    [breadcrumbs]="[
      { label: 'Reportes', route: '/reports' },
      { label: 'Cuentas por Cobrar' }
    ]"
  />

  <!-- KPI Cards -->
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-icon primary">
        <i class="fa-solid fa-file-invoice"></i>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Facturas Pendientes</span>
        <span class="kpi-value">{{ summary().totalInvoices }}</span>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon warning">
        <i class="fa-solid fa-coins"></i>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Total por Cobrar</span>
        <span class="kpi-value">{{ formatCurrency(summary().totalBalance) }}</span>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon danger">
        <i class="fa-solid fa-exclamation-triangle"></i>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Vencidas</span>
        <span class="kpi-value">{{ summary().overdueInvoices }}</span>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon danger">
        <i class="fa-solid fa-clock"></i>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Monto Vencido</span>
        <span class="kpi-value">{{ formatCurrency(summary().totalOverdue) }}</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <i class="fa-solid fa-search"></i>
      <input
        type="text"
        placeholder="Buscar por paciente o factura..."
        (input)="onSearchInput($any($event.target).value)"
      />
    </div>
    <div class="filter-chips">
      <button
        class="chip"
        [class.active]="minDaysOverdue() === null"
        (click)="applyDaysFilter(null)"
      >
        Todas
      </button>
      <button
        class="chip"
        [class.active]="minDaysOverdue() === 1"
        (click)="applyDaysFilter(1)"
      >
        Vencidas
      </button>
      <button
        class="chip"
        [class.active]="minDaysOverdue() === 30"
        (click)="applyDaysFilter(30)"
      >
        +30 días
      </button>
      <button
        class="chip"
        [class.active]="minDaysOverdue() === 60"
        (click)="applyDaysFilter(60)"
      >
        +60 días
      </button>
      <button
        class="chip"
        [class.active]="minDaysOverdue() === 90"
        (click)="applyDaysFilter(90)"
      >
        +90 días
      </button>
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="loading-state">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Cargando reporte...</p>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="error-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="loadData()">Reintentar</button>
    </div>
  }

  <!-- Table -->
  @if (!loading() && !error() && filteredItems().length > 0) {
    <div class="table-card">
      <div class="table-responsive">
        <table class="report-table">
          <thead>
            <tr>
              <th>Paciente</th>
              <th>Factura</th>
              <th>Emisión</th>
              <th>Total</th>
              <th>Pagado</th>
              <th>Saldo</th>
              <th>Días Atraso</th>
              <th>Último Pago</th>
            </tr>
          </thead>
          <tbody>
            @for (item of filteredItems(); track item.invoiceId) {
              <tr>
                <td>
                  <a class="link-cell" (click)="goToPatient(item.patientId)">
                    {{ item.patientName }}
                  </a>
                </td>
                <td>
                  <a class="link-cell" (click)="goToInvoice(item.invoiceId)">
                    {{ item.invoiceNumber || '—' }}
                  </a>
                </td>
                <td>{{ formatDate(item.issuedAt) }}</td>
                <td>{{ formatCurrency(item.totalAmount) }}</td>
                <td>{{ formatCurrency(item.paidAmount) }}</td>
                <td class="balance-cell">{{ formatCurrency(item.balance) }}</td>
                <td>
                  @if (item.daysOverdue > 0) {
                    <span class="days-badge" [class]="getOverdueClass(item.daysOverdue)">
                      {{ item.daysOverdue }} días
                    </span>
                  } @else {
                    <span class="days-ok">Al corriente</span>
                  }
                </td>
                <td>{{ formatDate(item.lastPaymentDate) }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- Empty -->
  @if (!loading() && !error() && filteredItems().length === 0) {
    <div class="empty-state">
      <i class="fa-solid fa-check-circle"></i>
      <h3>Sin cuentas por cobrar</h3>
      <p>No se encontraron facturas pendientes con los filtros seleccionados.</p>
    </div>
  }
</div>
