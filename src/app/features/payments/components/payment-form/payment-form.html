<div class="page-container container-medium">
  <app-page-header
    title="Registrar Pago"
    subtitle="Registra un pago a una factura pendiente"
    icon="fa-money-bill-wave"
    [showBackButton]="true"
    backRoute="/payments"
    [breadcrumbs]="breadcrumbItems">
    <div actions class="header-form-actions">
      <button type="button" class="btn btn-outline" routerLink="/payments">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-outline btn-success" (click)="onSubmit()" [disabled]="form.invalid || saving()">
        @if (saving()) {
          <span class="btn-spinner"></span>
          Guardando...
        } @else {
          <i class="fa-solid fa-plus"></i>
          Registrar Pago
        }
      </button>
    </div>
  </app-page-header>

  <div class="content-card">
    <form [formGroup]="form" class="standard-form">

      <!-- Invoice Selection -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-file-invoice section-icon"></i>
          Factura
        </h3>

        <div class="form-group">
          <label class="form-label">Factura pendiente <span class="required">*</span></label>
          @if (loadingInvoices()) {
            <div class="loading-small">
              <div class="spinner spinner-small"></div>
              <span>Cargando facturas...</span>
            </div>
          } @else {
            <select
              class="form-input"
              formControlName="invoiceId"
              (change)="onInvoiceChange($any($event.target).value)"
              [class.input-error]="isFieldInvalid('invoiceId')"
            >
              <option value="">Seleccionar factura pendiente...</option>
              @for (inv of invoices(); track inv.id) {
                <option [value]="inv.id">
                  {{ inv.patientName }}
                  @if (inv.serie && inv.folio) { — {{ inv.serie }}-{{ inv.folio }} }
                  — Saldo: {{ formatCurrency(inv.balance) }}
                </option>
              }
            </select>
            @if (isFieldInvalid('invoiceId')) {
              <span class="error-message">{{ getFieldError('invoiceId') }}</span>
            }
          }
        </div>

        <!-- Selected Invoice Info -->
        @if (selectedInvoice(); as inv) {
          <div class="invoice-summary">
            <div class="summary-item">
              <span class="summary-label">Paciente</span>
              <span class="summary-value">{{ inv.patientName }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Total Factura</span>
              <span class="summary-value">{{ formatCurrency(inv.totalAmount) }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Pagado</span>
              <span class="summary-value success">{{ formatCurrency(inv.paidAmount) }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Saldo Pendiente</span>
              <span class="summary-value warning">{{ formatCurrency(inv.balance) }}</span>
            </div>
          </div>
        }
      </div>

      <!-- Payment Details -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-credit-card section-icon"></i>
          Detalles del Pago
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Monto <span class="required">*</span></label>
            <input
              type="number"
              class="form-input"
              formControlName="amount"
              step="0.01"
              [class.input-error]="isFieldInvalid('amount')"
            />
            @if (isFieldInvalid('amount')) {
              <span class="error-message">{{ getFieldError('amount') }}</span>
            }
          </div>
          <div class="form-group">
            <label class="form-label">Fecha de Pago <span class="required">*</span></label>
            <input
              type="date"
              class="form-input"
              formControlName="paidAt"
              [class.input-error]="isFieldInvalid('paidAt')"
            />
            @if (isFieldInvalid('paidAt')) {
              <span class="error-message">{{ getFieldError('paidAt') }}</span>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Método de Pago <span class="required">*</span></label>
            <div class="method-options">
              @for (method of paymentMethods; track method) {
                <label class="method-option" [class.selected]="form.get('paymentMethod')?.value === method">
                  <input type="radio" formControlName="paymentMethod" [value]="method" />
                  <i [class]="'fa-solid ' + PAYMENT_METHOD_CONFIG[method].icon"
                     [style.color]="PAYMENT_METHOD_CONFIG[method].color"></i>
                  <span>{{ PAYMENT_METHOD_CONFIG[method].label }}</span>
                </label>
              }
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Referencia</label>
            <input
              type="text"
              class="form-input"
              formControlName="reference"
              placeholder="No. de transacción, cheque, etc."
            />
          </div>
        </div>
      </div>

    </form>
  </div>
</div>
