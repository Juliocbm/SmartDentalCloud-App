<div class="settings-container">
  <app-page-header
    title="Configuración"
    icon="fa-solid fa-gear"
    [showBackButton]="true"
    [breadcrumbs]="[{ label: 'Configuración' }]"
  >
    <div actions class="header-form-actions">
      @switch (activeTab()) {
        @case ('general') {
          <button class="btn btn-outline btn-success" [disabled]="saving() || !generalName().trim()" (click)="saveGeneral()">
            @if (saving()) {
              <span class="btn-spinner"></span>
              Guardando...
            } @else {
              <i class="fa-solid fa-floppy-disk"></i>
              Guardar Cambios
            }
          </button>
        }
        @case ('schedule') {
          <button class="btn btn-outline btn-success" [disabled]="scheduleEditor()?.saving() || !scheduleEditor()?.isFormValid()" (click)="scheduleEditor()?.save()">
            @if (scheduleEditor()?.saving()) {
              <span class="btn-spinner"></span>
              Guardando...
            } @else {
              <i class="fa-solid fa-floppy-disk"></i>
              Guardar Horario
            }
          </button>
        }
        @case ('dentist-schedule') {
          @if (dentistScheduleManager()?.selectedDentistId()) {
            <button class="btn btn-outline btn-success" [disabled]="dentistScheduleManager()?.editorRef()?.saving() || !dentistScheduleManager()?.editorRef()?.isFormValid()" (click)="dentistScheduleManager()?.editorRef()?.save()">
              @if (dentistScheduleManager()?.editorRef()?.saving()) {
                <span class="btn-spinner"></span>
                Guardando...
              } @else {
                <i class="fa-solid fa-floppy-disk"></i>
                Guardar Horario
              }
            </button>
          }
        }
        @case ('exceptions') {
          <button class="btn btn-outline btn-success" (click)="exceptionsManager()?.openCreateModal()">
            <i class="fa-solid fa-plus"></i>
            Nueva Excepción
          </button>
        }
        @case ('smtp') {
          <button class="btn btn-outline" [disabled]="smtpTesting() || !smtpHost().trim()" (click)="testSmtp()">
            @if (smtpTesting()) {
              <span class="btn-spinner"></span>
              Probando...
            } @else {
              <i class="fa-solid fa-plug"></i>
              Probar Conexión
            }
          </button>
          @if (smtpConfig()) {
            <button class="btn btn-outline btn-danger" [disabled]="saving()" (click)="deleteSmtp()">
              <i class="fa-solid fa-trash"></i>
              Eliminar Config
            </button>
          }
          <button class="btn btn-outline btn-success" [disabled]="saving() || !smtpHost().trim() || !smtpFromEmail().trim()" (click)="saveSmtp()">
            @if (saving()) {
              <span class="btn-spinner"></span>
              Guardando...
            } @else {
              <i class="fa-solid fa-floppy-disk"></i>
              Guardar SMTP
            }
          </button>
        }
        @case ('branding') {
          <button class="btn btn-outline btn-success" [disabled]="saving()" (click)="saveBranding()">
            @if (saving()) {
              <span class="btn-spinner"></span>
              Guardando...
            } @else {
              <i class="fa-solid fa-floppy-disk"></i>
              Guardar Branding
            }
          </button>
        }
        @case ('domain') {
          <button class="btn btn-outline btn-success" [disabled]="saving() || !domainCustom().trim()" (click)="saveDomain()">
            @if (saving()) {
              <span class="btn-spinner"></span>
              Guardando...
            } @else {
              <i class="fa-solid fa-floppy-disk"></i>
              Guardar Dominio
            }
          </button>
        }
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando configuración...</p>
    </div>
  } @else {
    <div class="settings-layout">
      <!-- Sidebar Tabs -->
      <nav class="settings-nav">
        @for (tab of tabs; track tab.key) {
          <button
            class="nav-item"
            [class.active]="activeTab() === tab.key"
            (click)="setTab(tab.key)"
          >
            <i [class]="'fa-solid ' + tab.icon"></i>
            <span>{{ tab.label }}</span>
          </button>
        }
      </nav>

      <!-- Content -->
      <div class="settings-content">

        <!-- General Tab -->
        @if (activeTab() === 'general') {
          <div class="settings-section">
            <div class="section-header">
              <h2>
                <i class="fa-solid fa-gear"></i>
                General
              </h2>
              <p class="section-description">Información básica del consultorio</p>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nombre del Consultorio <span class="required">*</span></label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="Mi Consultorio Dental"
                  [ngModel]="generalName()"
                  (ngModelChange)="generalName.set($event)"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Razón Social</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="Razón social para facturación"
                  [ngModel]="generalLegalName()"
                  (ngModelChange)="generalLegalName.set($event)"
                />
              </div>
              <div class="form-group">
                <label class="form-label">RFC</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="XAXX010101000"
                  [ngModel]="generalTaxId()"
                  (ngModelChange)="generalTaxId.set($event)"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Zona Horaria</label>
                <select
                  class="form-input"
                  [ngModel]="generalTimeZone()"
                  (ngModelChange)="generalTimeZone.set($event)"
                >
                  @for (tz of TIMEZONE_OPTIONS; track tz.value) {
                    <option [value]="tz.value">{{ tz.label }}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Idioma</label>
                <select
                  class="form-input"
                  [ngModel]="generalLanguage()"
                  (ngModelChange)="generalLanguage.set($event)"
                >
                  @for (lang of LANGUAGE_OPTIONS; track lang.value) {
                    <option [value]="lang.value">{{ lang.label }}</option>
                  }
                </select>
              </div>
            </div>
          </div>
        }

        <!-- Schedule Tab -->
        @if (activeTab() === 'schedule') {
          <div class="settings-section">
            <app-work-schedule-editor #scheduleEditor />
          </div>
        }

        <!-- Dentist Schedule Tab -->
        @if (activeTab() === 'dentist-schedule') {
          <div class="settings-section">
            <app-dentist-schedule-manager #dentistScheduleManager />
          </div>
        }

        <!-- Exceptions Tab -->
        @if (activeTab() === 'exceptions') {
          <div class="settings-section">
            <app-schedule-exceptions-manager #exceptionsManager />
          </div>
        }

        <!-- SMTP Tab -->
        @if (activeTab() === 'smtp') {
          <div class="settings-section">
            <div class="section-header">
              <h3 class="section-title">
                <i class="fa-solid fa-envelope"></i>
                Configuración de Correo (SMTP)
              </h3>
              <p class="section-description">Configura el servidor de correo para envío de notificaciones, recordatorios y facturas</p>
            </div>

            @if (smtpConfig(); as smtp) {
              <div class="smtp-status-card">
                <div class="status-indicator" [class.active]="smtp.isEnabled">
                  <i [class]="smtp.isEnabled ? 'fa-solid fa-check-circle' : 'fa-solid fa-times-circle'"></i>
                  {{ smtp.isEnabled ? 'SMTP Configurado' : 'SMTP Inactivo' }}
                </div>
                <div class="status-info">
                  <span><strong>Servidor:</strong> {{ smtp.smtpHost }}:{{ smtp.smtpPort }}</span>
                  <span><strong>Remitente:</strong> {{ smtp.fromEmail }}</span>
                  @if (smtp.lastTestedAt) {
                    <span><strong>Última prueba:</strong> {{ smtp.testStatus }}</span>
                  }
                </div>
              </div>
            }

            <div class="smtp-form-sections">
              <!-- Servidor -->
              <div class="smtp-form-section">
                <h4 class="smtp-section-title">
                  <i class="fa-solid fa-server"></i>
                  Servidor
                </h4>
                <div class="form-row smtp-server-row">
                  <div class="form-group">
                    <label class="form-label">Servidor SMTP <span class="required">*</span></label>
                    <input
                      type="text"
                      class="form-input"
                      placeholder="smtp.gmail.com"
                      [ngModel]="smtpHost()"
                      (ngModelChange)="smtpHost.set($event)"
                    />
                  </div>
                  <div class="form-group smtp-port">
                    <label class="form-label">Puerto <span class="required">*</span></label>
                    <input
                      type="number"
                      class="form-input"
                      [ngModel]="smtpPort()"
                      (ngModelChange)="smtpPort.set($event)"
                    />
                  </div>
                  <div class="form-group smtp-ssl">
                    <label class="form-label">&nbsp;</label>
                    <label class="toggle-label toggle-boxed">
                      <input
                        type="checkbox"
                        [ngModel]="smtpUseSsl()"
                        (ngModelChange)="smtpUseSsl.set($event)"
                      />
                      <span class="toggle-text">
                        <i class="fa-solid fa-lock"></i>
                        SSL/TLS
                      </span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Autenticación -->
              <div class="smtp-form-section">
                <h4 class="smtp-section-title">
                  <i class="fa-solid fa-key"></i>
                  Autenticación
                </h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Usuario <span class="required">*</span></label>
                    <input
                      type="text"
                      class="form-input"
                      placeholder="usuario@dominio.com"
                      [ngModel]="smtpUsername()"
                      (ngModelChange)="smtpUsername.set($event)"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Contraseña <span class="required">*</span></label>
                    <input
                      type="password"
                      class="form-input"
                      placeholder="Contraseña o App Password"
                      [ngModel]="smtpPassword()"
                      (ngModelChange)="smtpPassword.set($event)"
                    />
                  </div>
                </div>
              </div>

              <!-- Remitente -->
              <div class="smtp-form-section">
                <h4 class="smtp-section-title">
                  <i class="fa-solid fa-at"></i>
                  Remitente
                </h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Email Remitente <span class="required">*</span></label>
                    <input
                      type="email"
                      class="form-input"
                      placeholder="consultorio@dominio.com"
                      [ngModel]="smtpFromEmail()"
                      (ngModelChange)="smtpFromEmail.set($event)"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Nombre Remitente</label>
                    <input
                      type="text"
                      class="form-input"
                      placeholder="Consultorio Dental"
                      [ngModel]="smtpFromName()"
                      (ngModelChange)="smtpFromName.set($event)"
                    />
                  </div>
                </div>
              </div>
            </div>

            @if (smtpTestResult(); as result) {
              <div class="alert" [class.alert-success]="result.success" [class.alert-error]="!result.success">
                <i [class]="result.success ? 'fa-solid fa-check-circle' : 'fa-solid fa-exclamation-circle'"></i>
                {{ result.message }}
              </div>
            }

          </div>
        }

        <!-- Branding Tab -->
        @if (activeTab() === 'branding') {
          <div class="settings-section">
            <div class="section-header">
              <h3 class="section-title">
                <i class="fa-solid fa-palette"></i>
                Branding
              </h3>
              <p class="section-description">Personaliza la imagen de tu consultorio</p>
            </div>

            <div class="branding-card">
              <div class="branding-preview-area">
                <span class="branding-preview-label">Vista previa</span>
                @if (brandingLogoUrl()) {
                  <div class="logo-preview">
                    <img [src]="brandingLogoUrl()" alt="Logo del consultorio" />
                  </div>
                } @else {
                  <div class="logo-placeholder">
                    <i class="fa-solid fa-image"></i>
                    <span>Sin logo</span>
                  </div>
                }
              </div>

              <div class="branding-form-area">
                <div class="form-group">
                  <label class="form-label">URL del Logo</label>
                  <input
                    type="url"
                    class="form-input"
                    placeholder="https://ejemplo.com/mi-logo.png"
                    [ngModel]="brandingLogoUrl()"
                    (ngModelChange)="brandingLogoUrl.set($event)"
                  />
                  <span class="field-hint">
                    <i class="fa-solid fa-circle-info"></i>
                    PNG o SVG recomendado, tamaño máximo 200×60px
                  </span>
                </div>

                <div class="branding-tips">
                  <p><i class="fa-solid fa-check"></i> El logo aparecerá en facturas, recetas y correos</p>
                  <p><i class="fa-solid fa-check"></i> Usa un fondo transparente para mejores resultados</p>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Domain Tab -->
        @if (activeTab() === 'domain') {
          <div class="settings-section">
            <div class="section-header">
              <h2>
                <i class="fa-solid fa-globe"></i>
                Dominio Personalizado
              </h2>
              <p class="section-description">Configura un dominio propio para acceder al sistema</p>
            </div>

            @if (settings(); as s) {
              <div class="domain-info">
                <div class="domain-item">
                  <span class="domain-label">Subdominio actual</span>
                  <span class="domain-value">{{ s.subdomain }}.smartdentalcloud.com</span>
                </div>
                @if (s.customDomain) {
                  <div class="domain-item">
                    <span class="domain-label">Dominio personalizado</span>
                    <span class="domain-value active">{{ s.customDomain }}</span>
                  </div>
                }
              </div>
            }

            <div class="form-group">
              <label class="form-label">Dominio Personalizado</label>
              <input
                type="text"
                class="form-input"
                placeholder="app.miconsultorio.com"
                [ngModel]="domainCustom()"
                (ngModelChange)="domainCustom.set($event)"
              />
              <span class="field-hint">Configura un registro CNAME apuntando a tu subdominio antes de guardar</span>
            </div>

          </div>
        }
      </div>
    </div>
  }
</div>
