<div class="detail-container">
  <app-page-header
    [title]="'Cita Médica'"
    [subtitle]="appointmentSubtitle()"
    [icon]="'fa-calendar-check'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems">
    <div actions>
      <button class="btn btn-icon" (click)="showAuditModal.set(true)" title="Auditoría">
        <i class="fa-solid fa-clock-rotate-left"></i>
      </button>
      @if (canReschedule()) {
        <button (click)="onEdit()" class="btn btn-outline" [disabled]="actionLoading()">
          <i class="fa-solid fa-calendar-pen"></i>
          Reagendar
        </button>
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando cita...</p>
    </div>
  } @else if (error()) {
    <div class="empty-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h2>Error al cargar la cita</h2>
      <p>{{ error() }}</p>
      <button (click)="onBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </button>
    </div>
  } @else if (appointment(); as apt) {

    <!-- Header: Status + Date/Time + Action Buttons -->
    <div class="detail-header">
      <div class="header-content">
        <div class="title-section">
          <span class="status-badge" [ngClass]="getStatusConfig(apt.status).bgColor">
            <i class="fa-solid" [ngClass]="getStatusConfig(apt.status).icon"></i>
            {{ getStatusConfig(apt.status).label }}
          </span>
        </div>
        <div class="header-info">
          <div class="info-item">
            <i class="fa-solid fa-calendar"></i>
            <span class="label">Fecha:</span>
            <span class="value">{{ formatDate(apt.startAt) }}</span>
          </div>
          <div class="info-item">
            <i class="fa-solid fa-clock"></i>
            <span class="label">Hora:</span>
            <span class="value">{{ formatTime(apt.startAt) }} - {{ formatTime(apt.endAt) }}</span>
          </div>
          <div class="info-item">
            <i class="fa-solid fa-hourglass-half"></i>
            <span class="label">Duración:</span>
            <span class="value">{{ getDuration() }} minutos</span>
          </div>
          @if (locationsService.hasMultipleLocations() && apt.locationName) {
            <div class="info-item">
              <i class="fa-solid fa-location-dot"></i>
              <span class="label">Sucursal:</span>
              <span class="value">
                @if (apt.locationId) {
                  <a [routerLink]="['/settings/locations', apt.locationId]" class="link-primary">
                    {{ apt.locationName }}
                  </a>
                } @else {
                  {{ apt.locationName }}
                }
              </span>
            </div>
          }
        </div>
      </div>
      <div class="header-action-bar">
        @if (canConfirm()) {
          <button (click)="onConfirm()" class="btn btn-success" [disabled]="actionLoading()">
            <i class="fa-solid fa-check-circle"></i> Confirmar
          </button>
        }
        @if (canComplete()) {
          <button (click)="onComplete()" class="btn btn-primary" [disabled]="actionLoading()">
            <i class="fa-solid fa-check"></i> Completar
          </button>
        }
        @if (canMarkNoShow()) {
          <button (click)="onMarkNoShow()" class="btn btn-warning" [disabled]="actionLoading()">
            <i class="fa-solid fa-exclamation-triangle"></i> No Show
          </button>
        }
        @if (canCancel()) {
          <button (click)="onCancel()" class="btn btn-danger" [disabled]="actionLoading()">
            <i class="fa-solid fa-times-circle"></i> Cancelar
          </button>
        }
      </div>
    </div>

    <!-- Terminal status banner -->
    @if (apt.status === AppointmentStatus.Completed) {
      <div class="status-banner status-banner--success">
        <i class="fa-solid fa-check-circle"></i>
        <span>Esta cita ha sido completada</span>
      </div>
    }
    @if (apt.status === AppointmentStatus.Cancelled) {
      <div class="status-banner status-banner--error">
        <i class="fa-solid fa-ban"></i>
        <span>Esta cita ha sido cancelada</span>
      </div>
    }
    @if (apt.status === AppointmentStatus.NoShow) {
      <div class="status-banner status-banner--warning">
        <i class="fa-solid fa-user-slash"></i>
        <span>El paciente no se presentó a esta cita</span>
      </div>
    }

    <div class="detail-body">
      <!-- Patient & Doctor -->
      <div class="info-two-col">
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-user"></i>
            Paciente
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Nombre:</span>
              <span class="info-value">
                <a [routerLink]="['/patients', apt.patientId]" class="link-primary">
                  {{ apt.patientName }}
                </a>
              </span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>
            <i class="fa-solid fa-user-md"></i>
            Doctor
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Nombre:</span>
              <span class="info-value">
                @if (apt.userId) {
                  <a [routerLink]="['/users', apt.userId]" class="link-primary">
                    {{ apt.doctorName }}
                  </a>
                } @else {
                  {{ apt.doctorName || 'No asignado' }}
                }
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Appointment Details -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-notes-medical"></i>
          Detalles de la Cita
        </h3>
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Motivo:</span>
            <span class="info-value">{{ apt.reason || '—' }}</span>
          </div>
          @if (apt.notes) {
            <div class="info-row">
              <span class="info-label">Notas:</span>
              <span class="info-value notes-text">{{ apt.notes }}</span>
            </div>
          }
          @if (apt.cancellationReason) {
            <div class="info-row alert-row">
              <span class="info-label">Motivo de cancelación:</span>
              <span class="info-value">{{ apt.cancellationReason }}</span>
            </div>
          }
        </div>
      </div>

      <app-audit-info
        [visible]="showAuditModal()"
        [createdAt]="apt.createdAt"
        (closed)="showAuditModal.set(false)"
      />

      <!-- Consultation Note Section (only for Completed appointments) -->
      @if (apt.status === AppointmentStatus.Completed) {
        <div class="info-section consultation-note-section">
          <h3>
            <i class="fa-solid fa-notes-medical"></i>
            Nota Clínica
          </h3>

          @if (noteLoading()) {
            <div class="note-loading">
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>Cargando nota...</span>
            </div>
          }

          @if (!noteLoading() && noteExists() && consultationNote(); as note) {
            <div class="note-summary">
              @if (note.chiefComplaint) {
                <div class="note-field">
                  <span class="note-field-label">Motivo de Consulta:</span>
                  <span class="note-field-value">{{ note.chiefComplaint }}</span>
                </div>
              }
              @if (note.diagnosis) {
                <div class="note-field">
                  <span class="note-field-label">Diagnóstico:</span>
                  <span class="note-field-value">{{ note.diagnosis }}</span>
                </div>
              }
              @if (note.clinicalFindings) {
                <div class="note-field">
                  <span class="note-field-label">Hallazgos Clínicos:</span>
                  <span class="note-field-value">{{ note.clinicalFindings }}</span>
                </div>
              }
              @if (note.treatmentPlan) {
                <div class="note-field">
                  <span class="note-field-label">Plan de Tratamiento:</span>
                  <span class="note-field-value">{{ note.treatmentPlan }}</span>
                </div>
              }
              @if (note.notes) {
                <div class="note-field">
                  <span class="note-field-label">Notas Adicionales:</span>
                  <span class="note-field-value">{{ note.notes }}</span>
                </div>
              }
              <div class="note-meta">
                <span>Creada: {{ formatNoteDateTime(note.createdAt) }}</span>
                @if (note.createdByName) {
                  <span>Por: {{ note.createdByName }}</span>
                }
              </div>
              <div class="note-actions">
                <a
                  class="btn btn-outline"
                  [routerLink]="['/appointments', apt.id, 'note']"
                >
                  <i class="fa-solid fa-pen"></i>
                  Editar Nota Completa
                </a>
              </div>
            </div>
          }

          @if (!noteLoading() && !noteExists()) {
            <div class="note-empty">
              <i class="fa-solid fa-file-medical"></i>
              <p>No se ha documentado la nota clínica de esta cita</p>
              <a
                class="btn btn-primary"
                [routerLink]="['/appointments', apt.id, 'note']"
              >
                <i class="fa-solid fa-plus"></i>
                Crear Nota Clínica
              </a>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
