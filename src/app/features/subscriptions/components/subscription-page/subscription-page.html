<div class="page-container container-wide">
  <app-page-header
    [title]="'Suscripción'"
    [subtitle]="'Gestiona tu plan y suscripción'"
    [icon]="'fa-crown'"
    [breadcrumbs]="breadcrumbItems">
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando información de suscripción...</p>
    </div>
  } @else {
    <!-- Current Subscription -->
    @if (subscription(); as sub) {
      <div class="current-plan-card">
        <div class="plan-header">
          <div class="plan-info">
            <h2>{{ sub.planName }}</h2>
            <span [class]="'badge ' + getStatusConfig(sub.status).class">
              <i [class]="'fa-solid ' + getStatusConfig(sub.status).icon"></i>
              {{ getStatusConfig(sub.status).label }}
            </span>
          </div>
          <div class="plan-price">
            <span class="price-amount">{{ formatCurrency(sub.monthlyPrice) }}</span>
            <span class="price-period">/mes</span>
          </div>
        </div>

        <div class="plan-details">
          <div class="detail-item">
            <i class="fa-solid fa-calendar"></i>
            <div>
              <span class="detail-label">Inicio</span>
              <span class="detail-value">{{ formatDate(sub.startDate) }}</span>
            </div>
          </div>
          <div class="detail-item">
            <i class="fa-solid fa-calendar-check"></i>
            <div>
              <span class="detail-label">Vencimiento</span>
              <span class="detail-value">{{ formatDate(sub.endDate) }}</span>
            </div>
          </div>
          <div class="detail-item">
            <i class="fa-solid fa-hourglass-half"></i>
            <div>
              <span class="detail-label">Días Restantes</span>
              <span class="detail-value" [class.warning]="getDaysRemaining() <= 7">{{ getDaysRemaining() }} días</span>
            </div>
          </div>
          <div class="detail-item">
            <i class="fa-solid fa-users"></i>
            <div>
              <span class="detail-label">Límite Usuarios</span>
              <span class="detail-value">{{ sub.userLimit === -1 ? 'Ilimitados' : sub.userLimit }}</span>
            </div>
          </div>
          <div class="detail-item">
            <i class="fa-solid fa-user-group"></i>
            <div>
              <span class="detail-label">Límite Pacientes</span>
              <span class="detail-value">{{ sub.patientLimit === -1 ? 'Ilimitados' : sub.patientLimit }}</span>
            </div>
          </div>
        </div>

        @if (sub.status !== 'Canceled' && sub.status !== 'Expired') {
          <div class="plan-actions">
            <button class="btn btn-outline btn-danger btn-sm" (click)="showCancelConfirm.set(true)">
              <i class="fa-solid fa-ban"></i> Cancelar Suscripción
            </button>
          </div>
        }
      </div>
    } @else {
      <div class="alert alert-info">
        <i class="fa-solid fa-info-circle"></i>
        <span>No tienes una suscripción activa. Selecciona un plan a continuación.</span>
      </div>
    }

    <!-- Plans Grid -->
    <h2 class="plans-title">
      <i class="fa-solid fa-th-large"></i>
      Planes Disponibles
    </h2>

    <div class="plans-grid">
      @for (plan of plans; track plan.id) {
        <div class="plan-card" [class.current]="isCurrentPlan(plan)" [class.popular]="plan.id === 'pro'">
          @if (plan.id === 'pro') {
            <div class="popular-badge">Más Popular</div>
          }
          <h3>{{ plan.name }}</h3>
          <div class="plan-price-block">
            <span class="plan-amount">{{ formatCurrency(plan.monthlyPrice) }}</span>
            <span class="plan-period">/mes</span>
          </div>
          <div class="plan-limits">
            <span><i class="fa-solid fa-user-group"></i> {{ plan.patientLimit === -1 ? 'Ilimitados' : plan.patientLimit }} pacientes</span>
            <span><i class="fa-solid fa-users"></i> {{ plan.userLimit === -1 ? 'Ilimitados' : plan.userLimit }} usuarios</span>
          </div>
          <ul class="plan-features">
            @for (feature of plan.features; track feature) {
              <li><i class="fa-solid fa-check"></i> {{ feature }}</li>
            }
          </ul>
          @if (isCurrentPlan(plan)) {
            <button class="btn btn-outline" disabled>
              <i class="fa-solid fa-check-circle"></i> Plan Actual
            </button>
          } @else {
            <button class="btn btn-primary">
              <i class="fa-solid fa-arrow-up"></i> Cambiar Plan
            </button>
          }
        </div>
      }
    </div>
  }

  <!-- Cancel Confirm Modal -->
  @if (showCancelConfirm()) {
    <div class="modal-backdrop" (click)="showCancelConfirm.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3><i class="fa-solid fa-exclamation-triangle"></i> Cancelar Suscripción</h3>
          <button class="btn-close-modal" (click)="showCancelConfirm.set(false)">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas cancelar tu suscripción?</p>
          <p class="text-secondary">Tu acceso continuará hasta el final del período actual. No se realizarán más cobros.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="showCancelConfirm.set(false)" [disabled]="cancelling()">
            No, mantener
          </button>
          <button class="btn btn-danger" (click)="cancelSubscription()" [disabled]="cancelling()">
            @if (cancelling()) {
              <i class="fa-solid fa-spinner fa-spin"></i> Cancelando...
            } @else {
              Sí, cancelar
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
