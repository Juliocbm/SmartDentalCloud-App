<div class="page-container container-wide">
  <app-page-header
    [title]="'Dashboard'"
    [subtitle]="'Panel de control general de la clínica'"
    [icon]="'fa-gauge'">
    <div actions>
      <button class="btn btn-outline" (click)="refreshData()" [disabled]="loading()">
        <i class="fa-solid fa-sync-alt" [class.fa-spin]="loading()"></i>
        Actualizar
      </button>
      <a routerLink="/appointments/new" class="btn btn-outline btn-success">
        <i class="fa-solid fa-plus"></i>
        Nueva Cita
      </a>
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando dashboard...</p>
    </div>
  } @else {
    <!-- Alert Banner: Stock Bajo -->
    @if (lowStockCount() > 0) {
      <div class="alert-banner alert-banner--warning">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <span>Hay <strong>{{ lowStockCount() }}</strong> productos con stock bajo que requieren atención.</span>
        <a routerLink="/inventory/alerts" class="btn btn-sm btn-warning">
          Ver Alertas
        </a>
      </div>
    }

    <!-- KPI Metrics -->
    <div class="metrics-grid">
      <a class="metric-card primary" routerLink="/appointments">
        <div class="metric-icon">
          <i class="fa-solid fa-calendar-check"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Citas de Hoy</span>
          <span class="metric-value">{{ todayAppointmentsCount() }}</span>
        </div>
        <i class="fa-solid fa-chevron-right metric-arrow"></i>
      </a>

      <a class="metric-card success" routerLink="/reports/income">
        <div class="metric-icon">
          <i class="fa-solid fa-dollar-sign"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Ingresos del Mes</span>
          <span class="metric-value">{{ formatCurrency(monthlyIncome()) }}</span>
        </div>
        <i class="fa-solid fa-chevron-right metric-arrow"></i>
      </a>

      <a class="metric-card info" routerLink="/treatments">
        <div class="metric-icon">
          <i class="fa-solid fa-tooth"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Tratamientos Activos</span>
          <span class="metric-value">{{ activeTreatmentsCount() }}</span>
        </div>
        <i class="fa-solid fa-chevron-right metric-arrow"></i>
      </a>

      <a class="metric-card warning" routerLink="/treatment-plans">
        <div class="metric-icon">
          <i class="fa-solid fa-clipboard-list"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Planes por Aprobar</span>
          <span class="metric-value">{{ pendingApprovalCount() }}</span>
        </div>
        <i class="fa-solid fa-chevron-right metric-arrow"></i>
      </a>

      <a class="metric-card critical" routerLink="/inventory/alerts">
        <div class="metric-icon">
          <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Productos Stock Bajo</span>
          <span class="metric-value">{{ lowStockCount() }}</span>
        </div>
        <i class="fa-solid fa-chevron-right metric-arrow"></i>
      </a>

      <a class="metric-card warning" routerLink="/reports/accounts-receivable">
        <div class="metric-icon">
          <i class="fa-solid fa-hand-holding-dollar"></i>
        </div>
        <div class="metric-content">
          <span class="metric-label">Pendiente de Cobro</span>
          <span class="metric-value">{{ formatCurrency(pendingBalance()) }}</span>
        </div>
        <i class="fa-solid fa-chevron-right metric-arrow"></i>
      </a>
    </div>

    <!-- Acciones Rápidas -->
    <div class="section-card quick-actions-wrapper">
      <h2 class="section-title">
        <i class="fa-solid fa-bolt"></i>
        Acciones Rápidas
      </h2>
      <div class="quick-actions-grid cols-3">
        @for (action of quickActions; track action.route) {
          <a [routerLink]="action.route" class="quick-action-card">
            <div class="action-icon" [ngClass]="action.color">
              <i class="fa-solid" [ngClass]="action.icon"></i>
            </div>
            <div class="action-content">
              <h3 class="action-title">{{ action.label }}</h3>
              <p class="action-description">{{ action.description }}</p>
            </div>
            <i class="fa-solid fa-chevron-right action-arrow"></i>
          </a>
        }
      </div>
    </div>

    <!-- Content Grid: Citas + Planes -->
    <div class="analytics-grid">
      <!-- Próximas Citas -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fa-solid fa-calendar-days"></i>
            Próximas Citas
          </h2>
          @if (upcomingAppointments().length > 0) {
            <span class="section-badge">{{ upcomingAppointments().length }}</span>
          }
        </div>

        @if (upcomingAppointments().length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-calendar-check"></i>
            <p>No hay citas programadas próximamente</p>
          </div>
        } @else {
          <div class="data-list">
            @for (apt of upcomingAppointments(); track apt.id) {
              <a [routerLink]="['/appointments', apt.id]" class="data-list-item compact">
                <div class="appointment-avatar">
                  {{ apt.patientName.charAt(0) || '?' }}
                </div>
                <div class="item-info">
                  <span class="item-title">{{ apt.patientName }}</span>
                  <span class="item-detail">
                    {{ formatDateTime(apt.startAt) }} · {{ apt.reason || 'Consulta' }}
                  </span>
                </div>
                <span class="badge" [ngClass]="getAppointmentStatusClass(apt.status)">
                  {{ getAppointmentStatusLabel(apt.status) }}
                </span>
                <i class="fa-solid fa-chevron-right item-arrow"></i>
              </a>
            }
          </div>
        }
      </div>

      <!-- Planes Pendientes de Aprobación -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fa-solid fa-clipboard-list"></i>
            Planes por Aprobar
          </h2>
          @if (pendingPlans().length > 0) {
            <span class="section-badge">{{ pendingPlans().length }}</span>
          }
        </div>

        @if (pendingPlans().length === 0) {
          <div class="empty-state success">
            <i class="fa-solid fa-circle-check"></i>
            <p>No hay planes pendientes de aprobación</p>
          </div>
        } @else {
          <div class="data-list">
            @for (plan of pendingPlans(); track plan.id) {
              <a [routerLink]="['/treatment-plans', plan.id]" class="data-list-item compact">
                <div class="plan-icon">
                  <i class="fa-solid fa-clipboard-list"></i>
                </div>
                <div class="item-info">
                  <span class="item-title">{{ plan.title }}</span>
                  <span class="item-detail">{{ plan.patientName }} · {{ plan.totalItems }} items</span>
                </div>
                <span class="plan-cost">{{ formatCurrency(plan.totalEstimatedCost) }}</span>
                <i class="fa-solid fa-chevron-right item-arrow"></i>
              </a>
            }
          </div>
        }
      </div>
    </div>

    <!-- Alertas de Inventario -->
    @if (lowStockItems().length > 0) {
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fa-solid fa-triangle-exclamation"></i>
            Alertas de Inventario
          </h2>
          <span class="section-badge">{{ lowStockItems().length }}</span>
        </div>
        <div class="data-list">
          @for (item of lowStockItems().slice(0, 5); track item.productId) {
            <div class="data-list-item compact">
              <div class="urgency-indicator" [ngClass]="item.currentStock === 0 ? 'critical' : 'warning'">
                <i class="fa-solid" [ngClass]="item.currentStock === 0 ? 'fa-xmark' : 'fa-exclamation'"></i>
              </div>
              <div class="item-info">
                <span class="item-title">{{ item.productName }}</span>
                <span class="item-detail">{{ item.categoryName || 'Sin categoría' }}</span>
              </div>
              <div class="stock-levels">
                <span class="stock-current" [class.stock-critical]="item.currentStock === 0" [class.stock-warning]="item.currentStock > 0">
                  {{ item.currentStock }}
                </span>
                <span class="stock-separator">/</span>
                <span class="stock-minimum">{{ item.minimumStock }}</span>
              </div>
            </div>
          }
        </div>
      </div>
    }
  }
</div>
