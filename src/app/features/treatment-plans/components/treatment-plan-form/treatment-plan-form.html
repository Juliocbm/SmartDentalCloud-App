<div class="page-container container-medium">
  <!-- Page Header con Actions -->
  <app-page-header
    [title]="isEditMode() ? 'Editar Plan de Tratamiento' : 'Nuevo Plan de Tratamiento'"
    [subtitle]="isEditMode() ? 'Modifica la información del plan de tratamiento' : 'Crear un plan de tratamiento integral para un paciente'"
    [icon]="'fa-clipboard-list'"
    [showBackButton]="true"
    [backRoute]="isEditMode() ? '/treatment-plans/' + planId() : '/treatment-plans'"
    [breadcrumbs]="breadcrumbItems()">

    <div actions class="header-form-actions">
      <button type="button" class="btn btn-outline" (click)="cancel()" [disabled]="loading()">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-outline btn-success" (click)="onSubmit()" [disabled]="loading()">
        @if (loading()) {
          <span class="btn-spinner"></span>
          Guardando...
        } @else {
          <i class="fa-solid fa-save"></i>
          {{ isEditMode() ? 'Guardar Cambios' : 'Crear Plan' }}
        }
      </button>
    </div>
  </app-page-header>

  <!-- Content Card -->
  <div class="content-card">
    <!-- Error Alert -->
    @if (error()) {
      <div class="alert alert-error">
        <i class="fa-solid fa-circle-exclamation alert-icon"></i>
        <span class="alert-message">{{ error() }}</span>
        <button class="alert-close" (click)="error.set(null)">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    }

    <!-- Form -->
    <form [formGroup]="form" class="standard-form">

      <!-- Sección: Paciente -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-user section-icon"></i>
          Paciente
        </h3>

        <div class="form-row">
          <div class="form-group">
            @if (isPatientLocked()) {
              <label class="form-label">Paciente</label>
              <div class="locked-field">
                <i class="fa-solid fa-lock locked-icon"></i>
                <span>{{ selectedPatient()?.name }}</span>
              </div>
              <p class="field-hint">
                <i class="fa-solid fa-circle-info"></i>
                El paciente no se puede cambiar en planes aprobados o en progreso
              </p>
            } @else {
              <app-patient-autocomplete
                [selectedPatientId]="selectedPatient()?.id || null"
                [required]="true"
                [disabled]="loading()"
                (patientSelected)="onPatientSelected($event)"
              >
                Paciente
              </app-patient-autocomplete>
              @if (isFieldInvalid('patientId')) {
                <span class="error-message">Seleccione un paciente</span>
              }
            }
          </div>
        </div>
      </div>

      <!-- Sección: Información del Plan -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-file-medical section-icon"></i>
          Información del Plan
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label for="title" class="form-label">
              Título del Plan <span class="required">*</span>
            </label>
            <input
              id="title"
              type="text"
              formControlName="title"
              class="form-input"
              [class.input-error]="isFieldInvalid('title')"
              placeholder="Ej: Plan de Ortodoncia Completa"
            />
            @if (isFieldInvalid('title')) {
              <span class="error-message">El título es requerido (mínimo 3 caracteres)</span>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="diagnosis" class="form-label">Diagnóstico</label>
            <textarea
              id="diagnosis"
              formControlName="diagnosis"
              class="form-input form-textarea"
              rows="3"
              placeholder="Ej: Maloclusión dental clase II, apiñamiento moderado"
            ></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group form-group-full">
            <label for="description" class="form-label">Descripción</label>
            <textarea
              id="description"
              formControlName="description"
              class="form-input form-textarea"
              rows="3"
              placeholder="Descripción general del plan de tratamiento..."
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Sección: Fechas -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-calendar section-icon"></i>
          Fechas Estimadas
          <span class="optional-badge">Opcional</span>
        </h3>

        <div class="form-row">
          <div class="form-group">
            <app-date-picker
              formControlName="estimatedStartDate"
              placeholder="Seleccionar fecha de inicio..."
            >
              Fecha de Inicio
            </app-date-picker>
          </div>

          <div class="form-group">
            <app-date-picker
              formControlName="estimatedEndDate"
              placeholder="Seleccionar fecha de fin..."
            >
              Fecha de Fin
            </app-date-picker>
          </div>
        </div>
      </div>

      <!-- Sección: Procedimientos del Plan -->
      <div class="form-section">
        <div class="section-header-row">
          <h3 class="section-title">
            <i class="fa-solid fa-list-check section-icon"></i>
            Procedimientos del Plan
            @if (items.length > 0) {
              <span class="items-count">{{ items.length }}</span>
            }
          </h3>
          @if (!isEditMode()) {
            <button type="button" class="btn btn-outline btn-sm" (click)="openAddProcModal()">
              <i class="fa-solid fa-plus"></i>
              Agregar Procedimiento
            </button>
          }
        </div>

        @if (isEditMode()) {
          <div class="info-banner">
            <i class="fa-solid fa-circle-info"></i>
            Los procedimientos se gestionan desde la vista de detalle del plan.
          </div>
        }

        @if (items.length === 0) {
          <div class="empty-items">
            <i class="fa-solid fa-list-check"></i>
            <p>No hay procedimientos en el plan</p>
            <button type="button" class="btn btn-outline btn-sm" (click)="openAddProcModal()">
              <i class="fa-solid fa-plus"></i>
              Agregar primer procedimiento
            </button>
          </div>
        } @else {
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Descripción</th>
                  <th>Costo</th>
                  <th>Desc.</th>
                  <th>Neto</th>
                  <th>Prioridad</th>
                  <th>Fase</th>
                  <th class="actions-column">Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (item of items.controls; track $index) {
                  <tr>
                    <td>{{ $index + 1 }}</td>
                    <td>
                      <span class="proc-description">{{ item.get('description')?.value }}</span>
                      @if (item.get('notes')?.value) {
                        <span class="proc-notes">{{ item.get('notes')?.value }}</span>
                      }
                    </td>
                    <td class="amount-cell">{{ item.get('estimatedCost')?.value | number:'1.2-2' }}</td>
                    <td class="amount-cell">{{ item.get('discount')?.value | number:'1.2-2' }}</td>
                    <td class="amount-cell">{{ (item.get('estimatedCost')?.value || 0) - (item.get('discount')?.value || 0) | number:'1.2-2' }}</td>
                    <td>
                      <span class="badge badge-priority-{{ (item.get('priority')?.value || 'Medium') | lowercase }}">
                        {{ item.get('priority')?.value }}
                      </span>
                    </td>
                    <td>{{ item.get('treatmentPhase')?.value || '—' }}</td>
                    <td class="actions-column">
                      <div class="action-buttons">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline btn-icon"
                          title="Editar procedimiento"
                          (click)="openEditProcModal($index)"
                        >
                          <i class="fa-solid fa-pen"></i>
                        </button>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline btn-icon btn-danger"
                          title="Eliminar procedimiento"
                          (click)="removeProc($index)"
                        >
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Total Estimado -->
          <div class="plan-total">
            <span class="total-label">Total Estimado:</span>
            <span class="total-amount">
              {{ getTotalEstimated() | number:'1.2-2' }} MXN
            </span>
          </div>
        }
      </div>

    </form>
  </div>
</div>

<!-- Procedure Modal -->
@if (showProcModal()) {
  <app-modal
    [title]="isEditingProc ? 'Editar Procedimiento' : 'Agregar Procedimiento'"
    [subtitle]="isEditingProc ? 'Modifica los datos del procedimiento' : 'Completa los datos del procedimiento'"
    [icon]="'fa-list-check'"
    [size]="'lg'"
    (closed)="closeProcModal()">

    <form [formGroup]="procForm">
      <!-- Servicio del Catálogo -->
      <div class="form-group">
        <label class="form-label">
          Servicio del Catálogo
          <span class="optional-badge">Auto-fill</span>
        </label>
        <app-service-select
          [disabled]="false"
          (serviceSelected)="onModalServiceSelected($event)"
        ></app-service-select>
        <p class="field-hint">
          <i class="fa-solid fa-circle-info"></i>
          Selecciona un servicio para llenar automáticamente descripción y costo
        </p>
      </div>

      <!-- Descripción -->
      <div class="form-group">
        <label class="form-label">Descripción <span class="required">*</span></label>
        <input
          type="text"
          formControlName="description"
          class="form-input"
          [class.input-error]="isProcFieldInvalid('description')"
          placeholder="Descripción del procedimiento"
        />
        @if (isProcFieldInvalid('description')) {
          <span class="error-message">La descripción es requerida</span>
        }
      </div>

      <!-- Costo + Descuento + Prioridad -->
      <div class="form-row form-row-3">
        <div class="form-group">
          <label class="form-label">Costo Estimado <span class="required">*</span></label>
          <input
            type="number"
            formControlName="estimatedCost"
            class="form-input"
            [class.input-error]="isProcFieldInvalid('estimatedCost')"
            placeholder="0.00"
            min="0"
            step="0.01"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Descuento</label>
          <input
            type="number"
            formControlName="discount"
            class="form-input"
            placeholder="0.00"
            min="0"
            step="0.01"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Prioridad</label>
          <select formControlName="priority" class="form-input">
            @for (priority of priorityOptions; track priority) {
              <option [value]="priority">{{ priority }}</option>
            }
          </select>
        </div>
      </div>

      <!-- Fase + Fecha -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fase del Tratamiento</label>
          <input
            type="text"
            formControlName="treatmentPhase"
            class="form-input"
            placeholder="Ej: Fase 1: Diagnóstico"
          />
        </div>

        <div class="form-group">
          <app-date-picker
            formControlName="estimatedDate"
            placeholder="Seleccionar fecha estimada..."
          >
            Fecha Estimada
          </app-date-picker>
        </div>
      </div>

      <!-- Notas -->
      <div class="form-group">
        <label class="form-label">Notas</label>
        <input
          type="text"
          formControlName="notes"
          class="form-input"
          placeholder="Notas adicionales sobre este procedimiento..."
        />
      </div>

      <!-- Net Cost Preview -->
      <div class="modal-cost-preview">
        <span>Costo Neto:</span>
        <span class="modal-cost-value">{{ procNetCost | number:'1.2-2' }} MXN</span>
      </div>
    </form>

    <div modal-footer>
      <button type="button" class="btn btn-outline" (click)="closeProcModal()">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-outline btn-success" (click)="confirmProcModal()" [disabled]="procForm.invalid">
        <i class="fa-solid fa-check"></i>
        {{ isEditingProc ? 'Guardar Cambios' : 'Agregar Procedimiento' }}
      </button>
    </div>
  </app-modal>
}
