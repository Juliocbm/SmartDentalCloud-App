<div class="page-container container-wide">
  <app-page-header
    [title]="'Inventario'"
    [subtitle]="'Panel de control del módulo de inventario'"
    [icon]="'fa-boxes-stacked'"
    [breadcrumbs]="breadcrumbItems">
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando datos del inventario...</p>
    </div>
  } @else if (error()) {
    <div class="alert alert-error">
      <i class="fa-solid fa-circle-exclamation"></i>
      <span>{{ error() }}</span>
    </div>
  } @else {
    <!-- Alertas destacadas -->
    @if (totalAlerts() > 0) {
      <div class="alert-banner alert-banner--warning">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <span>
          Tienes <strong>{{ totalAlerts() }}</strong> producto{{ totalAlerts() === 1 ? '' : 's' }} con alertas de stock.
        </span>
        <a [routerLink]="['/inventory/alerts']" class="btn btn--sm btn--warning">
          Ver Alertas
        </a>
      </div>
    }

    <!-- Grid: Indicadores + Accesos Rápidos -->
    <div class="bottom-grid">
      <!-- Indicadores Clave -->
      <div class="section-card grid-narrow">
        <h2 class="section-title">
          <i class="fa-solid fa-gauge-high"></i>
          Indicadores Clave
        </h2>
        <div class="indicators-list">
          <!-- Total de Productos -->
          <a [routerLink]="['/inventory/products']" class="quick-action-card">
            <div class="action-icon primary">
              <i class="fa-solid fa-boxes-stacked"></i>
            </div>
            <div class="action-content">
              <h3 class="action-title">Total Productos</h3>
              <p class="action-value">{{ totalProducts() }}</p>
            </div>
            <i class="fa-solid fa-chevron-right action-arrow"></i>
          </a>
          <!-- Valor del Inventario -->
          <a [routerLink]="['/inventory/products']" class="quick-action-card">
            <div class="action-icon success">
              <i class="fa-solid fa-coins"></i>
            </div>
            <div class="action-content">
              <h3 class="action-title">Valor Inventario</h3>
              <p class="action-value">{{ formatCurrency(totalInventoryValue()) }}</p>
            </div>
            <i class="fa-solid fa-chevron-right action-arrow"></i>
          </a>
        </div>
      </div>

      <!-- Accesos Rápidos -->
      <div class="section-card grid-wide">
        <h2 class="section-title">
          <i class="fa-solid fa-bolt"></i>
          Accesos Rápidos
        </h2>
        <div class="quick-actions-grid cols-4">
          @for (action of quickActions; track action.route) {
            <a [routerLink]="action.route" class="quick-action-card">
              <div class="action-icon">
                <i class="fa-solid {{ action.icon }}"></i>
              </div>
              <div class="action-content">
                <h3 class="action-title">{{ action.label }}</h3>
                <p class="action-description">{{ action.description }}</p>
              </div>
              <i class="fa-solid fa-chevron-right action-arrow"></i>
            </a>
          }
        </div>
      </div>
    </div>

    <!-- Fase 2: Grid de dos columnas para Gráficos -->
    <div class="analytics-grid">
      <!-- Distribución por Categorías - Pie Chart -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="fa-solid fa-chart-pie"></i>
          Distribución por Categorías
        </h2>
        
        @if (loadingCategories()) {
          <div class="loading-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (categoryDistribution().length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-folder-open"></i>
            <p>No hay categorías registradas</p>
          </div>
        } @else {
          <app-pie-chart
            [data]="categoryChartData()"
            [doughnut]="true"
            [showLegend]="true"
            [height]="'280px'"
          />
        }
      </div>

      <!-- Top Productos - Bar Chart -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="fa-solid fa-ranking-star"></i>
          Top Productos por Uso
        </h2>
        
        @if (loadingTopProducts()) {
          <div class="loading-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (topProducts().length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-inbox"></i>
            <p>No hay datos de uso</p>
          </div>
        } @else {
          <app-bar-chart
            [data]="topProductsChartData()"
            [horizontal]="true"
            [height]="'280px'"
          />
        }
      </div>
    </div>

    <!-- Grid de 3 columnas: Próximos a Vencer + Productos Más Utilizados + Actividad Reciente -->
    <div class="analytics-grid cols-3">
      <!-- Productos Próximos a Vencer -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fa-solid fa-calendar-xmark"></i>
            Próximos a Vencer
          </h2>
          @if (expiringProducts().length > 0) {
            <span class="section-badge">
              {{ expiringProducts().length }}
            </span>
          }
        </div>

        @if (loadingExpiring()) {
          <div class="loading-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (expiringProducts().length === 0) {
          <div class="empty-state success">
            <i class="fa-solid fa-circle-check"></i>
            <p>No hay productos próximos a vencer</p>
          </div>
        } @else {
          <div class="expiring-products-list">
            @for (product of expiringProducts(); track product.id) {
              <a 
                [routerLink]="['/inventory/products', product.id]" 
                class="expiring-product-item compact"
                [class]="'urgency-' + product.urgencyLevel">
                
                <div class="urgency-indicator">
                  <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                
                <div class="product-details">
                  <span class="product-name">{{ product.name }}</span>
                  <span class="expiry-date">
                    {{ product.expiryDate | date:'dd/MM' }} - 
                    @if (product.daysToExpire === 0) {
                      Hoy
                    } @else if (product.daysToExpire < 0) {
                      Vencido
                    } @else {
                      {{ product.daysToExpire }}d
                    }
                  </span>
                </div>
              </a>
            }
          </div>
        }
      </div>

      <!-- Top 5 Productos Más Usados -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="fa-solid fa-star"></i>
          Productos Más Utilizados
        </h2>
        
        @if (loadingTopProducts()) {
          <div class="loading-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (topProducts().length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-inbox"></i>
            <p>No hay datos de productos utilizados</p>
          </div>
        } @else {
          <div class="top-products-list">
            @for (product of topProducts(); track product.id) {
              <a [routerLink]="['/inventory/products', product.id]" class="top-product-item compact">
                <div class="product-info">
                  <span class="product-name">{{ product.name }}</span>
                  <span class="product-category">{{ product.categoryName }}</span>
                </div>
                
                <div class="product-stats">
                  <span class="usage-count">
                    <i class="fa-solid fa-chart-simple"></i>
                    {{ product.usageCount }}
                  </span>
                  <span class="stock-badge" [class]="'status-' + product.stockStatus">
                    {{ product.currentStock }}
                  </span>
                </div>
              </a>
            }
          </div>
        }
      </div>

      <!-- Timeline de Actividad Reciente -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="fa-solid fa-clock-rotate-left"></i>
          Actividad Reciente
        </h2>
        
        @if (loadingActivity()) {
          <div class="loading-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (recentActivity().length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-history"></i>
            <p>No hay actividad reciente</p>
          </div>
        } @else {
          <div class="activity-timeline">
            @for (activity of recentActivity(); track activity.id) {
              <div class="activity-item">
                <div class="activity-icon {{ getActivityColor(activity.type) }}">
                  <i class="fa-solid {{ getActivityIcon(activity.type) }}"></i>
                </div>
                <div class="activity-content">
                  <p class="activity-description">{{ activity.description }}</p>
                  <span class="activity-time">
                    <i class="fa-solid fa-clock"></i>
                    {{ activity.timestamp | date:'dd/MM HH:mm' }}
                  </span>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
