<div class="page-container container-wide">
  <app-page-header
    [title]="'Inventario'"
    [subtitle]="'Panel de control del módulo de inventario'"
    [icon]="'fa-boxes-stacked'"
    [breadcrumbs]="breadcrumbItems">
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando datos del inventario...</p>
    </div>
  } @else if (error()) {
    <div class="alert alert-error">
      <i class="fa-solid fa-circle-exclamation"></i>
      <span>{{ error() }}</span>
    </div>
  } @else {
    <!-- Métricas -->
    <div class="metrics-grid">
      @for (metric of metrics(); track metric.label) {
        <a [routerLink]="metric.route" class="metric-card {{ metric.colorClass }}">
          <div class="metric-icon">
            <i class="fa-solid {{ metric.icon }}"></i>
          </div>
          <div class="metric-content">
            <span class="metric-label">{{ metric.label }}</span>
            <span class="metric-value">
              @if (metric.format === 'currency') {
                {{ formatCurrency(metric.value) }}
              } @else {
                {{ metric.value }}
              }
            </span>
          </div>
          <div class="metric-arrow">
            <i class="fa-solid fa-chevron-right"></i>
          </div>
        </a>
      }
    </div>

    <!-- Alertas destacadas -->
    @if (totalAlerts() > 0) {
      <div class="alert-banner">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>
          Tienes <strong>{{ totalAlerts() }}</strong> producto{{ totalAlerts() === 1 ? '' : 's' }} con alertas de stock.
        </span>
        <a [routerLink]="['/inventory/alerts']" class="btn btn-sm btn-primary">
          Ver Alertas
          <i class="fa-solid fa-arrow-right"></i>
        </a>
      </div>
    }

    <!-- Top 5 Productos Más Usados -->
    <div class="section-card">
      <h2 class="section-title">
        <i class="fa-solid fa-star"></i>
        Productos Más Utilizados
      </h2>
      
      @if (loadingTopProducts()) {
        <div class="loading-spinner">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
      } @else if (topProducts().length === 0) {
        <div class="empty-state">
          <i class="fa-solid fa-inbox"></i>
          <p>No hay datos de productos utilizados</p>
        </div>
      } @else {
        <div class="top-products-list">
          @for (product of topProducts(); track product.id) {
            <a [routerLink]="['/inventory/products', product.id]" class="top-product-item">
              <div class="product-info">
                <div class="product-header">
                  <span class="product-name">{{ product.name }}</span>
                  <span class="product-code">{{ product.code }}</span>
                </div>
                <span class="product-category">{{ product.categoryName }}</span>
              </div>
              
              <div class="product-stats">
                <span class="usage-count">
                  <i class="fa-solid fa-chart-simple"></i>
                  {{ product.usageCount }} usos
                </span>
                <span class="stock-badge" [class]="'status-' + product.stockStatus">
                  {{ product.currentStock }} unidades
                </span>
              </div>
              
              <i class="fa-solid fa-chevron-right item-arrow"></i>
            </a>
          }
        </div>
      }
    </div>

    <!-- Productos Próximos a Vencer -->
    <div class="section-card">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fa-solid fa-calendar-xmark"></i>
          Próximos a Vencer
        </h2>
        @if (expiringProducts().length > 0) {
          <span class="section-badge">
            {{ expiringProducts().length }}
          </span>
        }
      </div>

      @if (loadingExpiring()) {
        <div class="loading-spinner">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
      } @else if (expiringProducts().length === 0) {
        <div class="empty-state success">
          <i class="fa-solid fa-circle-check"></i>
          <p>No hay productos próximos a vencer</p>
        </div>
      } @else {
        <div class="expiring-products-list">
          @for (product of expiringProducts(); track product.id) {
            <a 
              [routerLink]="['/inventory/products', product.id]" 
              class="expiring-product-item"
              [class]="'urgency-' + product.urgencyLevel">
              
              <div class="urgency-indicator">
                <i class="fa-solid fa-triangle-exclamation"></i>
              </div>
              
              <div class="product-details">
                <div class="product-main">
                  <span class="product-name">{{ product.name }}</span>
                  <span class="product-code">{{ product.code }}</span>
                </div>
                @if (product.lotNumber) {
                  <span class="product-lot">Lote: {{ product.lotNumber }}</span>
                }
              </div>
              
              <div class="expiry-info">
                <span class="expiry-date">
                  <i class="fa-solid fa-calendar"></i>
                  {{ product.expiryDate | date:'dd/MM/yyyy' }}
                </span>
                <span class="days-remaining">
                  @if (product.daysToExpire === 0) {
                    Vence hoy
                  } @else if (product.daysToExpire === 1) {
                    Vence mañana
                  } @else if (product.daysToExpire < 0) {
                    Vencido
                  } @else {
                    {{ product.daysToExpire }} días
                  }
                </span>
              </div>
              
              <span class="stock-count">{{ product.currentStock }} unidades</span>
              
              <i class="fa-solid fa-chevron-right item-arrow"></i>
            </a>
          }
        </div>
      }
    </div>

    <!-- Fase 2: Grid de dos columnas para Categorías y Actividad -->
    <div class="analytics-grid">
      <!-- Distribución por Categorías -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="fa-solid fa-chart-pie"></i>
          Distribución por Categorías
        </h2>
        
        @if (loadingCategories()) {
          <div class="loading-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (categoryDistribution().length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-folder-open"></i>
            <p>No hay categorías registradas</p>
          </div>
        } @else {
          <div class="category-chart">
            @for (category of categoryDistribution(); track category.categoryId) {
              <div class="category-bar-item">
                <div class="category-bar-header">
                  <span class="category-name">{{ category.categoryName }}</span>
                  <span class="category-count">{{ category.totalProducts }} productos</span>
                </div>
                <div class="category-bar-container">
                  <div 
                    class="category-bar-fill" 
                    [class]="'status-' + category.status"
                    [style.width.%]="category.percentage">
                  </div>
                  <span class="category-percentage">{{ category.percentage }}%</span>
                </div>
                @if (category.criticalStockCount > 0 || category.lowStockCount > 0) {
                  <div class="category-alerts">
                    @if (category.criticalStockCount > 0) {
                      <span class="alert-badge critical">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        {{ category.criticalStockCount }} críticos
                      </span>
                    }
                    @if (category.lowStockCount > 0) {
                      <span class="alert-badge warning">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        {{ category.lowStockCount }} bajos
                      </span>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>

      <!-- Timeline de Actividad Reciente -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="fa-solid fa-clock-rotate-left"></i>
          Actividad Reciente
        </h2>
        
        @if (loadingActivity()) {
          <div class="loading-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (recentActivity().length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-history"></i>
            <p>No hay actividad reciente</p>
          </div>
        } @else {
          <div class="activity-timeline">
            @for (activity of recentActivity(); track activity.id) {
              <div class="activity-item">
                <div class="activity-icon {{ getActivityColor(activity.type) }}">
                  <i class="fa-solid {{ getActivityIcon(activity.type) }}"></i>
                </div>
                <div class="activity-content">
                  <p class="activity-description">{{ activity.description }}</p>
                  <span class="activity-time">
                    <i class="fa-solid fa-clock"></i>
                    {{ activity.timestamp | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Accesos Rápidos -->
    <div class="section-card">
      <h2 class="section-title">
        <i class="fa-solid fa-bolt"></i>
        Accesos Rápidos
      </h2>
      <div class="quick-actions-grid">
        @for (action of quickActions; track action.route) {
          <a [routerLink]="action.route" class="quick-action-card">
            <div class="action-icon">
              <i class="fa-solid {{ action.icon }}"></i>
            </div>
            <div class="action-content">
              <h3 class="action-title">{{ action.label }}</h3>
              <p class="action-description">{{ action.description }}</p>
            </div>
            <i class="fa-solid fa-chevron-right action-arrow"></i>
          </a>
        }
      </div>
    </div>
  }
</div>
