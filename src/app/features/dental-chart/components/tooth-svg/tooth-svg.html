<div
  class="tooth-wrapper"
  [class.selected]="selected()"
  [class.hovered]="hovered()"
  [class.absent]="isAbsent()"
  (click)="onClick()"
  (mouseenter)="onMouseEnter()"
  (mouseleave)="onMouseLeave()"
  [attr.aria-label]="fdi() + ' - ' + status()">

  <!-- Tooth Shape SVG -->
  <svg
    class="tooth-shape"
    [class.upper]="jaw() === 'upper'"
    [class.lower]="jaw() === 'lower'"
    [attr.viewBox]="viewBox()"
    xmlns="http://www.w3.org/2000/svg">

    @if (toothData(); as td) {
      <!-- Realistic tooth paths -->
      <g class="realistic-tooth" [class.absent-tooth]="isAbsent()">
        @for (p of td.paths; track $index) {
          <path
            [attr.d]="p.d"
            [attr.fill]="p.role === 's' ? shadowFill() : '#FDFDFD'"
            [class.tooth-shadow-path]="p.role === 's'"
            [class.tooth-body-path]="p.role === 'b'"/>
        }
      </g>
    } @else {
      <!-- Fallback: generic tooth shape -->
      <g class="roots-group" [class.absent-roots]="isAbsent()">
        @for (rootPath of shape().roots; track $index) {
          <path
            [attr.d]="rootPath"
            class="tooth-root"
            [class.implant-root]="isImplant()"/>
        }
      </g>
      <path
        [attr.d]="shape().crown"
        class="tooth-crown"
        [attr.fill]="crownColor()"
        [class.crown-selected]="selected()"
        [class.crown-absent]="isAbsent()"/>
    }

    <!-- Implant screw indicator -->
    @if (isImplant()) {
      <line [attr.x1]="cx()" [attr.y1]="crownCY()" [attr.x2]="cx()" [attr.y2]="rootCY()" class="implant-screw"/>
      <line [attr.x1]="cx()-tw()*0.12" [attr.y1]="rootCY()-(rootCY()-crownCY())*0.7" [attr.x2]="cx()+tw()*0.12" [attr.y2]="rootCY()-(rootCY()-crownCY())*0.7" class="implant-thread"/>
      <line [attr.x1]="cx()-tw()*0.15" [attr.y1]="rootCY()-(rootCY()-crownCY())*0.5" [attr.x2]="cx()+tw()*0.15" [attr.y2]="rootCY()-(rootCY()-crownCY())*0.5" class="implant-thread"/>
      <line [attr.x1]="cx()-tw()*0.12" [attr.y1]="rootCY()-(rootCY()-crownCY())*0.3" [attr.x2]="cx()+tw()*0.12" [attr.y2]="rootCY()-(rootCY()-crownCY())*0.3" class="implant-thread"/>
    }

    <!-- Extracted X overlay -->
    @if (status() === 'Extracted') {
      <line [attr.x1]="tw()*0.2" [attr.y1]="crownCY()-th()*0.15" [attr.x2]="tw()*0.8" [attr.y2]="crownCY()+th()*0.15" class="extracted-x"/>
      <line [attr.x1]="tw()*0.8" [attr.y1]="crownCY()-th()*0.15" [attr.x2]="tw()*0.2" [attr.y2]="crownCY()+th()*0.15" class="extracted-x"/>
    }

    <!-- Missing dashed overlay -->
    @if (status() === 'Missing') {
      <rect x="0" y="0" [attr.width]="tw()" [attr.height]="th()" class="missing-outline" fill="none" rx="4"/>
    }

    <!-- Condition overlays (dynamic positioning) -->
    @if (conditions().includes('corona')) {
      <rect [attr.x]="tw()*0.15" [attr.y]="jaw()==='upper' ? crownCY()-th()*0.12 : crownCY()+th()*0.02" [attr.width]="tw()*0.7" [attr.height]="th()*0.1" rx="2" class="condition-corona"/>
    }

    @if (conditions().includes('endodoncia')) {
      <line [attr.x1]="cx()" [attr.y1]="crownCY()" [attr.x2]="cx()" [attr.y2]="rootCY()" class="condition-endo"/>
      <line [attr.x1]="cx()-tw()*0.1" [attr.y1]="crownCY()" [attr.x2]="cx()-tw()*0.1" [attr.y2]="rootCY()-(rootCY()-crownCY())*0.25" class="condition-endo"/>
      <line [attr.x1]="cx()+tw()*0.1" [attr.y1]="crownCY()" [attr.x2]="cx()+tw()*0.1" [attr.y2]="rootCY()-(rootCY()-crownCY())*0.25" class="condition-endo"/>
    }

    @if (conditions().includes('sellante')) {
      <ellipse [attr.cx]="cx()" [attr.cy]="crownCY()" [attr.rx]="tw()*0.18" [attr.ry]="th()*0.05" class="condition-sellante"/>
    }

    @if (conditions().includes('ortodoncia')) {
      <rect [attr.x]="cx()-tw()*0.15" [attr.y]="crownCY()-th()*0.04" [attr.width]="tw()*0.3" [attr.height]="th()*0.07" rx="1" class="condition-bracket"/>
      <line x1="0" [attr.y1]="crownCY()" [attr.x2]="tw()" [attr.y2]="crownCY()" class="condition-wire"/>
    }

    @if (conditions().includes('fractura')) {
      <polyline [attr.points]="(cx()-tw()*0.2)+','+(crownCY()-th()*0.1)+' '+cx()+','+(crownCY())+' '+(cx()-tw()*0.1)+','+(crownCY()+th()*0.02)+' '+(cx()+tw()*0.1)+','+(crownCY()+th()*0.1)" class="condition-fractura"/>
    }

    @if (conditions().includes('caries')) {
      <circle [attr.cx]="cx()" [attr.cy]="crownCY()" [attr.r]="tw()*0.1" class="condition-caries"/>
    }

    @if (conditions().includes('puente')) {
      <line [attr.x1]="-tw()*0.05" [attr.y1]="jaw()==='upper' ? th()*0.02 : th()*0.98" [attr.x2]="tw()*1.05" [attr.y2]="jaw()==='upper' ? th()*0.02 : th()*0.98" class="condition-puente"/>
      <line x1="0" [attr.y1]="jaw()==='upper' ? th()*0.02 : th()*0.98" x2="0" [attr.y2]="jaw()==='upper' ? th()*0.1 : th()*0.9" class="condition-puente-post"/>
      <line [attr.x1]="tw()" [attr.y1]="jaw()==='upper' ? th()*0.02 : th()*0.98" [attr.x2]="tw()" [attr.y2]="jaw()==='upper' ? th()*0.1 : th()*0.9" class="condition-puente-post"/>
    }

    @if (conditions().includes('absceso')) {
      <circle [attr.cx]="cx()" [attr.cy]="rootCY()" [attr.r]="tw()*0.1" class="condition-absceso"/>
      <circle [attr.cx]="cx()" [attr.cy]="rootCY()" [attr.r]="tw()*0.05" class="condition-absceso-inner"/>
    }

    @if (conditions().includes('gingivitis')) {
      <path [attr.d]="'M'+(tw()*0.1)+','+((crownCY()+rootCY())/2)+' Q'+(tw()*0.25)+','+((crownCY()+rootCY())/2-th()*0.03)+' '+(tw()*0.35)+','+((crownCY()+rootCY())/2)+' Q'+(tw()*0.5)+','+((crownCY()+rootCY())/2+th()*0.03)+' '+(tw()*0.65)+','+((crownCY()+rootCY())/2)+' Q'+(tw()*0.75)+','+((crownCY()+rootCY())/2-th()*0.03)+' '+(tw()*0.9)+','+((crownCY()+rootCY())/2)" class="condition-gingivitis"/>
    }

    @if (conditions().includes('movilidad')) {
      <polyline [attr.points]="(tw()*0.05)+','+(crownCY()+th()*0.05)+' '+(tw()*0.15)+','+(crownCY())+' '+(tw()*0.05)+','+(crownCY()-th()*0.05)" class="condition-movilidad"/>
      <polyline [attr.points]="(tw()*0.95)+','+(crownCY()+th()*0.05)+' '+(tw()*0.85)+','+(crownCY())+' '+(tw()*0.95)+','+(crownCY()-th()*0.05)" class="condition-movilidad"/>
    }

    @if (conditions().includes('protesis')) {
      <line [attr.x1]="-tw()*0.1" [attr.y1]="jaw()==='upper' ? th()*0.01 : th()*0.99" [attr.x2]="tw()*1.1" [attr.y2]="jaw()==='upper' ? th()*0.01 : th()*0.99" class="condition-protesis"/>
      <path [attr.d]="'M'+(tw()*0.05)+','+(jaw()==='upper' ? th()*0.01 : th()*0.99)+' Q'+(tw()*0.05)+','+(jaw()==='upper' ? th()*0.12 : th()*0.88)+' '+(tw()*0.15)+','+(jaw()==='upper' ? th()*0.12 : th()*0.88)" class="condition-protesis-hook"/>
      <path [attr.d]="'M'+(tw()*0.95)+','+(jaw()==='upper' ? th()*0.01 : th()*0.99)+' Q'+(tw()*0.95)+','+(jaw()==='upper' ? th()*0.12 : th()*0.88)+' '+(tw()*0.85)+','+(jaw()==='upper' ? th()*0.12 : th()*0.88)" class="condition-protesis-hook"/>
    }

    @if (conditions().includes('perno')) {
      <line [attr.x1]="cx()" [attr.y1]="crownCY()" [attr.x2]="cx()" [attr.y2]="rootCY()" class="condition-perno"/>
      <circle [attr.cx]="cx()" [attr.cy]="crownCY()" [attr.r]="tw()*0.06" class="condition-perno-head"/>
    }

    @if (conditions().includes('erosion')) {
      <line [attr.x1]="tw()*0.3" [attr.y1]="crownCY()-th()*0.04" [attr.x2]="tw()*0.7" [attr.y2]="crownCY()-th()*0.04" class="condition-erosion"/>
      <line [attr.x1]="tw()*0.25" [attr.y1]="crownCY()" [attr.x2]="tw()*0.75" [attr.y2]="crownCY()" class="condition-erosion"/>
      <line [attr.x1]="tw()*0.3" [attr.y1]="crownCY()+th()*0.04" [attr.x2]="tw()*0.7" [attr.y2]="crownCY()+th()*0.04" class="condition-erosion"/>
    }

    @if (conditions().includes('residuo_radicular')) {
      <rect x="0" y="0" [attr.width]="tw()" [attr.height]="th()" class="condition-residuo" fill="none" rx="3"/>
      <text [attr.x]="cx()" [attr.y]="crownCY()+th()*0.03" text-anchor="middle" class="condition-residuo-text">RR</text>
    }
  </svg>

  <!-- Mini Surface Diagram -->
  <svg
    class="surface-mini"
    viewBox="0 0 24 24"
    xmlns="http://www.w3.org/2000/svg">
    <!-- Vestibular/Buccal (top) -->
    <polygon
      points="4,1 20,1 17,7 7,7"
      [attr.fill]="getSurfaceColor('buccal')"
      class="mini-surface"/>
    <!-- Lingual (bottom) -->
    <polygon
      points="7,17 17,17 20,23 4,23"
      [attr.fill]="getSurfaceColor('lingual')"
      class="mini-surface"/>
    <!-- Mesial (left) -->
    <polygon
      points="1,3 7,7 7,17 1,21"
      [attr.fill]="getSurfaceColor('mesial')"
      class="mini-surface"/>
    <!-- Distal (right) -->
    <polygon
      points="17,7 23,3 23,21 17,17"
      [attr.fill]="getSurfaceColor('distal')"
      class="mini-surface"/>
    <!-- Occlusal (center) -->
    <rect
      x="7" y="7" width="10" height="10"
      [attr.fill]="getSurfaceColor('occlusal')"
      class="mini-surface"/>
  </svg>

  <!-- Tooth Number -->
  <span class="tooth-number">{{ fdi() }}</span>
</div>
