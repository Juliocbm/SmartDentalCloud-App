<div class="detail-container">
  <app-page-header
    [title]="'Factura'"
    [icon]="'fa-file-invoice-dollar'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems">
    <div actions>
      @if (invoice()) {
        <button class="btn btn-secondary" (click)="printInvoice()">
          <i class="fa-solid fa-print"></i>
          Imprimir
        </button>
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-state">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Cargando factura...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h2>Error al cargar la factura</h2>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver a Facturas
      </button>
    </div>
  } @else if (invoice(); as inv) {

    <!-- Header Info -->
    <div class="detail-header">

      <div class="header-content">
        <div class="title-section">
          <h1>
            <i class="fa-solid fa-file-invoice-dollar"></i>
            Factura
            @if (inv.serie && inv.folio) {
              <span class="invoice-number">{{ inv.serie }}-{{ inv.folio }}</span>
            }
          </h1>
          <span class="status-badge" [class]="getStatusConfig(inv.status).class">
            <i [class]="'fa-solid ' + getStatusConfig(inv.status).icon"></i>
            {{ getStatusConfig(inv.status).label }}
          </span>
        </div>

        <div class="header-info">
          <div class="info-item">
            <i class="fa-solid fa-user"></i>
            <span class="label">Paciente:</span>
            <span class="value">{{ inv.patientName }}</span>
          </div>
          <div class="info-item">
            <i class="fa-solid fa-calendar"></i>
            <span class="label">Emisión:</span>
            <span class="value">{{ formatDate(inv.issuedAt) }}</span>
          </div>
          @if (inv.lastPaymentDate) {
            <div class="info-item">
              <i class="fa-solid fa-clock"></i>
              <span class="label">Último Pago:</span>
              <span class="value">{{ formatDate(inv.lastPaymentDate) }}</span>
            </div>
          }
        </div>
      </div>
    </div>

    <div class="detail-body">

      <!-- Payment Progress -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-chart-line"></i>
          Progreso de Pago
        </h3>

        <div class="payment-progress">
          <div class="progress-header">
            <span>{{ getPaymentPercentage() | number:'1.0-0' }}% completado</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="getPaymentPercentage()"
              [class.progress-complete]="getPaymentPercentage() >= 100"
            ></div>
          </div>
          <div class="progress-amounts">
            <div class="amount-card">
              <span class="amount-label">Pagado</span>
              <span class="amount-value success">{{ formatCurrency(inv.paidAmount) }}</span>
            </div>
            <div class="amount-card">
              <span class="amount-label">Saldo</span>
              <span class="amount-value warning">{{ formatCurrency(inv.balance) }}</span>
            </div>
            <div class="amount-card">
              <span class="amount-label">Total</span>
              <span class="amount-value primary">{{ formatCurrency(inv.totalAmount) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Invoice Items -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-list-check"></i>
          Items de Factura
          <span class="section-count">{{ inv.items.length }}</span>
        </h3>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th class="col-num">#</th>
                <th class="col-desc">Descripción</th>
                <th class="col-qty">Cant.</th>
                <th class="col-price">Precio Unit.</th>
                <th class="col-discount">Descuento</th>
                <th class="col-tax">IVA</th>
                <th class="col-total">Total</th>
              </tr>
            </thead>
            <tbody>
              @for (item of inv.items; track item.id) {
                <tr>
                  <td class="col-num">{{ item.displayOrder }}</td>
                  <td class="col-desc">
                    <div class="item-description">
                      <span class="item-name">{{ item.description }}</span>
                      @if (item.claveProdServ) {
                        <span class="item-sat-key">{{ item.claveProdServ }}</span>
                      }
                    </div>
                  </td>
                  <td class="col-qty">{{ item.quantity }}</td>
                  <td class="col-price">{{ formatCurrency(item.unitPrice) }}</td>
                  <td class="col-discount">
                    @if (item.discountAmount > 0) {
                      <span class="discount-value">-{{ formatCurrency(item.discountAmount) }}</span>
                      <span class="discount-pct">({{ item.discountPercentage }}%)</span>
                    } @else {
                      <span class="no-value">—</span>
                    }
                  </td>
                  <td class="col-tax">
                    <span>{{ formatCurrency(item.taxAmount) }}</span>
                    <span class="tax-pct">({{ item.taxRate }}%)</span>
                  </td>
                  <td class="col-total">
                    <strong>{{ formatCurrency(item.total) }}</strong>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="invoice-totals">
          <div class="totals-row grand-total">
            <span class="totals-label">Total Factura</span>
            <span class="totals-value">{{ formatCurrency(inv.totalAmount) }}</span>
          </div>
        </div>
      </div>

      <!-- Payment History -->
      <div class="info-section">
        <div class="section-header-actions">
          <h3>
            <i class="fa-solid fa-money-bill-wave"></i>
            Historial de Pagos
            @if (payments().length > 0) {
              <span class="section-count">{{ payments().length }}</span>
            }
          </h3>
          @if (canRegisterPayment()) {
            <button class="btn btn-success" (click)="openPaymentModal()">
              <i class="fa-solid fa-plus"></i>
              Registrar Pago
            </button>
          }
        </div>

        @if (loadingPayments()) {
          <div class="loading-inline">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>Cargando pagos...</span>
          </div>
        } @else if (payments().length > 0) {
          <div class="payments-list">
            @for (payment of payments(); track payment.id) {
              <div class="payment-item">
                <div class="payment-icon">
                  <i class="fa-solid fa-money-bill"></i>
                </div>
                <div class="payment-details">
                  <div class="payment-amount">{{ formatCurrency(payment.amount) }}</div>
                  <div class="payment-meta">
                    <span class="payment-method">
                      <i class="fa-solid fa-credit-card"></i>
                      {{ payment.paymentMethod }}
                    </span>
                    @if (payment.reference) {
                      <span class="payment-reference">
                        <i class="fa-solid fa-hashtag"></i>
                        {{ payment.reference }}
                      </span>
                    }
                  </div>
                </div>
                <div class="payment-date">
                  <i class="fa-solid fa-calendar-day"></i>
                  {{ formatDate(payment.paidAt) }}
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-inline">
            <i class="fa-solid fa-receipt"></i>
            <p>No hay pagos registrados</p>
          </div>
        }
      </div>

      <!-- CFDI Section -->
      <div class="info-section">
        <div class="section-header-actions">
          <h3>
            <i class="fa-solid fa-file-signature"></i>
            Facturación Electrónica (CFDI)
          </h3>
          <div class="cfdi-actions">
            @if (canGenerateCfdi()) {
              <button
                class="btn btn-primary"
                [disabled]="cfdiActionLoading()"
                (click)="generateCfdi()"
              >
                @if (cfdiActionLoading()) {
                  <i class="fa-solid fa-spinner fa-spin"></i>
                } @else {
                  <i class="fa-solid fa-file-circle-plus"></i>
                }
                Generar CFDI
              </button>
            }
            @if (canTimbrarCfdi()) {
              <button
                class="btn btn-success"
                [disabled]="cfdiActionLoading()"
                (click)="timbrarCfdi()"
              >
                @if (cfdiActionLoading()) {
                  <i class="fa-solid fa-spinner fa-spin"></i>
                } @else {
                  <i class="fa-solid fa-stamp"></i>
                }
                Timbrar
              </button>
            }
            @if (canCancelarCfdi()) {
              <button
                class="btn btn-danger-outline"
                (click)="toggleCancelForm()"
              >
                <i class="fa-solid fa-ban"></i>
                Cancelar CFDI
              </button>
            }
          </div>
        </div>

        @if (cfdiLoading()) {
          <div class="loading-inline">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>Cargando información fiscal...</span>
          </div>
        } @else if (cfdi(); as c) {
          <!-- CFDI Details -->
          <div class="cfdi-detail-card">
            <div class="cfdi-status-row">
              <span class="badge" [class]="getCfdiStatusConfig(c.estado).class">
                <i [class]="'fa-solid ' + getCfdiStatusConfig(c.estado).icon"></i>
                {{ getCfdiStatusConfig(c.estado).label }}
              </span>
              @if (c.uuid) {
                <span class="cfdi-uuid">
                  <i class="fa-solid fa-fingerprint"></i>
                  {{ c.uuid }}
                </span>
              }
            </div>

            <div class="cfdi-info-grid">
              @if (c.serie || c.folio) {
                <div class="cfdi-info-item">
                  <span class="cfdi-label">Serie/Folio</span>
                  <span class="cfdi-value">{{ c.serie || '' }}{{ c.folio || '' }}</span>
                </div>
              }
              <div class="cfdi-info-item">
                <span class="cfdi-label">Emisor</span>
                <span class="cfdi-value">{{ c.emisorNombre }} ({{ c.emisorRfc }})</span>
              </div>
              <div class="cfdi-info-item">
                <span class="cfdi-label">Receptor</span>
                <span class="cfdi-value">{{ c.receptorNombre }} ({{ c.receptorRfc }})</span>
              </div>
              <div class="cfdi-info-item">
                <span class="cfdi-label">Uso CFDI</span>
                <span class="cfdi-value">{{ c.receptorUsoCfdi }}</span>
              </div>
              <div class="cfdi-info-item">
                <span class="cfdi-label">Método Pago</span>
                <span class="cfdi-value">{{ c.metodoPago }}</span>
              </div>
              @if (c.formaPago) {
                <div class="cfdi-info-item">
                  <span class="cfdi-label">Forma Pago</span>
                  <span class="cfdi-value">{{ c.formaPago }}</span>
                </div>
              }
              <div class="cfdi-info-item">
                <span class="cfdi-label">Total</span>
                <span class="cfdi-value">{{ formatCurrency(c.total) }}</span>
              </div>
              @if (c.fechaTimbrado) {
                <div class="cfdi-info-item">
                  <span class="cfdi-label">Timbrado</span>
                  <span class="cfdi-value">{{ formatDateTime(c.fechaTimbrado) }}</span>
                </div>
              }
            </div>

            <!-- Download & action buttons for timbrado CFDIs -->
            @if (c.uuid) {
              <div class="cfdi-download-actions">
                <a [href]="getXmlUrl()" target="_blank" class="btn btn-outline-sm">
                  <i class="fa-solid fa-file-code"></i>
                  Descargar XML
                </a>
                <a [href]="getPdfUrl()" target="_blank" class="btn btn-outline-sm">
                  <i class="fa-solid fa-file-pdf"></i>
                  Descargar PDF
                </a>
                <button class="btn btn-outline-sm" (click)="sendCfdiEmail()" [disabled]="cfdiActionLoading()">
                  <i class="fa-solid fa-envelope"></i>
                  Enviar por Email
                </button>
                <button class="btn btn-outline-sm" (click)="consultarSat()" [disabled]="cfdiActionLoading()">
                  <i class="fa-solid fa-satellite-dish"></i>
                  Consultar SAT
                </button>
              </div>

              @if (satStatus()) {
                <div class="sat-status-card">
                  <h5><i class="fa-solid fa-satellite-dish"></i> Estado SAT</h5>
                  <div class="sat-grid">
                    <div class="sat-item">
                      <span class="sat-label">Estado</span>
                      <span class="sat-value">{{ satStatus()!.estadoSat }}</span>
                    </div>
                    <div class="sat-item">
                      <span class="sat-label">Cancelable</span>
                      <span class="sat-value">{{ satStatus()!.esCancelable }}</span>
                    </div>
                    @if (satStatus()!.estatusCancelacion) {
                      <div class="sat-item">
                        <span class="sat-label">Estatus Cancelación</span>
                        <span class="sat-value">{{ satStatus()!.estatusCancelacion }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>

          <!-- Cancel Form -->
          @if (showCancelForm()) {
            <div class="cfdi-cancel-form">
              <h4>
                <i class="fa-solid fa-exclamation-triangle"></i>
                Cancelar CFDI
              </h4>
              <div class="form-group">
                <label class="form-label">Motivo de Cancelación</label>
                <select
                  class="form-control"
                  [ngModel]="cancelMotivo()"
                  (ngModelChange)="cancelMotivo.set($event)"
                >
                  <option value="">Seleccionar motivo...</option>
                  @for (opt of MOTIVO_CANCELACION_OPTIONS; track opt.value) {
                    <option [value]="opt.value">{{ opt.label }}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Observaciones</label>
                <textarea
                  class="form-control"
                  rows="2"
                  placeholder="Observaciones opcionales..."
                  [ngModel]="cancelObservaciones()"
                  (ngModelChange)="cancelObservaciones.set($event)"
                ></textarea>
              </div>
              <div class="form-actions-row">
                <button class="btn btn-secondary btn-sm" (click)="toggleCancelForm()">
                  Cancelar
                </button>
                <button
                  class="btn btn-danger btn-sm"
                  [disabled]="!cancelMotivo() || cfdiActionLoading()"
                  (click)="cancelarCfdi()"
                >
                  @if (cfdiActionLoading()) {
                    <i class="fa-solid fa-spinner fa-spin"></i>
                  } @else {
                    <i class="fa-solid fa-ban"></i>
                  }
                  Confirmar Cancelación
                </button>
              </div>
            </div>
          }
        } @else {
          <!-- No CFDI yet -->
          <div class="cfdi-empty">
            @if (inv.usoCFDI || inv.metodoPago || inv.formaPago) {
              <div class="info-card">
                @if (inv.usoCFDI) {
                  <div class="info-row">
                    <span class="info-label">Uso CFDI:</span>
                    <span class="info-value">{{ inv.usoCFDI }}</span>
                  </div>
                }
                @if (inv.metodoPago) {
                  <div class="info-row">
                    <span class="info-label">Método de Pago:</span>
                    <span class="info-value">{{ inv.metodoPago }}</span>
                  </div>
                }
                @if (inv.formaPago) {
                  <div class="info-row">
                    <span class="info-label">Forma de Pago:</span>
                    <span class="info-value">{{ inv.formaPago }}</span>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-inline">
                <i class="fa-solid fa-file-signature"></i>
                <p>No se ha generado CFDI para esta factura</p>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
