<div class="detail-container">
  @if (loading()) {
    <div class="loading-state">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Cargando factura...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h2>Error al cargar la factura</h2>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver a Facturas
      </button>
    </div>
  } @else if (invoice(); as inv) {

    <!-- Header -->
    <div class="detail-header">
      <div class="header-top">
        <button (click)="goBack()" class="btn-back">
          <i class="fa-solid fa-arrow-left"></i>
          Volver
        </button>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="printInvoice()">
            <i class="fa-solid fa-print"></i>
            Imprimir
          </button>
        </div>
      </div>

      <div class="header-content">
        <div class="title-section">
          <h1>
            <i class="fa-solid fa-file-invoice-dollar"></i>
            Factura
            @if (inv.serie && inv.folio) {
              <span class="invoice-number">{{ inv.serie }}-{{ inv.folio }}</span>
            }
          </h1>
          <span class="status-badge" [class]="getStatusConfig(inv.status).class">
            <i [class]="'fa-solid ' + getStatusConfig(inv.status).icon"></i>
            {{ getStatusConfig(inv.status).label }}
          </span>
        </div>

        <div class="header-info">
          <div class="info-item">
            <i class="fa-solid fa-user"></i>
            <span class="label">Paciente:</span>
            <span class="value">{{ inv.patientName }}</span>
          </div>
          <div class="info-item">
            <i class="fa-solid fa-calendar"></i>
            <span class="label">Emisión:</span>
            <span class="value">{{ formatDate(inv.issuedAt) }}</span>
          </div>
          @if (inv.lastPaymentDate) {
            <div class="info-item">
              <i class="fa-solid fa-clock"></i>
              <span class="label">Último Pago:</span>
              <span class="value">{{ formatDate(inv.lastPaymentDate) }}</span>
            </div>
          }
        </div>
      </div>
    </div>

    <div class="detail-body">

      <!-- Payment Progress -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-chart-line"></i>
          Progreso de Pago
        </h3>

        <div class="payment-progress">
          <div class="progress-header">
            <span>{{ getPaymentPercentage() | number:'1.0-0' }}% completado</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="getPaymentPercentage()"
              [class.progress-complete]="getPaymentPercentage() >= 100"
            ></div>
          </div>
          <div class="progress-amounts">
            <div class="amount-card">
              <span class="amount-label">Pagado</span>
              <span class="amount-value success">{{ formatCurrency(inv.paidAmount) }}</span>
            </div>
            <div class="amount-card">
              <span class="amount-label">Saldo</span>
              <span class="amount-value warning">{{ formatCurrency(inv.balance) }}</span>
            </div>
            <div class="amount-card">
              <span class="amount-label">Total</span>
              <span class="amount-value primary">{{ formatCurrency(inv.totalAmount) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Invoice Items -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-list-check"></i>
          Items de Factura
          <span class="section-count">{{ inv.items.length }}</span>
        </h3>

        <div class="table-responsive">
          <table class="invoice-table">
            <thead>
              <tr>
                <th class="col-num">#</th>
                <th class="col-desc">Descripción</th>
                <th class="col-qty">Cant.</th>
                <th class="col-price">Precio Unit.</th>
                <th class="col-discount">Descuento</th>
                <th class="col-tax">IVA</th>
                <th class="col-total">Total</th>
              </tr>
            </thead>
            <tbody>
              @for (item of inv.items; track item.id) {
                <tr>
                  <td class="col-num">{{ item.displayOrder }}</td>
                  <td class="col-desc">
                    <div class="item-description">
                      <span class="item-name">{{ item.description }}</span>
                      @if (item.claveProdServ) {
                        <span class="item-sat-key">{{ item.claveProdServ }}</span>
                      }
                    </div>
                  </td>
                  <td class="col-qty">{{ item.quantity }}</td>
                  <td class="col-price">{{ formatCurrency(item.unitPrice) }}</td>
                  <td class="col-discount">
                    @if (item.discountAmount > 0) {
                      <span class="discount-value">-{{ formatCurrency(item.discountAmount) }}</span>
                      <span class="discount-pct">({{ item.discountPercentage }}%)</span>
                    } @else {
                      <span class="no-value">—</span>
                    }
                  </td>
                  <td class="col-tax">
                    <span>{{ formatCurrency(item.taxAmount) }}</span>
                    <span class="tax-pct">({{ item.taxRate }}%)</span>
                  </td>
                  <td class="col-total">
                    <strong>{{ formatCurrency(item.total) }}</strong>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="invoice-totals">
          <div class="totals-row grand-total">
            <span class="totals-label">Total Factura</span>
            <span class="totals-value">{{ formatCurrency(inv.totalAmount) }}</span>
          </div>
        </div>
      </div>

      <!-- Payment History -->
      <div class="info-section">
        <div class="section-header-actions">
          <h3>
            <i class="fa-solid fa-money-bill-wave"></i>
            Historial de Pagos
            @if (payments().length > 0) {
              <span class="section-count">{{ payments().length }}</span>
            }
          </h3>
          @if (canRegisterPayment()) {
            <button class="btn btn-success" (click)="openPaymentModal()">
              <i class="fa-solid fa-plus"></i>
              Registrar Pago
            </button>
          }
        </div>

        @if (loadingPayments()) {
          <div class="loading-inline">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>Cargando pagos...</span>
          </div>
        } @else if (payments().length > 0) {
          <div class="payments-list">
            @for (payment of payments(); track payment.id) {
              <div class="payment-item">
                <div class="payment-icon">
                  <i class="fa-solid fa-money-bill"></i>
                </div>
                <div class="payment-details">
                  <div class="payment-amount">{{ formatCurrency(payment.amount) }}</div>
                  <div class="payment-meta">
                    <span class="payment-method">
                      <i class="fa-solid fa-credit-card"></i>
                      {{ payment.paymentMethod }}
                    </span>
                    @if (payment.reference) {
                      <span class="payment-reference">
                        <i class="fa-solid fa-hashtag"></i>
                        {{ payment.reference }}
                      </span>
                    }
                  </div>
                </div>
                <div class="payment-date">
                  <i class="fa-solid fa-calendar-day"></i>
                  {{ formatDate(payment.paidAt) }}
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-inline">
            <i class="fa-solid fa-receipt"></i>
            <p>No hay pagos registrados</p>
          </div>
        }
      </div>

      <!-- CFDI Info -->
      @if (inv.usoCFDI || inv.metodoPago || inv.formaPago || inv.cfdiUUID) {
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-file-signature"></i>
            Información Fiscal (CFDI)
          </h3>
          <div class="info-card">
            @if (inv.cfdiUUID) {
              <div class="info-row">
                <span class="info-label">UUID:</span>
                <span class="info-value uuid-value">{{ inv.cfdiUUID }}</span>
              </div>
            }
            @if (inv.stampedAt) {
              <div class="info-row">
                <span class="info-label">Fecha de Timbrado:</span>
                <span class="info-value">{{ formatDateTime(inv.stampedAt) }}</span>
              </div>
            }
            @if (inv.usoCFDI) {
              <div class="info-row">
                <span class="info-label">Uso CFDI:</span>
                <span class="info-value">{{ inv.usoCFDI }}</span>
              </div>
            }
            @if (inv.metodoPago) {
              <div class="info-row">
                <span class="info-label">Método de Pago:</span>
                <span class="info-value">{{ inv.metodoPago }}</span>
              </div>
            }
            @if (inv.formaPago) {
              <div class="info-row">
                <span class="info-label">Forma de Pago:</span>
                <span class="info-value">{{ inv.formaPago }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
