<div class="page-container container-medium">
  <!-- Header -->
  <app-page-header
    [title]="'Nueva Factura'"
    [subtitle]="'Crea una nueva factura para un paciente'"
    [icon]="'fa-file-invoice-dollar'"
    [showBackButton]="true"
    [backRoute]="'/invoices'"
    [breadcrumbs]="breadcrumbItems">
    <div actions class="header-form-actions">
      <button type="button" class="btn btn-outline" (click)="onCancel()" [disabled]="loading()">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-outline btn-success" (click)="onSubmit()" [disabled]="loading()">
        @if (loading()) {
          <span class="btn-spinner"></span>
          Guardando...
        } @else {
          <i class="fa-solid fa-plus"></i>
          Crear Factura
        }
      </button>
    </div>
  </app-page-header>

  <div class="content-card">
    <!-- Error Alert -->
    @if (error()) {
      <div class="alert alert-error">
        <i class="fa-solid fa-circle-exclamation alert-icon"></i>
        <span class="alert-message">{{ error() }}</span>
        <button class="alert-close" (click)="error.set(null)">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    }

    <form [formGroup]="form" class="standard-form">
      <!-- Información del Paciente -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-user section-icon"></i>
          Información del Paciente
          <span class="required">*</span>
        </h3>

        <div class="form-group">
          <app-patient-autocomplete
            [selectedPatientId]="selectedPatient()?.id || null"
            [required]="true"
            [disabled]="loading()"
            [error]="getFieldError('patientId')"
            (patientSelected)="onPatientSelected($event)"
          >
            Buscar Paciente
          </app-patient-autocomplete>
        </div>
      </div>

      <!-- Datos Fiscales CFDI -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-file-contract section-icon"></i>
          Datos Fiscales CFDI
          <span class="optional-badge">Opcional</span>
        </h3>
        <p class="section-description">Configuración fiscal para la factura electrónica (CFDI México)</p>

        <div class="form-row">
          <div class="form-group">
            <label for="usoCFDI" class="form-label">Uso de CFDI</label>
            <select id="usoCFDI" formControlName="usoCFDI" class="form-input">
              @for (option of cfdiUsoOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="metodoPago" class="form-label">Método de Pago</label>
            <select id="metodoPago" formControlName="metodoPago" class="form-input">
              @for (option of cfdiMetodoPagoOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="formaPago" class="form-label">Forma de Pago</label>
            <select id="formaPago" formControlName="formaPago" class="form-input">
              @for (option of cfdiFormaPagoOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>
        </div>
      </div>

      <!-- Items de Factura -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="fa-solid fa-list-check section-icon"></i>
            Items de Factura
            <span class="required">*</span>
          </h3>
          <button type="button" class="btn btn-outline btn-sm" (click)="openAddItemModal()">
            <i class="fa-solid fa-plus"></i>
            Agregar Item
          </button>
        </div>

        @if (items.length === 0) {
          <div class="empty-items">
            <i class="fa-solid fa-box-open"></i>
            <p>No hay items en la factura</p>
            <button type="button" class="btn btn-outline btn-sm" (click)="openAddItemModal()">
              <i class="fa-solid fa-plus"></i>
              Agregar primer item
            </button>
          </div>
        } @else {
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Descripción</th>
                  <th>Cant.</th>
                  <th>P. Unitario</th>
                  <th>Desc. %</th>
                  <th>IVA %</th>
                  <th>Total</th>
                  <th class="actions-column">Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (item of items.controls; track $index) {
                  <tr>
                    <td>{{ $index + 1 }}</td>
                    <td>
                      <span class="item-description">{{ item.value.description }}</span>
                      @if (item.value.claveProdServ) {
                        <span class="item-sat-key">{{ item.value.claveProdServ }}</span>
                      }
                    </td>
                    <td>{{ item.value.quantity }}</td>
                    <td class="amount-cell">{{ formatCurrency(item.value.unitPrice) }}</td>
                    <td>{{ item.value.discountPercentage }}%</td>
                    <td>{{ item.value.taxRate }}%</td>
                    <td class="amount-cell">{{ formatCurrency(calculateItemTotal(item)) }}</td>
                    <td class="actions-column">
                      <div class="action-buttons">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline btn-icon"
                          title="Editar item"
                          (click)="openEditItemModal($index)"
                        >
                          <i class="fa-solid fa-pen"></i>
                        </button>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline btn-icon btn-danger"
                          title="Eliminar item"
                          (click)="removeItem($index)"
                        >
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>

      <!-- Invoice Total Summary -->
      <div class="form-section">
        <div class="invoice-summary">
          <div class="summary-row">
            <span class="summary-label">
              <i class="fa-solid fa-calculator"></i>
              Total de la Factura:
            </span>
            <span class="summary-value">{{ formatCurrency(calculateInvoiceTotal()) }}</span>
          </div>
        </div>
      </div>

    </form>
  </div>
</div>

<!-- Item Modal -->
@if (showItemModal()) {
  <app-modal
    [title]="isEditingItem ? 'Editar Item' : 'Agregar Item'"
    [subtitle]="isEditingItem ? 'Modifica los datos del item' : 'Completa los datos del nuevo item'"
    [icon]="'fa-cube'"
    [size]="'lg'"
    (closed)="closeItemModal()">

    <form [formGroup]="itemForm">
      <!-- Selector de Servicio -->
      <div class="form-group">
        <label class="form-label">
          Servicio del Catálogo
          <span class="optional-badge">Auto-fill</span>
        </label>
        <app-service-select
          [disabled]="false"
          (serviceSelected)="onModalServiceSelected($event)"
        ></app-service-select>
        <p class="field-hint">
          <i class="fa-solid fa-circle-info"></i>
          Selecciona un servicio para llenar automáticamente descripción, precio y claves SAT
        </p>
      </div>

      <!-- Descripción -->
      <div class="form-group">
        <label class="form-label">Descripción <span class="required">*</span></label>
        <input
          type="text"
          formControlName="description"
          class="form-input"
          [class.input-error]="isModalFieldInvalid('description')"
          placeholder="Descripción del servicio o producto"
        />
        @if (isModalFieldInvalid('description')) {
          <span class="error-message">La descripción es requerida (mín. 3 caracteres)</span>
        }
      </div>

      <!-- Cantidad + Precio -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Cantidad <span class="required">*</span></label>
          <input
            type="number"
            formControlName="quantity"
            class="form-input"
            [class.input-error]="isModalFieldInvalid('quantity')"
            min="0.01"
            step="0.01"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Precio Unitario <span class="required">*</span></label>
          <input
            type="number"
            formControlName="unitPrice"
            class="form-input"
            [class.input-error]="isModalFieldInvalid('unitPrice')"
            min="0"
            step="0.01"
          />
        </div>
      </div>

      <!-- Descuento + IVA -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Descuento (%)</label>
          <input
            type="number"
            formControlName="discountPercentage"
            class="form-input"
            min="0"
            max="100"
            step="0.01"
          />
        </div>

        <div class="form-group">
          <label class="form-label">IVA (%)</label>
          <input
            type="number"
            formControlName="taxRate"
            class="form-input"
            min="0"
            max="100"
            step="0.01"
          />
        </div>
      </div>

      <!-- Claves SAT -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Clave Prod/Serv (SAT)</label>
          <input type="text" formControlName="claveProdServ" class="form-input" placeholder="85121800" />
        </div>

        <div class="form-group">
          <label class="form-label">Clave Unidad (SAT)</label>
          <input type="text" formControlName="claveUnidad" class="form-input" placeholder="E48" />
        </div>
      </div>

      <!-- Live Total Preview -->
      <div class="modal-item-totals">
        <div class="modal-total-row">
          <span>Subtotal:</span>
          <span class="modal-total-value">{{ formatCurrency(modalItemSubtotal) }}</span>
        </div>
        <div class="modal-total-row">
          <span>Descuento:</span>
          <span class="modal-total-value modal-total-discount">-{{ formatCurrency(modalItemDiscount) }}</span>
        </div>
        <div class="modal-total-row">
          <span>IVA:</span>
          <span class="modal-total-value">{{ formatCurrency(modalItemTax) }}</span>
        </div>
        <div class="modal-total-row modal-total-row-main">
          <span>Total del Item:</span>
          <span class="modal-total-value">{{ formatCurrency(modalItemTotal) }}</span>
        </div>
      </div>
    </form>

    <div modal-footer>
      <button type="button" class="btn btn-outline" (click)="closeItemModal()">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-primary" (click)="confirmItemModal()" [disabled]="itemForm.invalid">
        <i class="fa-solid fa-check"></i>
        {{ isEditingItem ? 'Guardar Cambios' : 'Agregar Item' }}
      </button>
    </div>
  </app-modal>
}
