<div class="page-container container-wide">
  <app-page-header
    [title]="'Recetas'"
    [subtitle]="'Gestión de recetas médicas'"
    [icon]="'fa-prescription'"
    [breadcrumbs]="breadcrumbItems">
  </app-page-header>

  <!-- KPI Cards -->
  @if (!loading() && !error()) {
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon primary">
          <i class="fa-solid fa-prescription"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-value">{{ totalCount() }}</span>
          <span class="kpi-label">Total Recetas</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon success">
          <i class="fa-solid fa-check-circle"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-value">{{ activeCount() }}</span>
          <span class="kpi-label">Activas</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon info">
          <i class="fa-solid fa-prescription-bottle-medical"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-value">{{ completedCount() }}</span>
          <span class="kpi-label">Dispensadas</span>
        </div>
      </div>
    </div>
  }

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <i class="fa-solid fa-search search-icon"></i>
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por paciente, médico, diagnóstico o medicamento..."
        [ngModel]="searchTerm()"
        (ngModelChange)="onSearchChange($event)"
      />
    </div>

    <div class="filter-actions">
      <select
        class="filter-select"
        [ngModel]="statusFilter()"
        (ngModelChange)="onStatusFilterChange($event)"
      >
        <option value="all">Todos los estados</option>
        <option [value]="PrescriptionStatus.Active">Activas</option>
        <option [value]="PrescriptionStatus.Completed">Dispensadas</option>
        <option [value]="PrescriptionStatus.Cancelled">Canceladas</option>
      </select>

      <button class="btn btn-primary" (click)="createPrescription()">
        <i class="fa-solid fa-plus"></i>
        Nueva Receta
      </button>
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando recetas...</p>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="empty-state">
      <i class="fa-solid fa-exclamation-triangle"></i>
      <p>{{ error() }}</p>
      <button class="btn btn-secondary" (click)="loadPrescriptions()">
        <i class="fa-solid fa-arrows-rotate"></i>
        Reintentar
      </button>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && filteredPrescriptions().length === 0 && !(searchTerm() || statusFilter() !== 'all')) {
    <div class="empty-state">
      <i class="fa-solid fa-prescription"></i>
      <h3>No hay recetas registradas</h3>
      <p>Comienza creando la primera receta para un paciente</p>
      <button class="btn btn-primary" (click)="createPrescription()">
        <i class="fa-solid fa-plus"></i>
        Nueva Receta
      </button>
    </div>
  }

  <!-- No Results State -->
  @if (!loading() && !error() && filteredPrescriptions().length === 0 && (searchTerm() || statusFilter() !== 'all')) {
    <div class="empty-state">
      <i class="fa-solid fa-filter-circle-xmark"></i>
      <h3>Sin resultados</h3>
      <p>No se encontraron recetas con los filtros aplicados</p>
    </div>
  }

  <!-- Table -->
  @if (!loading() && !error() && filteredPrescriptions().length > 0) {
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Paciente</th>
            <th>Diagnóstico</th>
            <th>Medicamentos</th>
            <th>Prescrito por</th>
            <th>Vigencia</th>
            <th>Estado</th>
            <th class="actions-column">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (prescription of paginatedPrescriptions(); track prescription.id) {
            <tr [class.expired-row]="isExpired(prescription)">
              <td class="date-cell">
                {{ formatDate(prescription.issuedAt) }}
              </td>
              <td>
                <span class="patient-name">{{ prescription.patientName }}</span>
              </td>
              <td>
                <span class="diagnosis-text">
                  {{ prescription.diagnosis || '—' }}
                </span>
              </td>
              <td>
                <span class="medications-summary">
                  {{ getMedicationsSummary(prescription) }}
                </span>
              </td>
              <td>
                <span class="doctor-name">{{ prescription.prescribedByName }}</span>
              </td>
              <td class="date-cell">
                @if (prescription.expiresAt) {
                  <span [class.text-danger]="isExpired(prescription)">
                    {{ formatDate(prescription.expiresAt) }}
                    @if (isExpired(prescription)) {
                      <i class="fa-solid fa-triangle-exclamation" title="Expirada"></i>
                    }
                  </span>
                } @else {
                  —
                }
              </td>
              <td>
                <span class="badge" [class]="getStatusConfig(prescription.status).class">
                  <i [class]="'fa-solid ' + getStatusConfig(prescription.status).icon"></i>
                  {{ getStatusConfig(prescription.status).label }}
                </span>
              </td>
              <td class="actions-cell">
                <button
                  class="btn-icon"
                  title="Ver detalle"
                  (click)="viewDetail(prescription.id)"
                >
                  <i class="fa-solid fa-eye"></i>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="table-footer">
        <span class="pagination-info">
          Mostrando
          <strong>{{ (currentPage() - 1) * pageSize() + 1 }}</strong> -
          <strong>{{ currentPage() * pageSize() > filteredPrescriptions().length ? filteredPrescriptions().length : currentPage() * pageSize() }}</strong>
          de <strong>{{ filteredPrescriptions().length }}</strong> recetas
        </span>

        @if (totalPages() > 1) {
          <div class="pagination-controls">
            <button
              class="btn-page"
              [disabled]="currentPage() === 1"
              (click)="onPageChange(1)"
            >
              <i class="fa-solid fa-angles-left"></i>
            </button>
            <button
              class="btn-page"
              [disabled]="currentPage() === 1"
              (click)="onPageChange(currentPage() - 1)"
            >
              <i class="fa-solid fa-chevron-left"></i>
            </button>

            @for (page of getPaginationPages(); track page) {
              <button
                class="btn-page"
                [class.active]="page === currentPage()"
                (click)="onPageChange(page)"
              >
                {{ page }}
              </button>
            }

            <button
              class="btn-page"
              [disabled]="currentPage() === totalPages()"
              (click)="onPageChange(currentPage() + 1)"
            >
              <i class="fa-solid fa-chevron-right"></i>
            </button>
            <button
              class="btn-page"
              [disabled]="currentPage() === totalPages()"
              (click)="onPageChange(totalPages())"
            >
              <i class="fa-solid fa-angles-right"></i>
            </button>
          </div>
        }
      </div>
    </div>
  }
</div>
