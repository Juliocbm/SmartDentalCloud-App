<div class="detail-container">
  <app-page-header
    [title]="'Receta Médica'"
    [subtitle]="prescription()?.id?.substring(0, 8)?.toUpperCase() || ''"
    [icon]="'fa-prescription'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems">
    <div title-extra>
      @if (prescription(); as rx) {
        <span class="badge" [ngClass]="getStatusConfig(rx.status).class">
          <i [class]="'fa-solid ' + getStatusConfig(rx.status).icon"></i>
          {{ getStatusConfig(rx.status).label }}
        </span>
        @if (isExpired()) {
          <span class="badge badge-warning">
            <i class="fa-solid fa-triangle-exclamation"></i>
            Expirada
          </span>
        }
      }
    </div>
    <div actions>
      @if (prescription(); as rx) {
        <button class="btn btn-icon" (click)="showAuditModal.set(true)" title="Auditoría">
          <i class="fa-solid fa-clock-rotate-left"></i>
        </button>
        <button class="btn btn-outline" (click)="openEmailModal()">
          <i class="fa-solid fa-envelope"></i>
          Enviar Email
        </button>
        <button class="btn btn-outline" (click)="printPrescription()">
          <i class="fa-solid fa-print"></i>
          Imprimir
        </button>
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando receta...</p>
    </div>
  }

  @if (error()) {
    <div class="empty-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h3>Error al cargar la receta</h3>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </button>
    </div>
  }

  @if (!loading() && !error() && prescription(); as rx) {
    <div class="detail-body">

      <!-- Row 1: Información General + Diagnóstico -->
      <div class="info-two-col">
        <!-- Información General -->
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-info-circle"></i>
            Información General
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Paciente:</span>
              <span class="info-value">
                <a [routerLink]="['/patients', rx.patientId]" class="link-primary">
                  {{ rx.patientName }}
                </a>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Prescrito por:</span>
              <span class="info-value">
                <a [routerLink]="['/users', rx.prescribedById]" class="link-primary">
                  {{ rx.prescribedByName }}
                </a>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Fecha de Emisión:</span>
              <span class="info-value">{{ formatDate(rx.issuedAt) }}</span>
            </div>
            @if (rx.expiresAt) {
              <div class="info-row" [class.alert-row]="isExpired()">
                <span class="info-label">Vigencia:</span>
                <span class="info-value">{{ formatDate(rx.expiresAt) }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Diagnóstico y Notas -->
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-stethoscope"></i>
            Diagnóstico y Notas
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Diagnóstico:</span>
              <span class="info-value">{{ rx.diagnosis || '—' }}</span>
            </div>
            @if (rx.notes) {
              <div class="info-row">
                <span class="info-label">Notas:</span>
                <span class="info-value">{{ rx.notes }}</span>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Medicamentos -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-pills"></i>
          Medicamentos
          <span class="section-count">{{ rx.items.length }}</span>
        </h3>

        @if (rx.items.length > 0) {
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Medicamento</th>
                  <th>Dosis</th>
                  <th>Frecuencia</th>
                  <th>Duración</th>
                  <th>Cantidad</th>
                  <th>Vía</th>
                  <th>Indicaciones</th>
                </tr>
              </thead>
              <tbody>
                @for (item of rx.items; track item.id; let i = $index) {
                  <tr>
                    <td>{{ i + 1 }}</td>
                    <td>
                      <div class="med-name">{{ item.medicationName }}</div>
                      @if (item.activeIngredient) {
                        <div class="med-ingredient">{{ item.activeIngredient }}</div>
                      }
                      @if (item.presentation) {
                        <div class="med-presentation">{{ item.presentation }}</div>
                      }
                    </td>
                    <td>{{ item.dosage }}</td>
                    <td>{{ item.frequency }}</td>
                    <td>{{ item.duration }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.route || '—' }}</td>
                    <td>{{ item.instructions || '—' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="empty-state empty-state-sm">
            <i class="fa-solid fa-pills"></i>
            <h3>Sin medicamentos</h3>
            <p>No hay medicamentos registrados en esta receta</p>
          </div>
        }
      </div>
    </div>

    <app-audit-info
      [visible]="showAuditModal()"
      [createdAt]="rx.issuedAt"
      [createdByName]="rx.prescribedByName"
      (closed)="showAuditModal.set(false)"
    />

    <!-- ========== PRINT-ONLY: Formato Profesional de Receta Médica ========== -->
    <div class="rx-print">
      <!-- Header: Consultorio -->
      <header class="rx-header">
        <div class="rx-header__clinic">
          @if (clinicSettings()?.logoUrl) {
            <img class="rx-header__logo-img" [src]="clinicSettings()!.logoUrl" alt="Logo" />
          } @else {
            <div class="rx-header__logo">
              <i class="fa-solid fa-tooth"></i>
            </div>
          }
          <div class="rx-header__info">
            <h1 class="rx-header__name">{{ clinicSettings()?.name || 'Consultorio Dental' }}</h1>
            @if (clinicSettings()?.legalName) {
              <p class="rx-header__tagline">{{ clinicSettings()!.legalName }}</p>
            }
            @if (clinicSettings()?.taxId) {
              <p class="rx-header__rfc">RFC: {{ clinicSettings()!.taxId }}</p>
            }
          </div>
        </div>
        <div class="rx-header__contact">
          @if (clinicSettings()?.address) {
            <p><i class="fa-solid fa-map-marker-alt"></i> {{ clinicSettings()!.address }}</p>
          }
          @if (clinicSettings()?.phone) {
            <p><i class="fa-solid fa-phone"></i> {{ clinicSettings()!.phone }}</p>
          }
          @if (clinicSettings()?.email) {
            <p><i class="fa-solid fa-envelope"></i> {{ clinicSettings()!.email }}</p>
          }
        </div>
      </header>

      <div class="rx-divider rx-divider--bold"></div>

      <!-- Título del documento -->
      <div class="rx-title">
        <span class="rx-title__symbol">℞</span>
        <h2 class="rx-title__text">Receta Médica</h2>
        <span class="rx-title__folio">Folio: {{ rx.id.substring(0, 8).toUpperCase() }}</span>
      </div>

      <!-- Datos del paciente y doctor -->
      <div class="rx-meta">
        <div class="rx-meta__row">
          <div class="rx-meta__field rx-meta__field--wide">
            <span class="rx-meta__label">Paciente</span>
            <span class="rx-meta__value">{{ rx.patientName }}</span>
          </div>
          <div class="rx-meta__field">
            <span class="rx-meta__label">Fecha de emisión</span>
            <span class="rx-meta__value">{{ formatDate(rx.issuedAt) }}</span>
          </div>
        </div>
        <div class="rx-meta__row">
          <div class="rx-meta__field rx-meta__field--wide">
            <span class="rx-meta__label">Médico</span>
            <span class="rx-meta__value">{{ rx.prescribedByName }}</span>
          </div>
          <div class="rx-meta__field">
            <span class="rx-meta__label">Vigencia</span>
            <span class="rx-meta__value">{{ rx.expiresAt ? formatDate(rx.expiresAt) : '30 días' }}</span>
          </div>
        </div>
      </div>

      <div class="rx-divider"></div>

      <!-- Diagnóstico -->
      @if (rx.diagnosis) {
        <div class="rx-diagnosis">
          <h3 class="rx-section-title">Diagnóstico</h3>
          <p class="rx-diagnosis__text">{{ rx.diagnosis }}</p>
        </div>
      }

      <!-- Medicamentos -->
      <div class="rx-medications">
        <h3 class="rx-section-title">Medicamentos prescritos</h3>

        @for (item of rx.items; track item.id; let i = $index) {
          <div class="rx-med">
            <div class="rx-med__number">{{ i + 1 }}</div>
            <div class="rx-med__content">
              <div class="rx-med__header">
                <span class="rx-med__name">{{ item.medicationName }}</span>
                @if (item.presentation) {
                  <span class="rx-med__presentation">{{ item.presentation }}</span>
                }
              </div>
              @if (item.activeIngredient) {
                <div class="rx-med__ingredient">Principio activo: {{ item.activeIngredient }}</div>
              }
              <div class="rx-med__details">
                <div class="rx-med__detail">
                  <span class="rx-med__detail-label">Dosis:</span>
                  <span>{{ item.dosage }}</span>
                </div>
                <div class="rx-med__detail">
                  <span class="rx-med__detail-label">Frecuencia:</span>
                  <span>{{ item.frequency }}</span>
                </div>
                <div class="rx-med__detail">
                  <span class="rx-med__detail-label">Duración:</span>
                  <span>{{ item.duration }}</span>
                </div>
                @if (item.route) {
                  <div class="rx-med__detail">
                    <span class="rx-med__detail-label">Vía:</span>
                    <span>{{ item.route }}</span>
                  </div>
                }
                <div class="rx-med__detail">
                  <span class="rx-med__detail-label">Cantidad:</span>
                  <span>{{ item.quantity }}</span>
                </div>
              </div>
              @if (item.instructions) {
                <div class="rx-med__instructions">
                  <span class="rx-med__detail-label">Indicaciones:</span>
                  {{ item.instructions }}
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Notas adicionales -->
      @if (rx.notes) {
        <div class="rx-notes">
          <h3 class="rx-section-title">Indicaciones generales</h3>
          <p>{{ rx.notes }}</p>
        </div>
      }

      <!-- Firma del médico -->
      <div class="rx-signature">
        <div class="rx-signature__line"></div>
        <p class="rx-signature__name">{{ rx.prescribedByName }}</p>
        <p class="rx-signature__cedula">Cédula Profesional: {{ rx.prescribedByLicense || '_______________' }}</p>
      </div>

      <!-- Leyendas legales -->
      <footer class="rx-footer">
        <div class="rx-divider"></div>
        <div class="rx-legends">
          <p>Este medicamento es de uso exclusivo del paciente arriba mencionado.</p>
          <p>No se automedique. El uso inadecuado de medicamentos puede poner en riesgo su salud.</p>
          <p>Mantenga todos los medicamentos fuera del alcance de los niños.</p>
          <p>Si los síntomas persisten o se agravan, consulte a su médico.</p>
          <p>Receta válida únicamente durante el periodo de vigencia indicado.</p>
        </div>
        <div class="rx-footer__validity">
          Documento generado el {{ formatDate(rx.issuedAt) }} — Válido hasta {{ rx.expiresAt ? formatDate(rx.expiresAt) : 'N/A' }}
        </div>
      </footer>
    </div>
    <!-- ========== FIN PRINT ========== -->
  }

  <!-- Email Modal -->
  @if (showEmailModal()) {
    <app-send-email-modal
      title="Enviar Receta por Email"
      subtitle="Selecciona a dónde enviar la receta médica:"
      icon="fa-prescription"
      [patientEmail]="patientEmail()"
      [sending]="sendingEmail()"
      (send)="onSendEmail($event)"
      (closed)="closeEmailModal()"
    />
  }
</div>
