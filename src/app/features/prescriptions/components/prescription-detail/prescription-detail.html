<div class="detail-container">
  <app-page-header
    [title]="'Receta Médica'"
    [icon]="'fa-prescription'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems">
    <div actions>
      @if (prescription(); as rx) {
        <span class="badge" [ngClass]="getStatusConfig(rx.status).class">
          <i [class]="'fa-solid ' + getStatusConfig(rx.status).icon"></i>
          {{ getStatusConfig(rx.status).label }}
        </span>
        @if (isExpired()) {
          <span class="badge badge-warning">
            <i class="fa-solid fa-triangle-exclamation"></i>
            Expirada
          </span>
        }
        <button class="btn btn-outline" (click)="printPrescription()">
          <i class="fa-solid fa-print"></i>
          Imprimir
        </button>
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando receta...</p>
    </div>
  }

  @if (error()) {
    <div class="empty-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h3>Error al cargar la receta</h3>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </button>
    </div>
  }

  @if (!loading() && !error() && prescription(); as rx) {
    <div class="detail-body">

      <!-- Row 1: Información General + Diagnóstico -->
      <div class="info-two-col">
        <!-- Información General -->
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-info-circle"></i>
            Información General
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Paciente:</span>
              <span class="info-value">{{ rx.patientName }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Prescrito por:</span>
              <span class="info-value">{{ rx.prescribedByName }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Fecha de Emisión:</span>
              <span class="info-value">{{ formatDate(rx.issuedAt) }}</span>
            </div>
            @if (rx.expiresAt) {
              <div class="info-row" [class.alert-row]="isExpired()">
                <span class="info-label">Vigencia:</span>
                <span class="info-value">{{ formatDate(rx.expiresAt) }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Diagnóstico -->
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-stethoscope"></i>
            Diagnóstico
          </h3>
          <div class="info-card">
            @if (rx.diagnosis) {
              <p class="diagnosis-text">{{ rx.diagnosis }}</p>
            } @else {
              <div class="info-empty">
                <i class="fa-solid fa-circle-info"></i>
                Sin diagnóstico registrado
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Medicamentos -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-pills"></i>
          Medicamentos
          <span class="section-count">{{ rx.items.length }}</span>
        </h3>

        @if (rx.items.length > 0) {
          <div class="medications-grid">
            @for (item of rx.items; track item.id; let i = $index) {
              <div class="medication-card">
                <div class="medication-header">
                  <span class="medication-number">{{ i + 1 }}</span>
                  <div class="medication-title">
                    <h4>{{ item.medicationName }}</h4>
                    @if (item.activeIngredient) {
                      <span class="active-ingredient">{{ item.activeIngredient }}</span>
                    }
                  </div>
                </div>

                <div class="medication-details">
                  <div class="detail-row">
                    <span class="detail-label">
                      <i class="fa-solid fa-syringe"></i>
                      Dosis:
                    </span>
                    <span class="detail-value">{{ item.dosage }}</span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">
                      <i class="fa-solid fa-repeat"></i>
                      Frecuencia:
                    </span>
                    <span class="detail-value">{{ item.frequency }}</span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">
                      <i class="fa-solid fa-calendar-days"></i>
                      Duración:
                    </span>
                    <span class="detail-value">{{ item.duration }}</span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">
                      <i class="fa-solid fa-hashtag"></i>
                      Cantidad:
                    </span>
                    <span class="detail-value">{{ item.quantity }}</span>
                  </div>

                  @if (item.presentation) {
                    <div class="detail-row">
                      <span class="detail-label">
                        <i class="fa-solid fa-box"></i>
                        Presentación:
                      </span>
                      <span class="detail-value">{{ item.presentation }}</span>
                    </div>
                  }

                  @if (item.route) {
                    <div class="detail-row">
                      <span class="detail-label">
                        <i class="fa-solid fa-route"></i>
                        Vía:
                      </span>
                      <span class="detail-value">{{ item.route }}</span>
                    </div>
                  }
                </div>

                @if (item.instructions) {
                  <div class="medication-instructions">
                    <i class="fa-solid fa-circle-info"></i>
                    <span>{{ item.instructions }}</span>
                  </div>
                }
              </div>
            }
          </div>
        } @else {
          <div class="empty-state empty-state-sm">
            <i class="fa-solid fa-pills"></i>
            <h3>Sin medicamentos</h3>
            <p>No hay medicamentos registrados en esta receta</p>
          </div>
        }
      </div>

      <!-- Notas -->
      @if (rx.notes) {
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-note-sticky"></i>
            Notas Adicionales
          </h3>
          <div class="info-card">
            <p>{{ rx.notes }}</p>
          </div>
        </div>
      }
    </div>
  }
</div>
