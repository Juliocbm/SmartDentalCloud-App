<div class="detail-container">
  <app-page-header
    [title]="'Receta Médica'"
    [icon]="'fa-prescription'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems">
    <div actions>
      @if (prescription(); as rx) {
        <span class="badge" [ngClass]="getStatusConfig(rx.status).class">
          <i [class]="'fa-solid ' + getStatusConfig(rx.status).icon"></i>
          {{ getStatusConfig(rx.status).label }}
        </span>
        @if (isExpired()) {
          <span class="badge badge-warning">
            <i class="fa-solid fa-triangle-exclamation"></i>
            Expirada
          </span>
        }
        <button class="btn btn-outline" (click)="printPrescription()">
          <i class="fa-solid fa-print"></i>
          Imprimir
        </button>
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando receta...</p>
    </div>
  }

  @if (error()) {
    <div class="empty-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h3>Error al cargar la receta</h3>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </button>
    </div>
  }

  @if (!loading() && !error() && prescription(); as rx) {
    <div class="detail-body">

      <!-- Row 1: Información General + Diagnóstico -->
      <div class="info-two-col">
        <!-- Información General -->
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-info-circle"></i>
            Información General
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Paciente:</span>
              <span class="info-value">
                <a [routerLink]="['/patients', rx.patientId]" class="link-primary">
                  {{ rx.patientName }}
                </a>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Prescrito por:</span>
              <span class="info-value">
                <a [routerLink]="['/users', rx.prescribedById]" class="link-primary">
                  {{ rx.prescribedByName }}
                </a>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Fecha de Emisión:</span>
              <span class="info-value">{{ formatDate(rx.issuedAt) }}</span>
            </div>
            @if (rx.expiresAt) {
              <div class="info-row" [class.alert-row]="isExpired()">
                <span class="info-label">Vigencia:</span>
                <span class="info-value">{{ formatDate(rx.expiresAt) }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Diagnóstico y Notas -->
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-stethoscope"></i>
            Diagnóstico y Notas
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Diagnóstico:</span>
              <span class="info-value">{{ rx.diagnosis || '—' }}</span>
            </div>
            @if (rx.notes) {
              <div class="info-row">
                <span class="info-label">Notas:</span>
                <span class="info-value">{{ rx.notes }}</span>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Medicamentos -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-pills"></i>
          Medicamentos
          <span class="section-count">{{ rx.items.length }}</span>
        </h3>

        @if (rx.items.length > 0) {
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Medicamento</th>
                  <th>Dosis</th>
                  <th>Frecuencia</th>
                  <th>Duración</th>
                  <th>Cantidad</th>
                  <th>Vía</th>
                  <th>Indicaciones</th>
                </tr>
              </thead>
              <tbody>
                @for (item of rx.items; track item.id; let i = $index) {
                  <tr>
                    <td>{{ i + 1 }}</td>
                    <td>
                      <div class="med-name">{{ item.medicationName }}</div>
                      @if (item.activeIngredient) {
                        <div class="med-ingredient">{{ item.activeIngredient }}</div>
                      }
                      @if (item.presentation) {
                        <div class="med-presentation">{{ item.presentation }}</div>
                      }
                    </td>
                    <td>{{ item.dosage }}</td>
                    <td>{{ item.frequency }}</td>
                    <td>{{ item.duration }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.route || '—' }}</td>
                    <td>{{ item.instructions || '—' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="empty-state empty-state-sm">
            <i class="fa-solid fa-pills"></i>
            <h3>Sin medicamentos</h3>
            <p>No hay medicamentos registrados en esta receta</p>
          </div>
        }
      </div>
    </div>
  }
</div>
