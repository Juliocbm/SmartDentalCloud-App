<div class="page-container container-medium">
  <app-page-header
    title="Nueva Receta Médica"
    subtitle="Crea una receta con medicamentos y dosificación"
    icon="fa-prescription"
    [showBackButton]="true"
    backRoute="/prescriptions"
    [breadcrumbs]="[
      { label: 'Dashboard', route: '/dashboard' },
      { label: 'Recetas', route: '/prescriptions' },
      { label: 'Nueva Receta' }
    ]">
    <div actions class="header-form-actions">
      <button type="button" class="btn btn-outline" (click)="goBack()">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-outline btn-success" (click)="onSubmit()" [disabled]="!isFormValid() || saving()">
        @if (saving()) {
          <span class="btn-spinner"></span>
          Guardando...
        } @else {
          <i class="fa-solid fa-plus"></i>
          Crear Receta
        }
      </button>
    </div>
  </app-page-header>

  <div class="content-card">
    <form class="standard-form">

      <!-- Patient Selection -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-user section-icon"></i>
          Paciente
          <span class="required">*</span>
        </h3>

        <div class="form-group">
          <label class="form-label">Paciente</label>
          @if (selectedPatient(); as patient) {
            <div class="selected-patient">
              <div class="patient-info">
                <i class="fa-solid fa-user-check"></i>
                <span class="patient-name">{{ patient.firstName }} {{ patient.lastName }}</span>
                @if (patient.email) {
                  <span class="patient-email">{{ patient.email }}</span>
                }
              </div>
              <button type="button" class="btn-clear" (click)="clearPatient()">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          } @else {
            <div class="patient-search-wrapper">
              <div class="search-input">
                <i class="fa-solid fa-search"></i>
                <input
                  type="text"
                  placeholder="Buscar paciente por nombre o email..."
                  [ngModel]="patientSearch()"
                  (ngModelChange)="onPatientSearchChange($event)"
                  name="patientSearch"
                  autocomplete="off"
                />
                @if (loadingPatients()) {
                  <i class="fa-solid fa-spinner fa-spin"></i>
                }
              </div>
              @if (showPatientDropdown()) {
                <div class="patient-dropdown">
                  @for (patient of filteredPatients(); track patient.id) {
                    <button
                      type="button"
                      class="dropdown-item"
                      (click)="selectPatient(patient)"
                    >
                      <i class="fa-solid fa-user"></i>
                      <div>
                        <span class="item-name">{{ patient.firstName }} {{ patient.lastName }}</span>
                        @if (patient.email) {
                          <span class="item-email">{{ patient.email }}</span>
                        }
                      </div>
                    </button>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Diagnosis -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-stethoscope section-icon"></i>
          Diagnóstico
          <span class="optional-badge">Opcional</span>
        </h3>

        <div class="form-group">
          <label class="form-label">Diagnóstico</label>
          <textarea
            class="form-input form-textarea"
            placeholder="Diagnóstico del paciente..."
            rows="3"
            [ngModel]="diagnosis()"
            (ngModelChange)="diagnosis.set($event)"
            name="diagnosis"
          ></textarea>
        </div>
      </div>

      <!-- Medications -->
      <div class="form-section">
        <div class="section-header-row">
          <h3 class="section-title">
            <i class="fa-solid fa-pills section-icon"></i>
            Medicamentos
            @if (items().length > 0) {
              <span class="section-count">{{ items().length }}</span>
            }
          </h3>
          <button type="button" class="btn btn-outline btn-sm" (click)="openAddMedModal()">
            <i class="fa-solid fa-plus"></i>
            Agregar
          </button>
        </div>

        @if (items().length === 0) {
          <div class="empty-items">
            <i class="fa-solid fa-pills"></i>
            <p>No hay medicamentos en la receta</p>
            <button type="button" class="btn btn-outline btn-sm" (click)="openAddMedModal()">
              <i class="fa-solid fa-plus"></i>
              Agregar primer medicamento
            </button>
          </div>
        } @else {
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Medicamento</th>
                  <th>Dosis</th>
                  <th>Cant.</th>
                  <th>Frecuencia</th>
                  <th>Duración</th>
                  <th>Vía</th>
                  <th class="actions-column">Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (item of items(); track $index) {
                  <tr>
                    <td>{{ $index + 1 }}</td>
                    <td>
                      <span class="med-name">{{ item.medicationName }}</span>
                      @if (item.presentation) {
                        <span class="med-presentation">{{ item.presentation }}</span>
                      }
                    </td>
                    <td>{{ item.dosage }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.frequency }}</td>
                    <td>{{ item.duration }}</td>
                    <td>{{ item.route }}</td>
                    <td class="actions-column">
                      <div class="action-buttons">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline btn-icon"
                          title="Editar medicamento"
                          (click)="openEditMedModal($index)"
                        >
                          <i class="fa-solid fa-pen"></i>
                        </button>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline btn-icon btn-danger"
                          title="Eliminar medicamento"
                          (click)="removeMed($index)"
                        >
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>

      <!-- Notes -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-note-sticky section-icon"></i>
          Notas Adicionales
          <span class="optional-badge">Opcional</span>
        </h3>

        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea
            class="form-input form-textarea"
            placeholder="Observaciones o indicaciones generales..."
            rows="3"
            [ngModel]="notes()"
            (ngModelChange)="notes.set($event)"
            name="notes"
          ></textarea>
        </div>
      </div>

    </form>
  </div>
</div>

<!-- Medication Modal -->
@if (showMedModal()) {
  <app-modal
    [title]="isEditingMed ? 'Editar Medicamento' : 'Agregar Medicamento'"
    [subtitle]="isEditingMed ? 'Modifica los datos del medicamento' : 'Completa los datos del medicamento'"
    [icon]="'fa-pills'"
    [size]="'lg'"
    (closed)="closeMedModal()">

    <form class="standard-form">
      <!-- Nombre + Principio Activo -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nombre del Medicamento <span class="required">*</span></label>
          <input
            type="text"
            class="form-input"
            placeholder="Ej: Amoxicilina"
            [ngModel]="medForm().medicationName"
            (ngModelChange)="updateMedField('medicationName', $event)"
            name="modal_medicationName"
          />
        </div>
        <div class="form-group">
          <label class="form-label">Principio Activo</label>
          <input
            type="text"
            class="form-input"
            placeholder="Ej: Amoxicilina trihidratada"
            [ngModel]="medForm().activeIngredient"
            (ngModelChange)="updateMedField('activeIngredient', $event)"
            name="modal_activeIngredient"
          />
        </div>
      </div>

      <!-- Presentación + Vía -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Presentación</label>
          <input
            type="text"
            class="form-input"
            placeholder="Ej: Cápsulas 500mg"
            [ngModel]="medForm().presentation"
            (ngModelChange)="updateMedField('presentation', $event)"
            name="modal_presentation"
          />
        </div>
        <div class="form-group">
          <label class="form-label">Vía de Administración</label>
          <select
            class="form-input"
            [ngModel]="medForm().route"
            (ngModelChange)="updateMedField('route', $event)"
            name="modal_route"
          >
            @for (opt of ROUTE_OPTIONS; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
        </div>
      </div>

      <!-- Dosis + Cantidad -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Dosis <span class="required">*</span></label>
          <input
            type="text"
            class="form-input"
            placeholder="Ej: 500mg"
            [ngModel]="medForm().dosage"
            (ngModelChange)="updateMedField('dosage', $event)"
            name="modal_dosage"
          />
        </div>
        <div class="form-group">
          <label class="form-label">Cantidad <span class="required">*</span></label>
          <input
            type="number"
            class="form-input"
            min="1"
            [ngModel]="medForm().quantity"
            (ngModelChange)="updateMedField('quantity', +$event)"
            name="modal_quantity"
          />
        </div>
      </div>

      <!-- Frecuencia + Duración -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Frecuencia <span class="required">*</span></label>
          <select
            class="form-input"
            [ngModel]="medForm().frequency"
            (ngModelChange)="updateMedField('frequency', $event)"
            name="modal_frequency"
          >
            <option value="">Seleccionar...</option>
            @for (opt of FREQUENCY_OPTIONS; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Duración <span class="required">*</span></label>
          <select
            class="form-input"
            [ngModel]="medForm().duration"
            (ngModelChange)="updateMedField('duration', $event)"
            name="modal_duration"
          >
            <option value="">Seleccionar...</option>
            @for (opt of DURATION_OPTIONS; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
        </div>
      </div>

      <!-- Instrucciones Especiales -->
      <div class="form-group">
        <label class="form-label">Instrucciones Especiales</label>
        <textarea
          class="form-input form-textarea"
          placeholder="Ej: Tomar después de los alimentos..."
          rows="2"
          [ngModel]="medForm().instructions"
          (ngModelChange)="updateMedField('instructions', $event)"
          name="modal_instructions"
        ></textarea>
      </div>
    </form>

    <div modal-footer>
      <button type="button" class="btn btn-outline" (click)="closeMedModal()">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-outline btn-success" (click)="confirmMedModal()" [disabled]="!isMedValid(medForm())">
        <i class="fa-solid fa-check"></i>
        {{ isEditingMed ? 'Guardar Cambios' : 'Agregar Medicamento' }}
      </button>
    </div>
  </app-modal>
}
