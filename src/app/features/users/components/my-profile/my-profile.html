<div class="detail-container">
  <app-page-header
    [title]="'Mi Perfil'"
    [subtitle]="currentUser?.email || ''"
    [icon]="'fa-user-circle'"
    [breadcrumbs]="breadcrumbs">
    <div actions>
      @if (editing()) {
        <button class="btn btn-outline" (click)="toggleEdit()" [disabled]="saving()">
          <i class="fa-solid fa-times"></i>
          Cancelar
        </button>
        <button class="btn btn-outline btn-success" [disabled]="saving()" (click)="saveProfile()">
          @if (saving()) {
            <span class="btn-spinner"></span>
            Guardando...
          } @else {
            <i class="fa-solid fa-floppy-disk"></i>
            Guardar Cambios
          }
        </button>
      } @else {
        <a routerLink="/change-password" class="btn btn-outline">
          <i class="fa-solid fa-key"></i>
          Cambiar Contraseña
        </a>
        <button class="btn btn-outline" (click)="toggleEdit()">
          <i class="fa-solid fa-pen"></i>
          Editar Perfil
        </button>
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando perfil...</p>
    </div>
  } @else if (editing()) {
    <!-- Edit Mode -->
    <div class="detail-body">
      <div class="info-section">
        <h3><i class="fa-solid fa-camera"></i> Foto de Perfil</h3>
        <div class="profile-picture-edit">
          <div class="profile-avatar profile-avatar--preview">
            @if (profilePictureUrl()) {
              <img [src]="profilePictureUrl()" alt="Vista previa" />
            } @else {
              <i class="fa-solid fa-user"></i>
            }
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label">URL de la imagen</label>
            <input type="url" class="form-control" placeholder="https://ejemplo.com/foto.jpg"
              [ngModel]="profilePictureUrl()" (ngModelChange)="profilePictureUrl.set($event)" />
            <span class="form-hint">Ingresa la URL de una imagen para tu foto de perfil</span>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3><i class="fa-solid fa-user"></i> Información Personal</h3>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Teléfono</label>
            <input type="tel" class="form-control" placeholder="Número de teléfono"
              [ngModel]="phoneNumber()" (ngModelChange)="phoneNumber.set($event)" />
          </div>
          <div class="form-group">
            <label class="form-label">Email Alternativo</label>
            <input type="email" class="form-control" placeholder="Email alternativo"
              [ngModel]="alternateEmail()" (ngModelChange)="alternateEmail.set($event)" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Dirección</label>
          <input type="text" class="form-control" placeholder="Dirección"
            [ngModel]="address()" (ngModelChange)="address.set($event)" />
        </div>
      </div>

      <div class="info-section">
        <h3><i class="fa-solid fa-stethoscope"></i> Información Profesional</h3>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Especialidad</label>
            <input type="text" class="form-control" placeholder="Ej: Ortodoncia"
              [ngModel]="specialty()" (ngModelChange)="specialty.set($event)" />
          </div>
          <div class="form-group">
            <label class="form-label">Cédula Profesional</label>
            <input type="text" class="form-control" placeholder="Número de cédula"
              [ngModel]="professionalLicense()" (ngModelChange)="professionalLicense.set($event)" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Años de Experiencia</label>
            <input type="number" class="form-control" placeholder="0" min="0"
              [ngModel]="yearsOfExperience()" (ngModelChange)="yearsOfExperience.set($event)" />
          </div>
          <div class="form-group">
            <label class="form-label">Formación Académica</label>
            <input type="text" class="form-control" placeholder="Universidad, posgrado..."
              [ngModel]="education()" (ngModelChange)="education.set($event)" />
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3><i class="fa-solid fa-phone-volume"></i> Contacto de Emergencia</h3>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" placeholder="Nombre del contacto"
              [ngModel]="emergencyContactName()" (ngModelChange)="emergencyContactName.set($event)" />
          </div>
          <div class="form-group">
            <label class="form-label">Teléfono</label>
            <input type="tel" class="form-control" placeholder="Teléfono del contacto"
              [ngModel]="emergencyContactPhone()" (ngModelChange)="emergencyContactPhone.set($event)" />
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3><i class="fa-solid fa-quote-left"></i> Biografía</h3>
        <div class="form-group">
          <textarea class="form-control" rows="4" placeholder="Breve descripción profesional..."
            [ngModel]="bio()" (ngModelChange)="bio.set($event)"></textarea>
        </div>
      </div>
    </div>
  } @else {
    <!-- View Mode -->
    <div class="detail-body">
      @if (profile()?.profilePictureUrl) {
        <div class="info-section profile-picture-section">
          <h3><i class="fa-solid fa-camera"></i> Foto de Perfil</h3>
          <div class="profile-picture-view">
            <div class="profile-avatar profile-avatar--large">
              <img [src]="profile()!.profilePictureUrl" alt="Foto de perfil" />
            </div>
            <div class="profile-picture-name">
              <span class="profile-picture-label">{{ currentUser?.name }}</span>
              @if (currentUser?.roles; as roles) {
                <div class="profile-roles">
                  @for (role of roles; track role) {
                    <span class="badge badge-primary">{{ role }}</span>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      }

      <div class="info-two-col">
        <div class="info-section">
          <h3><i class="fa-solid fa-user"></i> Información Personal</h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ currentUser?.name || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value">{{ currentUser?.email || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Teléfono:</span>
              <span class="info-value">{{ profile()?.phoneNumber || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email Alternativo:</span>
              <span class="info-value">{{ profile()?.alternateEmail || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Dirección:</span>
              <span class="info-value">{{ profile()?.address || '—' }}</span>
            </div>
            @if (currentUser?.roles; as roles) {
              <div class="info-row">
                <span class="info-label">Roles:</span>
                <span class="info-value">
                  @for (role of roles; track role) {
                    <span class="badge badge-primary">{{ role }}</span>
                  }
                </span>
              </div>
            }
          </div>
        </div>

        <div class="info-section">
          <h3><i class="fa-solid fa-stethoscope"></i> Información Profesional</h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Especialidad:</span>
              <span class="info-value">{{ profile()?.specialty || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Cédula Profesional:</span>
              <span class="info-value">{{ profile()?.professionalLicense || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Años de Experiencia:</span>
              <span class="info-value">{{ profile()?.yearsOfExperience || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Formación Académica:</span>
              <span class="info-value">{{ profile()?.education || '—' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="info-two-col">
        <div class="info-section">
          <h3><i class="fa-solid fa-phone-volume"></i> Contacto de Emergencia</h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ profile()?.emergencyContactName || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Teléfono:</span>
              <span class="info-value">{{ profile()?.emergencyContactPhone || '—' }}</span>
            </div>
          </div>
        </div>

        @if (profile()?.bio) {
          <div class="info-section">
            <h3><i class="fa-solid fa-quote-left"></i> Biografía</h3>
            <div class="info-card">
              <p class="bio-text">{{ profile()?.bio }}</p>
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
