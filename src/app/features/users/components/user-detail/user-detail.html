<div class="detail-container">
  <app-page-header
    [title]="user() ? user()!.name : 'Usuario'"
    [icon]="'fa-user-md'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems">
    <div actions>
      @if (user(); as currentUser) {
        <span class="status-badge" [class.badge-active]="currentUser.isActive" [class.badge-inactive]="!currentUser.isActive">
          {{ currentUser.isActive ? 'Activo' : 'Inactivo' }}
        </span>
        <button class="btn btn-icon" (click)="showAuditModal.set(true)" title="Auditoría">
          <i class="fa-solid fa-clock-rotate-left"></i>
        </button>
        <button class="btn btn-outline" (click)="editUser()">
          <i class="fa-solid fa-pen"></i>
          Editar
        </button>
        @if (currentUser.isActive) {
          <button class="btn btn-outline btn-danger" (click)="toggleUserActive()">
            <i class="fa-solid fa-toggle-off"></i>
            Desactivar
          </button>
        } @else {
          <button class="btn btn-outline btn-success" (click)="toggleUserActive()">
            <i class="fa-solid fa-toggle-on"></i>
            Activar
          </button>
        }
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>Cargando usuario...</p>
    </div>
  } @else if (error()) {
    <div class="empty-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h3>Error al cargar el usuario</h3>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </button>
    </div>
  } @else if (user(); as currentUser) {

    <div class="detail-body">
      <!-- User Info: two columns -->
      <div class="info-two-col">
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-user"></i>
            Datos del Usuario
          </h3>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ currentUser.name }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value">{{ currentUser.email }}</span>
            </div>
            @if (currentUser.profile?.phoneNumber) {
              <div class="info-row">
                <span class="info-label">Teléfono:</span>
                <span class="info-value">{{ currentUser.profile?.phoneNumber }}</span>
              </div>
            }
          </div>
        </div>

        <div class="info-section">
          <h3>
            <i class="fa-solid fa-stethoscope"></i>
            Información Profesional
          </h3>
          <div class="info-card">
            @if (currentUser.profile?.specialty) {
              <div class="info-row">
                <span class="info-label">Especialidad:</span>
                <span class="info-value">{{ currentUser.profile?.specialty }}</span>
              </div>
            }
            @if (currentUser.profile?.professionalLicense) {
              <div class="info-row">
                <span class="info-label">Cédula Profesional:</span>
                <span class="info-value">{{ currentUser.profile?.professionalLicense }}</span>
              </div>
            }
            @if (currentUser.profile?.education) {
              <div class="info-row">
                <span class="info-label">Educación:</span>
                <span class="info-value">{{ currentUser.profile?.education }}</span>
              </div>
            }
            @if (currentUser.profile?.yearsOfExperience) {
              <div class="info-row">
                <span class="info-label">Experiencia:</span>
                <span class="info-value">{{ currentUser.profile?.yearsOfExperience }} años</span>
              </div>
            }
            @if (!currentUser.profile?.specialty && !currentUser.profile?.professionalLicense && !currentUser.profile?.education && !currentUser.profile?.yearsOfExperience) {
              <div class="info-empty">
                <i class="fa-solid fa-circle-info"></i>
                Sin información profesional registrada
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Additional info (address, bio) -->
      @if (currentUser.profile?.address || currentUser.profile?.bio) {
        <div class="info-section">
          <h3>
            <i class="fa-solid fa-circle-info"></i>
            Información Adicional
          </h3>
          <div class="info-card">
            @if (currentUser.profile?.address) {
              <div class="info-row">
                <span class="info-label">Dirección:</span>
                <span class="info-value">{{ currentUser.profile?.address }}</span>
              </div>
            }
            @if (currentUser.profile?.bio) {
              <div class="info-row">
                <span class="info-label">Biografía:</span>
                <span class="info-value">{{ currentUser.profile?.bio }}</span>
              </div>
            }
          </div>
        </div>
      }

      <!-- Roles -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-key"></i>
          Roles Asignados
        </h3>
        @if (currentUser.roles.length > 0) {
          <div class="roles-list">
            @for (role of currentUser.roles; track role.id) {
              <div class="role-item">
                <span [class]="'role-badge ' + getRoleBadgeClass(role.name)">
                  {{ role.name }}
                </span>
                @if (role.description) {
                  <span class="role-description">{{ role.description }}</span>
                }
              </div>
            }
          </div>
        } @else {
          <div class="empty-state empty-state-sm">
            <i class="fa-solid fa-key"></i>
            <h3>Sin Roles</h3>
            <p>Este usuario no tiene roles asignados</p>
          </div>
        }
      </div>

      <!-- Permissions -->
      <div class="info-section">
        <h3>
          <i class="fa-solid fa-shield-halved"></i>
          Permisos Efectivos
          @if (currentUser.permissions.length > 0) {
            <span class="permissions-count">{{ currentUser.permissions.length }}</span>
          }
        </h3>
        @if (currentUser.permissions.length > 0) {
          <div class="permissions-grid">
            @for (entry of groupPermissionsByCategory(currentUser.permissions) | keyvalue; track entry.key) {
              <div class="permission-group">
                <h4 class="group-title">{{ entry.key }}</h4>
                <div class="permissions-list">
                  @for (permission of entry.value; track permission) {
                    <span class="permission-item">
                      <i class="fa-solid fa-check"></i>
                      {{ translateAction(permission) }}
                    </span>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-state empty-state-sm">
            <i class="fa-solid fa-shield-halved"></i>
            <h3>Sin Permisos</h3>
            <p>Este usuario no tiene permisos asignados</p>
          </div>
        }
      </div>
    </div>

    <app-audit-info
      [visible]="showAuditModal()"
      [createdAt]="currentUser.createdAt"
      (closed)="showAuditModal.set(false)"
    />
  }
</div>
