<div class="page-container container-medium">
  <!-- Header -->
  <app-page-header
    [title]="isEditMode() ? 'Editar Usuario' : 'Nuevo Usuario'"
    [subtitle]="isEditMode() ? 'Modifica la información del usuario' : 'Registra un nuevo usuario del consultorio'"
    [icon]="isEditMode() ? 'fa-user-pen' : 'fa-user-plus'"
    [showBackButton]="true"
    [backRoute]="'/users'"
    [breadcrumbs]="breadcrumbItems()">
    <!-- Action Buttons -->
    <div actions class="header-form-actions">
      <button
        type="button"
        class="btn btn-outline"
        (click)="cancel()"
        [disabled]="loading()">
        <i class="fa-solid fa-times"></i>
        Cancelar
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="onSubmit()"
        [disabled]="loading() || loadingRoles()">
        @if (loading()) {
          <span class="btn-spinner"></span>
          Guardando...
        } @else {
          <i class="fa-solid" [class.fa-floppy-disk]="isEditMode()" [class.fa-user-plus]="!isEditMode()"></i>
          {{ isEditMode() ? 'Guardar Cambios' : 'Crear Usuario' }}
        }
      </button>
    </div>
  </app-page-header>

  <div class="content-card">
    <!-- Loading State -->
    @if (loading() && isEditMode()) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando usuario...</p>
      </div>
    }

    <!-- Error Alert -->
    @if (error()) {
      <div class="alert alert-danger">
        <i class="fa-solid fa-circle-exclamation alert-icon"></i>
        <span class="alert-message">{{ error() }}</span>
        <button class="alert-close" (click)="error.set(null)">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    }

    <!-- Form -->
    @if (!loading() || !isEditMode()) {
      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-id-card section-icon"></i>
          Información Básica
        </h3>

        <div class="form-row form-row-inline">
          <div class="form-group">
            <label for="name" class="form-label">Nombre Completo <span class="required">*</span></label>
            <input
              id="name"
              type="text"
              formControlName="name"
              class="form-input"
              [class.input-error]="nameControl?.invalid && nameControl?.touched"
              placeholder="Ej: Dr. Juan Pérez"
            />
            @if (nameControl?.invalid && nameControl?.touched) {
              <span class="error-message">
                @if (nameControl?.errors?.['required']) {
                  El nombre es requerido
                }
                @if (nameControl?.errors?.['minlength']) {
                  Mínimo 3 caracteres
                }
              </span>
            }
          </div>

          <div class="form-group">
            <label for="email" class="form-label">Email <span class="required">*</span></label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="form-input"
              [class.input-error]="emailControl?.invalid && emailControl?.touched"
              placeholder="ejemplo@clinica.com"
            />
            @if (emailControl?.invalid && emailControl?.touched) {
              <span class="error-message">
                @if (emailControl?.errors?.['required']) {
                  El email es requerido
                }
                @if (emailControl?.errors?.['email']) {
                  Email inválido
                }
              </span>
            }
          </div>

          <div class="form-group">
            <label for="phoneNumber" class="form-label">Teléfono</label>
            <input
              id="phoneNumber"
              type="tel"
              formControlName="phoneNumber"
              class="form-input"
              placeholder="555-1234"
            />
          </div>

          @if (!isEditMode()) {
            <div class="form-group">
              <label for="password" class="form-label">Contraseña Temporal <span class="required">*</span></label>
              <div class="password-input-wrapper">
                <input
                  id="password"
                  [type]="showPassword() ? 'text' : 'password'"
                  formControlName="password"
                  class="form-input"
                  [class.input-error]="passwordControl?.invalid && passwordControl?.touched"
                  placeholder="Mínimo 8 caracteres"
                />
                <button
                  type="button"
                  class="toggle-password-btn"
                  (click)="togglePasswordVisibility()"
                  tabindex="-1"
                >
                  <i class="fa-solid" [class.fa-eye]="!showPassword()" [class.fa-eye-slash]="showPassword()"></i>
                </button>
              </div>
              @if (passwordControl?.invalid && passwordControl?.touched) {
                <span class="error-message">
                  @if (passwordControl?.errors?.['required']) {
                    La contraseña es requerida
                  }
                  @if (passwordControl?.errors?.['minlength']) {
                    Mínimo 8 caracteres
                  }
                </span>
              }
              <p class="field-hint">
                <i class="fa-solid fa-lightbulb"></i>
                El usuario deberá cambiarla en su primer inicio de sesión
              </p>
            </div>
          }
        </div>
      </div>

      <!-- Roles Section -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fa-solid fa-user-shield section-icon"></i>
          Asignación de Roles
          <span class="required">*</span>
        </h3>
        <p class="section-description">
          Selecciona uno o más roles. Los permisos del usuario serán la unión de todos sus roles.
        </p>

        @if (loadingRoles()) {
          <div class="loading-small">
            <div class="spinner-small"></div>
            <span>Cargando roles...</span>
          </div>
        } @else {
          <div class="roles-grid">
            @for (role of roles(); track role.id) {
              <div
                class="role-card"
                [class.role-selected]="isRoleSelected(role.id)"
                (click)="toggleRole(role.id)"
              >
                <div class="role-card-header">
                  <input
                    type="checkbox"
                    [checked]="isRoleSelected(role.id)"
                    class="role-checkbox"
                    (change)="toggleRole(role.id)"
                    (click)="$event.stopPropagation()"
                  />
                  <i class="fa-solid role-icon" [ngClass]="getRoleIcon(role.name)"></i>
                  <span class="role-name">{{ role.name }}</span>
                  <span 
                    class="role-info-icon"
                    [attr.data-tooltip]="role.description || ''"
                    (click)="$event.stopPropagation()"
                  >i</span>
                </div>
                <div class="role-meta">
                  <span class="role-permissions-count">
                    <i class="fa-solid fa-key"></i>
                    {{ role.permissions.length || 0 }} permisos
                  </span>
                </div>
              </div>
            }
          </div>

       <!--    @if (selectedRoles().size === 0) {
            <p class="warning-message">
              <i class="fa-solid fa-triangle-exclamation"></i>
              Debes seleccionar al menos un rol
            </p>
          } -->
        }
      </div>

      <!-- Professional Profile Section (Only for Doctors) -->
      @if (hasRoleDoctor()) {
        <div class="form-section">
          <h3 class="section-title">
            <i class="fa-solid fa-briefcase section-icon"></i>
            Perfil Profesional
            <span class="optional-badge">Opcional</span>
          </h3>

          <div class="form-row">
            <div class="form-group">
              <label for="specialty" class="form-label">Especialidad</label>
              <input
                id="specialty"
                type="text"
                formControlName="specialty"
                class="form-input"
                placeholder="Ej: Ortodoncia"
              />
            </div>

            <div class="form-group">
              <label for="professionalLicense" class="form-label">Cédula Profesional</label>
              <input
                id="professionalLicense"
                type="text"
                formControlName="professionalLicense"
                class="form-input"
                placeholder="Número de cédula"
              />
            </div>
          </div>
        </div>
      }

      </form>
    }
  </div>
</div>
