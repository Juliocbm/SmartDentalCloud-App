<div class="page-container container-medium with-background">
  <!-- Header -->
  <app-page-header
    [title]="isEditMode() ? 'Editar Rol' : 'Nuevo Rol'"
    [subtitle]="isEditMode() ? 'Modifica el rol y sus permisos' : 'Crea un rol personalizado para tu consultorio'"
    [icon]="isEditMode() ? 'fa-pen' : 'fa-plus'"
    [showBackButton]="true"
    [backRoute]="'/users/roles'"
    [breadcrumbs]="breadcrumbItems()">
  </app-page-header>

  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-danger">
      <i class="fa-solid fa-triangle-exclamation alert-icon"></i>
      <span class="alert-message">{{ error() }}</span>
      <button class="alert-close" (click)="error.set(null)">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  }

  <!-- Form -->
  <form [formGroup]="roleForm" (ngSubmit)="onSubmit()" class="role-form">
    
    <!-- Basic Information Section -->
    <div class="form-section">
      <h2 class="section-title">
        <i class="fa-solid fa-id-card section-icon"></i>
        Información del Rol
      </h2>

      <div class="form-group">
        <label for="name" class="form-label">
          Nombre del Rol <span class="required">*</span>
        </label>
        <input
          id="name"
          type="text"
          formControlName="name"
          class="form-input"
          [class.input-error]="nameControl?.invalid && nameControl?.touched"
          placeholder="Ej: Auxiliar de Ortodoncia"
        />
        @if (nameControl?.invalid && nameControl?.touched) {
          <span class="error-message">
            @if (nameControl?.errors?.['required']) {
              El nombre es requerido
            }
            @if (nameControl?.errors?.['minlength']) {
              Mínimo 3 caracteres
            }
          </span>
        }
        <p class="field-hint">
          <i class="fa-solid fa-lightbulb"></i>
          Elige un nombre descriptivo que refleje la función en el consultorio
        </p>
      </div>

      <div class="form-group">
        <label for="description" class="form-label">
          Descripción
        </label>
        <textarea
          id="description"
          formControlName="description"
          class="form-textarea"
          rows="3"
          placeholder="Ej: Asistente especializado en procedimientos de ortodoncia"
        ></textarea>
        <p class="field-hint">
          Describe brevemente las responsabilidades de este rol
        </p>
      </div>
    </div>

    <!-- Permissions Section -->
    <div class="form-section">
      <h2 class="section-title">
        <i class="fa-solid fa-shield-halved section-icon"></i>
        Permisos del Rol
        <span class="required">*</span>
      </h2>
      <p class="section-description">
        Selecciona los permisos que tendrá este rol. Los usuarios con este rol podrán realizar únicamente las acciones marcadas.
      </p>

      <app-permission-selector
        [selectedPermissions]="selectedPermissions()"
        (permissionsChange)="onPermissionsChange($event)"
      ></app-permission-selector>

      @if (selectedPermissions().length === 0) {
        <p class="warning-message">
          <i class="fa-solid fa-triangle-exclamation"></i>
          Debes seleccionar al menos un permiso
        </p>
      }
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="cancel()"
        [disabled]="loading()"
      >
        Cancelar
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="loading()"
      >
        @if (loading()) {
          <span class="btn-spinner"></span>
          Guardando...
        } @else {
          <i class="fa-solid" [class.fa-floppy-disk]="isEditMode()" [class.fa-plus]="!isEditMode()"></i>
          {{ isEditMode() ? 'Guardar Cambios' : 'Crear Rol' }}
        }
      </button>
    </div>
  </form>
</div>
