<div class="detail-container">
  <app-page-header
    [title]="getTitle()"
    [icon]="'fa-chart-line'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems"
    (backClick)="goBack()">
    <div title-extra>
      @if (periodontogram(); as perio) {
        <span class="badge"
          [ngClass]="PERIO_STATUS_CONFIG[perio.status].cssClass">
          <i [class]="'fa-solid ' + PERIO_STATUS_CONFIG[perio.status].icon"></i>
          {{ PERIO_STATUS_CONFIG[perio.status].label }}
        </span>
      }
    </div>
    <div actions class="header-form-actions">
      @if (formComponent && !formComponent.isReadonly()) {
        @if (formComponent.hasChanges()) {
          <span class="unsaved-indicator">
            <i class="fa-solid fa-circle-exclamation"></i>
            Cambios sin guardar
          </span>
        }
        <button type="button" class="btn btn-outline"
          [disabled]="formComponent.saving() || !formComponent.hasChanges()"
          (click)="formComponent.save()">
          @if (formComponent.saving()) {
            <span class="btn-spinner"></span>
            Guardando...
          } @else {
            <i class="fa-solid fa-floppy-disk"></i>
            Guardar
          }
        </button>
        <button type="button" class="btn btn-outline btn-success"
          [disabled]="formComponent.signing() || !formComponent.canSign()"
          (click)="formComponent.sign()">
          @if (formComponent.signing()) {
            <span class="btn-spinner"></span>
            Firmando...
          } @else {
            <i class="fa-solid fa-file-signature"></i>
            Firmar
          }
        </button>
      } @else if (formComponent?.isReadonly()) {
        <span class="badge badge-success">
          <i class="fa-solid fa-lock"></i>
          Firmado — Solo lectura
        </span>
      }
    </div>
  </app-page-header>

  @if (loading() || creating()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p>{{ creating() ? 'Creando periodontograma...' : 'Cargando periodontograma...' }}</p>
    </div>
  } @else if (error()) {
    <div class="empty-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h2>Error</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-outline" (click)="goBack()">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </button>
    </div>
  } @else if (periodontogram(); as perio) {
    <div class="perio-content">
      <!-- Summary header -->
      <div class="detail-header">
        <div class="header-content">
          <div class="header-info">
            <div class="info-item">
              <i class="fa-solid fa-user"></i>
              <span class="label">Paciente</span>
              <span class="value">{{ perio.patientName }}</span>
            </div>
            <div class="info-item">
              <i class="fa-solid fa-calendar"></i>
              <span class="label">Fecha</span>
              <span class="value">{{ formatDate(perio.examDate) }}</span>
            </div>
            <div class="info-item">
              <i class="fa-solid fa-user-doctor"></i>
              <span class="label">Realizado por</span>
              <span class="value">{{ perio.performedByName }}</span>
            </div>
            @if (perio.periodontalClassification) {
              <div class="info-item">
                <i class="fa-solid fa-stethoscope"></i>
                <span class="label">Clasificación</span>
                <span class="value">
                  {{ perio.periodontalClassification }}
                  @if (perio.grade) { — Grado {{ perio.grade }} }
                </span>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Measurement Form (grid + notes) -->
      <app-periodontogram-form
        [periodontogram]="perio"
        [patientId]="patientId"
        (saved)="onSaved($event)"
        (signed)="onSigned($event)"
        (back)="goBack()"/>
    </div>
  }
</div>
