<div class="perio-chart-wrapper">
  <svg
    class="perio-chart-svg"
    [attr.viewBox]="viewBox"
    xmlns="http://www.w3.org/2000/svg"
    preserveAspectRatio="xMidYMid meet">

    <!-- Midline divider -->
    <line
      [attr.x1]="midlineX" y1="0"
      [attr.x2]="midlineX" [attr.y2]="chartHeight"
      class="midline"/>

    <!-- Tooth shapes -->
    @for (tn of teethOrder; track tn; let i = $index) {
      @if (getToothByNumber(tn); as tooth) {
        <g class="tooth-group"
          [class.tooth-selected]="isSelected(tn)"
          [class.tooth-missing-group]="tooth.isMissing"
          (click)="onToothClick(tn)"
          style="cursor: pointer">

          <!-- Hover hit area -->
          <rect
            [attr.x]="getToothX(i)"
            [attr.y]="toothTopY"
            [attr.width]="36"
            [attr.height]="52"
            fill="transparent"
            class="tooth-hitarea"/>

          <!-- Selection highlight -->
          @if (isSelected(tn)) {
            <rect
              [attr.x]="getToothX(i)"
              [attr.y]="toothTopY - 2"
              [attr.width]="36"
              [attr.height]="56"
              rx="3"
              class="tooth-selection-bg"/>
          }

          <!-- Tooth SVG paths -->
          @if (getToothData(tn); as td) {
            <g [attr.transform]="getToothTransform(i)">
              @for (p of td.paths; track $index) {
                <path
                  [attr.d]="p.d"
                  [attr.fill]="p.role === 's' ? getShadowFill(tooth) : getToothFill(tooth)"
                  [class.absent-path]="tooth.isMissing"/>
              }
            </g>
          }

          <!-- Missing X overlay -->
          @if (tooth.isMissing) {
            <line
              [attr.x1]="getToothX(i) + 6"
              [attr.y1]="toothTopY + 8"
              [attr.x2]="getToothX(i) + 30"
              [attr.y2]="toothTopY + 44"
              class="missing-x"/>
            <line
              [attr.x1]="getToothX(i) + 30"
              [attr.y1]="toothTopY + 8"
              [attr.x2]="getToothX(i) + 6"
              [attr.y2]="toothTopY + 44"
              class="missing-x"/>
          }
        </g>
      }
    }

    <!-- Horizontal grid lines in root area (on top of teeth) -->
    @for (y of getGridLineYs(); track y) {
      <line
        [attr.x1]="0"
        [attr.y1]="y"
        [attr.x2]="chartWidth"
        [attr.y2]="y"
        class="root-grid-line"/>
    }

    <!-- Pocket shading (area between GM and PD) -->
    @if (getPocketPath(); as pocketPath) {
      <path
        [attr.d]="pocketPath"
        class="pocket-shading"/>
    }

    <!-- Gingival margin polyline (red) -->
    @if (getGingivalMarginPath(); as gmPath) {
      <path
        [attr.d]="gmPath"
        class="gingival-margin-line"
        fill="none"/>
    }

    <!-- Probing depth polyline (blue) -->
    @if (getProbingDepthPath(); as pdPath) {
      <path
        [attr.d]="pdPath"
        class="probing-depth-line"
        fill="none"/>
    }

    <!-- Gingival baseline reference -->
    <line
      [attr.x1]="0"
      [attr.y1]="gingivalBaselineY"
      [attr.x2]="chartWidth"
      [attr.y2]="gingivalBaselineY"
      class="cej-baseline"/>

    <!-- BOP dots -->
    @for (dot of getBOPDots(); track $index) {
      <circle
        [attr.cx]="dot.x"
        [attr.cy]="dot.y"
        [attr.r]="dot.suppuration ? 2.5 : 3"
        [class.bop-dot]="!dot.suppuration"
        [class.suppuration-dot]="dot.suppuration"/>
    }

    <!-- Furcation markers -->
    @for (m of getFurcationMarkers(); track $index) {
      <text
        [attr.x]="m.x"
        [attr.y]="m.y"
        text-anchor="middle"
        dominant-baseline="central"
        class="furcation-text"
        [attr.fill]="getFurcationColor(m.grade)">
        {{ getFurcationSymbol(m.grade) }}
      </text>
    }

    <!-- Mobility labels -->
    @for (m of getMobilityLabels(); track $index) {
      <text
        [attr.x]="m.x"
        [attr.y]="m.y"
        text-anchor="middle"
        class="mobility-text"
        [attr.fill]="getMobilityColor(m.value)">
        {{ m.value }}
      </text>
    }

  </svg>
</div>
