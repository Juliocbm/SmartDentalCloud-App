<div class="page-container container-wide">
  <!-- Header -->
  <app-page-header
    [title]="'Pacientes'"
    [subtitle]="'Gestión de pacientes del consultorio'"
    [icon]="'fa-users'"
    [breadcrumbs]="breadcrumbItems">
    <div actions>
      <button class="btn btn-primary" routerLink="/patients/new">
        <i class="fa-solid fa-plus"></i>
        Nuevo Paciente
      </button>
    </div>
  </app-page-header>

  <!-- Filters and Search -->
  <div class="filters-section">
    <div class="search-box">
      <i class="fa-solid fa-search search-icon"></i>
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por nombre, email o teléfono..."
        [value]="searchTerm()"
        (input)="onSearchChange($any($event.target).value)"
      />
    </div>

    <div class="filter-actions">
      <select
        class="filter-select"
        [value]="filterStatus()"
        (change)="onStatusFilterChange($any($event.target).value)"
      >
        <option value="all">Todos los estados</option>
        <option value="active">Activos</option>
        <option value="inactive">Inactivos</option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Cargando pacientes...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="loadPatients()">Reintentar</button>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && patients().length === 0) {
    <div class="empty-state">
      <i class="fa-solid fa-user-plus"></i>
      <h3>No hay pacientes registrados</h3>
      <p>Comienza agregando tu primer paciente</p>
      <button class="btn btn-primary" routerLink="/patients/new">
        <i class="fa-solid fa-plus"></i>
        Crear Primer Paciente
      </button>
    </div>
  }

  <!-- Patients Table -->
  @if (!loading() && !error() && patients().length > 0) {
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Paciente</th>
          <th>Contacto</th>
          <th>Edad</th>
          <th>Última Visita</th>
          <th>Estado</th>
          <th>Indicadores</th>
          <th class="actions-column">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (patient of patients(); track patient.id) {
        <tr [class.row-inactive]="!patient.isActive">
          <!-- Paciente -->
          <td>
            <div class="info-cell">
              <div class="avatar avatar-primary">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="info-content">
                <div class="info-title">{{ getFullName(patient) }}</div>
                <div class="info-subtitle">#{{ patient.id.substring(0, 8) }}</div>
              </div>
            </div>
          </td>

          <!-- Contacto -->
          <td class="contact-info">
            @if (patient.phoneNumber) {
              <div class="contact-item">
                <i class="fa-solid fa-phone"></i>
                {{ patient.phoneNumber }}
              </div>
            }
            @if (patient.email) {
              <div class="contact-item">
                <i class="fa-solid fa-envelope"></i>
                {{ patient.email }}
              </div>
            }
            @if (!patient.phoneNumber && !patient.email) {
              <div class="contact-empty">
                <span class="text-muted">Sin contacto</span>
              </div>
            }
          </td>

          <!-- Edad -->
          <td class="age-info">
            {{ getAge(patient) }}
          </td>

          <!-- Última Visita -->
          <td class="last-visit">
            {{ formatDate(patient.updatedAt) }}
          </td>

          <!-- Estado -->
          <td class="status-column">
            <span class="badge" [class.badge-success]="patient.isActive" [class.badge-inactive]="!patient.isActive">
              <i class="fa-solid" [class.fa-circle-check]="patient.isActive" [class.fa-circle-xmark]="!patient.isActive"></i>
              {{ patient.isActive ? 'Activo' : 'Inactivo' }}
            </span>
          </td>

          <!-- Indicadores -->
          <td class="indicators">
            <div class="indicator-badges">
              @if (hasAllergies(patient)) {
                <span class="badge badge-icon badge-warning" title="Tiene alergias registradas">
                  <i class="fa-solid fa-exclamation-triangle"></i>
                </span>
              }
              @if (hasMedicalHistory(patient)) {
                <span class="badge badge-icon badge-info" title="Tiene historia médica">
                  <i class="fa-solid fa-heartbeat"></i>
                </span>
              }
            </div>
          </td>

          <!-- Acciones -->
          <td class="actions-column">
            <div class="action-buttons">
              <button 
                class="btn btn-sm btn-outline" 
                [routerLink]="['/patients', patient.id]"
              >
                <i class="fa-solid fa-eye"></i>
                Ver
              </button>
              <button 
                class="btn btn-sm btn-outline" 
                [routerLink]="['/patients', patient.id, 'edit']"
              >
                <i class="fa-solid fa-pen"></i>
                Editar
              </button>
              <button 
                class="btn btn-sm btn-outline"
                [class.btn-warning]="patient.isActive"
                [class.btn-success]="!patient.isActive"
                (click)="toggleActive(patient)"
              >
                <i class="fa-solid" [class.fa-toggle-on]="patient.isActive" [class.fa-toggle-off]="!patient.isActive"></i>
                {{ patient.isActive ? 'Desactivar' : 'Activar' }}
              </button>
              <button 
                class="btn btn-sm btn-outline btn-danger" 
                (click)="deletePatient(patient)"
              >
                <i class="fa-solid fa-trash"></i>
                Eliminar
              </button>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>

    <!-- Table Footer -->
    <div class="table-footer">
      <span class="pagination-info">
        Mostrando <strong>{{ (currentPage() - 1) * pageSize() + 1 }} - 
        {{ Math.min(currentPage() * pageSize(), totalItems()) }}</strong> de <strong>{{ totalItems() }}</strong> pacientes
      </span>

      <div class="pagination-controls">
        <button 
          class="btn-page" 
          (click)="onPageChange(currentPage() - 1)"
          [disabled]="currentPage() === 1"
        >
          <i class="fa-solid fa-chevron-left"></i>
        </button>

        @for (page of getPaginationPages(); track page) {
          <button 
            class="btn-page"
            [class.active]="page === currentPage()"
            (click)="onPageChange(page)"
          >
            {{ page }}
          </button>
        }

        <button 
          class="btn-page" 
          (click)="onPageChange(currentPage() + 1)"
          [disabled]="currentPage() === totalPages()"
        >
          <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
  }
</div>
