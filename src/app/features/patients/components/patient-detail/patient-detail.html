<div class="detail-container">
  <app-page-header
    [title]="patient() ? (patient()!.firstName + ' ' + patient()!.lastName) : 'Paciente'"
    [icon]="'fa-user'"
    [showBackButton]="true"
    [breadcrumbs]="breadcrumbItems">
    <div actions>
      @if (patient(); as pat) {
        <button class="btn btn-outline" (click)="editPatient()">
          <i class="fa-solid fa-pen"></i>
          Editar
        </button>
        @if (pat.isActive) {
          <button class="btn btn-warning" (click)="toggleActive()">
            <i class="fa-solid fa-toggle-off"></i>
            Desactivar
          </button>
        } @else {
          <button class="btn btn-success" (click)="toggleActive()">
            <i class="fa-solid fa-toggle-on"></i>
            Activar
          </button>
        }
      }
    </div>
  </app-page-header>

  @if (loading()) {
    <div class="loading-state">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Cargando información del paciente...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <h2>Error al cargar el paciente</h2>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </button>
    </div>
  } @else if (patient(); as pat) {

    <!-- Header Info -->
    <div class="detail-header">

      <div class="header-content">
        <div class="title-section">
          <h1>
            <i class="fa-solid fa-user"></i>
            {{ getFullName() }}
          </h1>
          <span class="status-badge" [class.badge-active]="pat.isActive" [class.badge-inactive]="!pat.isActive">
            {{ pat.isActive ? 'Activo' : 'Inactivo' }}
          </span>
        </div>
        <div class="header-info">
          <div class="info-item">
            <i class="fa-solid fa-calendar"></i>
            <span class="label">Edad:</span>
            <span class="value">{{ getAge() }}</span>
          </div>
          <div class="info-item">
            <i class="fa-solid fa-clock"></i>
            <span class="label">Registrado:</span>
            <span class="value">{{ formatDate(pat.createdAt) }}</span>
          </div>
          @if (pat.phoneNumber) {
            <div class="info-item">
              <i class="fa-solid fa-phone"></i>
              <span class="label">Teléfono:</span>
              <span class="value">{{ pat.phoneNumber }}</span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button 
          class="tab-button" 
          [class.active]="activeTab() === 'info'"
          (click)="setActiveTab('info')"
        >
          <i class="fa-solid fa-user"></i>
          Información General
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab() === 'medical'"
          (click)="setActiveTab('medical')"
        >
          <i class="fa-solid fa-heartbeat"></i>
          Historia Médica
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab() === 'odontogram'"
          (click)="setActiveTab('odontogram')"
        >
          <i class="fa-solid fa-tooth"></i>
          Odontograma
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab() === 'fiscal'"
          (click)="setActiveTab('fiscal')"
        >
          <i class="fa-solid fa-file-invoice"></i>
          Datos Fiscales
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab() === 'financial'"
          (click)="setActiveTab('financial')"
        >
          <i class="fa-solid fa-wallet"></i>
          Resumen Financiero
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab() === 'history'"
          (click)="setActiveTab('history')"
        >
          <i class="fa-solid fa-clock-rotate-left"></i>
          Historial
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab() === 'files'"
          (click)="setActiveTab('files')"
        >
          <i class="fa-solid fa-paperclip"></i>
          Archivos
          @if (files().length > 0) {
            <span class="tab-count">{{ files().length }}</span>
          }
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Info Tab -->
        @if (activeTab() === 'info') {
        <div class="tab-panel">
          <div class="info-grid">
            <!-- Datos Personales Card -->
            <div class="info-card">
              <h3 class="card-title">
                <i class="fa-solid fa-user"></i>
                Datos Personales
              </h3>
              <div class="card-content">
                <div class="info-row">
                  <span class="info-label">Nombre Completo:</span>
                  <span class="info-value">{{ getFullName() }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Fecha de Nacimiento:</span>
                  <span class="info-value">{{ formatDate(patient()!.dateOfBirth) }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Edad:</span>
                  <span class="info-value">{{ getAge() }}</span>
                </div>
                @if (patient()!.gender) {
                  <div class="info-row">
                    <span class="info-label">Género:</span>
                    <span class="info-value">{{ patient()!.gender }}</span>
                  </div>
                }
              </div>
            </div>

            <!-- Datos de Contacto Card -->
            <div class="info-card">
              <h3 class="card-title">
                <i class="fa-solid fa-address-book"></i>
                Información de Contacto
              </h3>
              <div class="card-content">
                @if (patient()!.phoneNumber) {
                  <div class="info-row">
                    <span class="info-label">
                      <i class="fa-solid fa-phone"></i>
                      Teléfono:
                    </span>
                    <span class="info-value">{{ patient()!.phoneNumber }}</span>
                  </div>
                }
                @if (patient()!.email) {
                  <div class="info-row">
                    <span class="info-label">
                      <i class="fa-solid fa-envelope"></i>
                      Email:
                    </span>
                    <span class="info-value">{{ patient()!.email }}</span>
                  </div>
                }
                @if (patient()!.address) {
                  <div class="info-row">
                    <span class="info-label">
                      <i class="fa-solid fa-location-dot"></i>
                      Dirección:
                    </span>
                    <span class="info-value">{{ patient()!.address }}</span>
                  </div>
                }
                @if (!patient()!.phoneNumber && !patient()!.email && !patient()!.address) {
                  <div class="info-empty">
                    <i class="fa-solid fa-circle-info"></i>
                    Sin información de contacto registrada
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Medical Tab -->
        @if (activeTab() === 'medical') {
        <div class="tab-panel">
          <!-- Allergies Alert -->
          @if (hasAllergies()) {
          <div class="medical-alert">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <div>
              <strong>⚠️ ALERGIAS</strong>
              <p>{{ patient()!.allergies }}</p>
            </div>
          </div>
          }

          <div class="medical-grid">
            <!-- Blood Type -->
            @if (patient()!.bloodType) {
            <div class="info-card">
              <h3 class="card-title">
                <i class="fa-solid fa-droplet"></i>
                Tipo de Sangre
              </h3>
              <div class="card-content">
                <div class="blood-type-badge">{{ patient()!.bloodType }}</div>
              </div>
            </div>
            }

            <!-- Chronic Diseases -->
            @if (patient()!.chronicDiseases) {
            <div class="info-card">
              <h3 class="card-title">
                <i class="fa-solid fa-notes-medical"></i>
                Enfermedades Crónicas
              </h3>
              <div class="card-content">
                <p>{{ patient()!.chronicDiseases }}</p>
              </div>
            </div>
            }

            <!-- Current Medications -->
            @if (patient()!.currentMedications) {
            <div class="info-card">
              <h3 class="card-title">
                <i class="fa-solid fa-pills"></i>
                Medicamentos Actuales
              </h3>
              <div class="card-content">
                <p>{{ patient()!.currentMedications }}</p>
              </div>
            </div>
            }

            <!-- Smoking Status -->
            @if (patient()!.smokingStatus) {
            <div class="info-card">
              <h3 class="card-title">
                <i class="fa-solid fa-smoking"></i>
                Estado Fumador
              </h3>
              <div class="card-content">
                <p>{{ patient()!.smokingStatus }}</p>
              </div>
            </div>
            }

            <!-- Notes -->
            @if (patient()!.notes) {
            <div class="info-card full-width">
              <h3 class="card-title">
                <i class="fa-solid fa-file-lines"></i>
                Notas Médicas
              </h3>
              <div class="card-content">
                <p>{{ patient()!.notes }}</p>
              </div>
            </div>
            }
          </div>

          <!-- Empty State -->
          @if (!hasMedicalHistory()) {
          <div class="empty-medical">
            <i class="fa-solid fa-heartbeat"></i>
            <h3>Sin Historia Médica</h3>
            <p>Este paciente no tiene información médica registrada</p>
            <button class="btn btn-primary" (click)="editPatient()">
              <i class="fa-solid fa-plus"></i>
              Agregar Historia Médica
            </button>
          </div>
          }
        </div>
        }
        <!-- Odontogram Tab -->
        @if (activeTab() === 'odontogram') {
        <div class="tab-panel">
          <app-odontogram
            [patientId]="patient()!.id"
            [patientName]="getFullName()"
          />
        </div>
        }

        <!-- Fiscal Tab -->
        @if (activeTab() === 'fiscal') {
        <div class="tab-panel">
          <div class="fiscal-header">
            <h3>
              <i class="fa-solid fa-file-invoice"></i>
              Datos Fiscales
            </h3>
            <button class="btn btn-outline btn-sm" (click)="toggleEditTax()">
              @if (editingTax()) {
                <i class="fa-solid fa-xmark"></i> Cancelar
              } @else {
                <i class="fa-solid fa-pen"></i> Editar
              }
            </button>
          </div>

          @if (editingTax()) {
            <div class="fiscal-form">
              <div class="form-group">
                <label class="form-label">RFC <span class="required">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="XAXX010101000"
                  [ngModel]="taxId()"
                  (ngModelChange)="taxId.set($event)"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Razón Social <span class="required">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Nombre o razón social"
                  [ngModel]="legalName()"
                  (ngModelChange)="legalName.set($event)"
                />
              </div>
              <div class="form-group full-width">
                <label class="form-label">Domicilio Fiscal <span class="required">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Calle, Colonia, CP, Ciudad, Estado"
                  [ngModel]="fiscalAddress()"
                  (ngModelChange)="fiscalAddress.set($event)"
                />
                <span class="form-hint">Incluye el código postal al final separado por coma para CFDI</span>
              </div>
              <div class="form-actions-right">
                <button
                  class="btn btn-primary btn-sm"
                  [disabled]="savingTax() || !taxId().trim() || !legalName().trim()"
                  (click)="saveTaxInfo()"
                >
                  @if (savingTax()) {
                    <i class="fa-solid fa-spinner fa-spin"></i>
                  } @else {
                    <i class="fa-solid fa-save"></i>
                  }
                  Guardar
                </button>
              </div>
            </div>
          } @else {
            @if (taxId()) {
              <div class="fiscal-info">
                <div class="info-row">
                  <span class="info-label">RFC</span>
                  <span class="info-value mono">{{ taxId() }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Razón Social</span>
                  <span class="info-value">{{ legalName() }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Domicilio Fiscal</span>
                  <span class="info-value">{{ fiscalAddress() || '—' }}</span>
                </div>
              </div>
            } @else {
              <div class="empty-fiscal">
                <i class="fa-solid fa-file-invoice"></i>
                <h3>Sin Datos Fiscales</h3>
                <p>Este paciente no tiene información fiscal registrada. Es necesaria para generar CFDI.</p>
                <button class="btn btn-primary" (click)="toggleEditTax()">
                  <i class="fa-solid fa-plus"></i>
                  Agregar Datos Fiscales
                </button>
              </div>
            }
          }
        </div>
        }

        <!-- Financial Tab -->
        @if (activeTab() === 'financial') {
        <div class="tab-panel">
          @if (financialLoading()) {
            <div class="inline-loading">
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>Cargando resumen financiero...</span>
            </div>
          } @else if (financialSummary(); as fin) {
            <div class="financial-kpis">
              <div class="kpi-card success">
                <span class="kpi-label">Total Facturado</span>
                <span class="kpi-value">{{ formatCurrency(fin.totalBilled) }}</span>
              </div>
              <div class="kpi-card primary">
                <span class="kpi-label">Total Pagado</span>
                <span class="kpi-value">{{ formatCurrency(fin.totalPaid) }}</span>
              </div>
              <div class="kpi-card warning">
                <span class="kpi-label">Saldo Pendiente</span>
                <span class="kpi-value">{{ formatCurrency(fin.pendingBalance) }}</span>
              </div>
            </div>

            @if (fin.lastPaymentDate) {
              <p class="last-payment">Último pago: {{ formatDateShort(fin.lastPaymentDate) }}</p>
            }

            @if (fin.pendingInvoices && fin.pendingInvoices.length > 0) {
              <div class="financial-section">
                <h4><i class="fa-solid fa-file-invoice-dollar"></i> Facturas Pendientes</h4>
                <table class="mini-table">
                  <thead>
                    <tr>
                      <th>Factura</th>
                      <th>Fecha</th>
                      <th>Total</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (inv of fin.pendingInvoices; track inv.id) {
                      <tr>
                        <td>
                          <a [routerLink]="['/invoices', inv.id]" class="link-primary">{{ inv.invoiceNumber || 'Sin folio' }}</a>
                        </td>
                        <td>{{ formatDateShort(inv.date) }}</td>
                        <td class="amount">{{ formatCurrency(inv.total) }}</td>
                        <td><span class="badge badge-warning">{{ inv.status }}</span></td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }

            @if (fin.recentPayments && fin.recentPayments.length > 0) {
              <div class="financial-section">
                <h4><i class="fa-solid fa-money-bill-wave"></i> Pagos Recientes</h4>
                <table class="mini-table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Monto</th>
                      <th>Método</th>
                      <th>Referencia</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (pay of fin.recentPayments; track pay.id) {
                      <tr>
                        <td>{{ formatDateShort(pay.paymentDate) }}</td>
                        <td class="amount success">{{ formatCurrency(pay.amount) }}</td>
                        <td>{{ pay.paymentMethod }}</td>
                        <td>{{ pay.reference || '—' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          } @else {
            <div class="empty-financial">
              <i class="fa-solid fa-wallet"></i>
              <h3>Sin información financiera</h3>
              <p>No se encontró resumen financiero para este paciente</p>
            </div>
          }
        </div>
        }

        <!-- History Tab -->
        @if (activeTab() === 'history') {
        <div class="tab-panel">
          @if (historyLoading()) {
            <div class="inline-loading">
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>Cargando historial...</span>
            </div>
          } @else if (patientHistory(); as hist) {
            <!-- Appointments -->
            @if (hist.appointments && hist.appointments.length > 0) {
              <div class="history-section">
                <h4><i class="fa-solid fa-calendar-check"></i> Citas ({{ hist.appointments.length }})</h4>
                <div class="timeline">
                  @for (apt of hist.appointments; track apt.id) {
                    <div class="timeline-item">
                      <div class="timeline-dot" [class]="'dot-' + apt.status.toLowerCase()"></div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <span class="timeline-date">{{ formatDateShort(apt.date) }}</span>
                          <span class="badge badge-sm" [class.badge-success]="apt.status === 'Completed'" [class.badge-warning]="apt.status === 'Scheduled'" [class.badge-neutral]="apt.status !== 'Completed' && apt.status !== 'Scheduled'">{{ apt.status }}</span>
                        </div>
                        <p class="timeline-text">{{ apt.reason }} — Dr. {{ apt.doctorName }}</p>
                        @if (apt.notes) {
                          <p class="timeline-notes">{{ apt.notes }}</p>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Treatments -->
            @if (hist.treatments && hist.treatments.length > 0) {
              <div class="history-section">
                <h4><i class="fa-solid fa-tooth"></i> Tratamientos ({{ hist.treatments.length }})</h4>
                <div class="timeline">
                  @for (tx of hist.treatments; track tx.id) {
                    <div class="timeline-item">
                      <div class="timeline-dot" [class]="'dot-' + tx.status.toLowerCase()"></div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <span class="timeline-date">{{ formatDateShort(tx.startDate) }}</span>
                          <span class="badge badge-sm" [class.badge-success]="tx.status === 'Completed'" [class.badge-info]="tx.status === 'InProgress'" [class.badge-neutral]="tx.status !== 'Completed' && tx.status !== 'InProgress'">{{ tx.status }}</span>
                        </div>
                        <p class="timeline-text">
                          <a [routerLink]="['/treatments', tx.id]" class="link-primary">{{ tx.serviceName }}</a>
                          @if (tx.toothNumber) { — Diente {{ tx.toothNumber }} }
                        </p>
                        @if (tx.notes) {
                          <p class="timeline-notes">{{ tx.notes }}</p>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Invoices -->
            @if (hist.invoices && hist.invoices.length > 0) {
              <div class="history-section">
                <h4><i class="fa-solid fa-file-invoice-dollar"></i> Facturas ({{ hist.invoices.length }})</h4>
                <table class="mini-table">
                  <thead>
                    <tr>
                      <th>Folio</th>
                      <th>Fecha</th>
                      <th>Total</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (inv of hist.invoices; track inv.id) {
                      <tr>
                        <td><a [routerLink]="['/invoices', inv.id]" class="link-primary">{{ inv.invoiceNumber || 'Sin folio' }}</a></td>
                        <td>{{ formatDateShort(inv.date) }}</td>
                        <td class="amount">{{ formatCurrency(inv.total) }}</td>
                        <td><span class="badge badge-sm" [class.badge-success]="inv.status === 'Paid'" [class.badge-warning]="inv.status === 'Pending'" [class.badge-neutral]="inv.status !== 'Paid' && inv.status !== 'Pending'">{{ inv.status }}</span></td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }

            @if ((!hist.appointments || hist.appointments.length === 0) && (!hist.treatments || hist.treatments.length === 0) && (!hist.invoices || hist.invoices.length === 0)) {
              <div class="empty-history">
                <i class="fa-solid fa-clock-rotate-left"></i>
                <h3>Sin Historial</h3>
                <p>Este paciente aún no tiene interacciones registradas</p>
              </div>
            }
          } @else {
            <div class="empty-history">
              <i class="fa-solid fa-clock-rotate-left"></i>
              <h3>Sin Historial</h3>
              <p>No se pudo cargar el historial del paciente</p>
            </div>
          }
        </div>
        }

        <!-- Files Tab -->
        @if (activeTab() === 'files') {
        <div class="tab-panel">
          <div class="files-header">
            <h3>
              <i class="fa-solid fa-paperclip"></i>
              Archivos Adjuntos
            </h3>
            <button
              type="button"
              class="btn btn-outline btn-sm"
              (click)="toggleUploadForm()"
            >
              @if (showUploadForm()) {
                <i class="fa-solid fa-xmark"></i>
                Cancelar
              } @else {
                <i class="fa-solid fa-upload"></i>
                Subir Archivo
              }
            </button>
          </div>

          <!-- Upload Form -->
          @if (showUploadForm()) {
            <div class="upload-form">
              <div class="form-group">
                <label class="form-label">Archivo</label>
                <input
                  type="file"
                  class="form-control-file"
                  (change)="onFileSelected($event)"
                  accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                />
                @if (selectedFile()) {
                  <span class="file-selected">
                    <i class="fa-solid fa-check"></i>
                    {{ selectedFile()!.name }} ({{ formatFileSize(selectedFile()!.size) }})
                  </span>
                }
              </div>
              <div class="form-row-2">
                <div class="form-group">
                  <label class="form-label">Categoría</label>
                  <select
                    class="form-control"
                    [ngModel]="uploadCategory()"
                    (ngModelChange)="uploadCategory.set($event)"
                  >
                    <option value="">Sin categoría</option>
                    @for (cat of FILE_CATEGORIES; track cat.value) {
                      <option [value]="cat.value">{{ cat.label }}</option>
                    }
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Descripción</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Descripción del archivo..."
                    [ngModel]="uploadDescription()"
                    (ngModelChange)="uploadDescription.set($event)"
                  />
                </div>
              </div>
              <div class="form-actions-right">
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  [disabled]="!selectedFile() || uploading()"
                  (click)="uploadFile()"
                >
                  @if (uploading()) {
                    <i class="fa-solid fa-spinner fa-spin"></i>
                    Subiendo...
                  } @else {
                    <i class="fa-solid fa-upload"></i>
                    Subir
                  }
                </button>
              </div>
            </div>
          }

          <!-- Loading -->
          @if (filesLoading()) {
            <div class="inline-loading">
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>Cargando archivos...</span>
            </div>
          }

          <!-- Files List -->
          @if (!filesLoading() && files().length > 0) {
            <div class="files-grid">
              @for (file of files(); track file.id) {
                <div class="file-card">
                  <div class="file-icon">
                    <i [class]="'fa-solid ' + getFileIcon(file.fileType)"></i>
                  </div>
                  <div class="file-info">
                    <a [href]="file.fileUrl" target="_blank" class="file-name">
                      {{ file.fileName }}
                    </a>
                    <div class="file-meta">
                      @if (file.category) {
                        <span class="file-category">{{ file.category }}</span>
                      }
                      <span class="file-size">{{ formatFileSize(file.fileSize) }}</span>
                      <span class="file-date">{{ formatDateFile(file.createdAt) }}</span>
                    </div>
                    @if (file.description) {
                      <p class="file-description">{{ file.description }}</p>
                    }
                  </div>
                  <button
                    class="btn-icon-sm"
                    title="Eliminar archivo"
                    (click)="deleteFile(file.id)"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
              }
            </div>
          }

          <!-- Empty -->
          @if (!filesLoading() && files().length === 0 && !showUploadForm()) {
            <div class="empty-files">
              <i class="fa-solid fa-folder-open"></i>
              <h3>Sin Archivos</h3>
              <p>Este paciente no tiene archivos adjuntos</p>
              <button class="btn btn-primary" (click)="toggleUploadForm()">
                <i class="fa-solid fa-upload"></i>
                Subir Primer Archivo
              </button>
            </div>
          }
        </div>
        }
      </div>
    </div>
  }
</div>
