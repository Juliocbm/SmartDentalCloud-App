<aside class="sidebar" [class.sidebar--collapsed]="collapsed()">
  <!-- Header -->
  <div class="sidebar__header">
    <div class="sidebar__logo">
      <i class="fa-solid fa-tooth"></i>
      @if (!collapsed()) {
        <span class="sidebar__logo-text">SmartDental</span>
      }
    </div>
    <button 
      class="sidebar__toggle" 
      (click)="toggleSidebar()" 
      [title]="collapsed() ? 'Expandir' : 'Colapsar'">
      <i class="fa-solid" [class.fa-angles-left]="!collapsed()" [class.fa-angles-right]="collapsed()"></i>
    </button>
  </div>

  <!-- Buscador -->
  @if (!collapsed()) {
    <div class="sidebar__search">
      <i class="fa-solid fa-search sidebar__search-icon"></i>
      <input 
        type="text" 
        class="sidebar__search-input"
        placeholder="Buscar menú..."
        [ngModel]="searchTerm()"
        (ngModelChange)="onSearchChange($event)"
      />
      @if (hasSearchTerm()) {
        <button class="sidebar__search-clear" (click)="clearSearch()" title="Limpiar">
          <i class="fa-solid fa-times"></i>
        </button>
      }
    </div>
  } @else {
    <button class="sidebar__search-icon-only" title="Buscar">
      <i class="fa-solid fa-search"></i>
    </button>
  }

  <!-- Navegación -->
  <nav class="sidebar__nav">
    <!-- Favoritos -->
    @if (favoriteMenuItems().length > 0) {
      <div class="sidebar__favorites-section">
        @if (!collapsed()) {
          <div class="sidebar__section-title">
            <i class="fa-solid fa-star"></i>
            <span>Favoritos</span>
          </div>
        } @else {
          <div class="sidebar__section-divider" title="Favoritos">
            <i class="fa-solid fa-star"></i>
          </div>
        }
        @for (fav of favoriteMenuItems(); track fav.id) {
          <a 
            [routerLink]="fav.route" 
            routerLinkActive="sidebar__menu-item--active"
            class="sidebar__menu-item sidebar__menu-item--favorite"
            [title]="collapsed() ? fav.label : ''">
            <i [class]="fav.icon" class="sidebar__menu-icon"></i>
            @if (!collapsed()) {
              <span class="sidebar__menu-label">{{ fav.label }}</span>
              <button class="sidebar__fav-btn sidebar__fav-btn--active" 
                      (click)="toggleFavorite(fav.id, $event)" 
                      title="Quitar de favoritos">
                <i class="fa-solid fa-star"></i>
              </button>
            }
          </a>
        }
        @if (!collapsed()) {
          <div class="sidebar__section-separator"></div>
        }
      </div>
    }

    @for (item of filteredMenuItems(); track item.id) {
      @if (hasChildren(item)) {
        <!-- Menú con hijos -->
        <div class="sidebar__menu-group" [class.sidebar__menu-group--expanded]="isExpanded(item.id)">
          <!-- Botón para expandir/colapsar -->
          <button 
            class="sidebar__menu-item sidebar__menu-item--parent"
            [class.sidebar__menu-item--active]="isExpanded(item.id)"
            (click)="toggleMenu(item.id, $event)"
            [title]="collapsed() ? item.label : ''">
            <i [class]="item.icon" class="sidebar__menu-icon"></i>
            @if (!collapsed()) {
              <span class="sidebar__menu-label">{{ item.label }}</span>
              <i class="fa-solid fa-chevron-down sidebar__chevron" 
                 [class.sidebar__chevron--expanded]="isExpanded(item.id)"></i>
            }
          </button>

          <!-- Link al dashboard del módulo (solo expandido) -->
          @if (!collapsed() && isExpanded(item.id)) {
            <div class="sidebar__submenu">
              <!-- Link al dashboard principal (solo si el módulo tiene dashboard) -->
              @if (item.hasDashboard) {
                <a 
                  [routerLink]="item.route" 
                  routerLinkActive="sidebar__submenu-item--active"
                  [routerLinkActiveOptions]="{exact: true}"
                  class="sidebar__submenu-item sidebar__submenu-item--dashboard"
                  [title]="'Dashboard de ' + item.label">
                  <i class="fa-solid fa-gauge-high sidebar__submenu-icon"></i>
                  <span class="sidebar__submenu-label">Dashboard</span>
                </a>
              }
              <!-- Hijos -->
              @for (child of item.children; track child.id) {
                <a 
                  [routerLink]="child.route" 
                  routerLinkActive="sidebar__submenu-item--active"
                  [routerLinkActiveOptions]="{exact: true}"
                  class="sidebar__submenu-item"
                  [title]="child.label">
                  <i [class]="child.icon" class="sidebar__submenu-icon"></i>
                  <span class="sidebar__submenu-label">{{ child.label }}</span>
                  @if (child.badge !== undefined && child.badge > 0) {
                    <span class="sidebar__badge sidebar__badge--warning">{{ child.badge }}</span>
                  }
                  <button class="sidebar__fav-btn" 
                          [class.sidebar__fav-btn--active]="isFavorite(child.id)"
                          (click)="toggleFavorite(child.id, $event)" 
                          [title]="isFavorite(child.id) ? 'Quitar de favoritos' : 'Agregar a favoritos'">
                    <i class="fa-solid fa-star"></i>
                  </button>
                </a>
              }
            </div>
          }
        </div>
      } @else {
        <!-- Menú simple -->
        <a 
          [routerLink]="item.route" 
          routerLinkActive="sidebar__menu-item--active"
          class="sidebar__menu-item"
          [title]="collapsed() ? item.label : ''">
          <i [class]="item.icon" class="sidebar__menu-icon"></i>
          @if (!collapsed()) {
            <span class="sidebar__menu-label">{{ item.label }}</span>
            @if (item.badge) {
              <span class="sidebar__badge sidebar__badge--primary">{{ item.badge }}</span>
            }
            <button class="sidebar__fav-btn" 
                    [class.sidebar__fav-btn--active]="isFavorite(item.id)"
                    (click)="toggleFavorite(item.id, $event)" 
                    [title]="isFavorite(item.id) ? 'Quitar de favoritos' : 'Agregar a favoritos'">
              <i class="fa-solid fa-star"></i>
            </button>
          }
        </a>
      }
    }

    <!-- Mensaje de resultados de búsqueda -->
    @if (hasSearchTerm() && !collapsed()) {
      <div class="sidebar__search-results">
        <i class="fa-solid fa-info-circle"></i>
        <span>{{ searchResultsCount() }} resultado{{ searchResultsCount() === 1 ? '' : 's' }}</span>
      </div>
    }
  </nav>

  <!-- Footer -->
  <div class="sidebar__footer">
    <div class="sidebar__user" [title]="collapsed() ? sidebarUserName() + ' - ' + sidebarUserRole() : ''">
      <div class="sidebar__user-avatar">
        @if (profilePictureUrl()) {
          <img [src]="profilePictureUrl()" alt="Avatar" />
        } @else {
          <i class="fa-solid fa-user"></i>
        }
      </div>
      @if (!collapsed()) {
        <div class="sidebar__user-info">
          <div class="sidebar__user-name">{{ sidebarUserName() }}</div>
          <div class="sidebar__user-role">{{ sidebarUserRole() }}</div>
        </div>
      }
    </div>
  </div>
</aside>
